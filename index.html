<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I Expanse Tracker</title>
    
    <!-- Favicon (Custom SVG Logo) -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M30,50 C30,27.9 47.9,10 70,10 C92.1,10 110,27.9 110,50 C110,72.1 92.1,90 70,90 C55,90 42.5,81.1 35.4,68.6 M70,50 C70,72.1 52.1,90 30,90 C7.9,90 -10,72.1 -10,50 C-10,27.9 7.9,10 30,10 C45,10 57.5,18.9 64.6,31.4' stroke='%234f46e5' stroke-width='12' fill='none' stroke-linecap='round'/%3E%3C/svg%3E">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- SweetAlert2 for beautiful modals -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #a8a29e; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #78716c; }
        
        /* Page transition animations */
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Side navigation slide animation */
        #side-nav { transition: transform 0.3s ease-in-out; }
        
        /* Loading spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 antialiased">

    <!-- Global Loading Spinner -->
    <div id="global-loader" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="loader"></div>
    </div>

    <!-- Auth Screen (Login/Signup) -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4 bg-gray-50 dark:bg-gray-900">
        <div class="w-full max-w-md bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 transition-all">
            <div class="text-center mb-8">
                <div class="w-16 h-16 mx-auto mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M30,50 C30,27.9 47.9,10 70,10 C92.1,10 110,27.9 110,50 C110,72.1 92.1,90 70,90 C55,90 42.5,81.1 35.4,68.6 M70,50 C70,72.1 52.1,90 30,90 C7.9,90 -10,72.1 -10,50 C-10,27.9 7.9,10 30,10 C45,10 57.5,18.9 64.6,31.4" stroke="#4f46e5" stroke-width="10" fill="none" stroke-linecap="round"/></svg>
                </div>
                <h1 class="text-3xl font-extrabold text-gray-800 dark:text-white">I Expanse Tracker</h1>
                <p class="text-gray-500 dark:text-gray-400 mt-1">Your Personal Finance Companion</p>
            </div>

            <!-- Auth Forms Container -->
            <div id="auth-forms">
                <!-- Login Form -->
                <div id="login-form">
                    <h2 class="text-2xl font-bold text-center mb-6">Welcome Back</h2>
                    <form id="login-form-fields">
                        <div class="mb-4">
                            <label for="login-email" class="block mb-2 text-sm font-medium text-gray-600 dark:text-gray-300">Email</label>
                            <input type="email" id="login-email" class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" required placeholder="you@example.com">
                        </div>
                        <div class="mb-6">
                            <label for="login-password" class="block mb-2 text-sm font-medium text-gray-600 dark:text-gray-300">Password</label>
                            <input type="password" id="login-password" class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" required placeholder="••••••••">
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg hover:shadow-xl">Log In</button>
                    </form>
                    <p class="text-center text-sm mt-6">
                        Don't have an account? <a href="#" id="show-signup" class="font-semibold text-indigo-500 hover:underline">Sign up</a>
                    </p>
                </div>

                <!-- Signup Form (hidden by default) -->
                <div id="signup-form" class="hidden">
                    <h2 class="text-2xl font-bold text-center mb-6">Create an Account</h2>
                    <form id="signup-form-fields">
                         <div class="mb-4">
                            <label for="signup-name" class="block mb-2 text-sm font-medium text-gray-600 dark:text-gray-300">Full Name</label>
                            <input type="text" id="signup-name" class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" required placeholder="John Doe">
                        </div>
                        <div class="mb-4">
                            <label for="signup-username" class="block mb-2 text-sm font-medium text-gray-600 dark:text-gray-300">Username</label>
                            <input type="text" id="signup-username" class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" required placeholder="johndoe">
                        </div>
                        <div class="mb-4">
                            <label for="signup-email" class="block mb-2 text-sm font-medium text-gray-600 dark:text-gray-300">Email</label>
                            <input type="email" id="signup-email" class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" required placeholder="you@example.com">
                        </div>
                        <div class="mb-6">
                            <label for="signup-password" class="block mb-2 text-sm font-medium text-gray-600 dark:text-gray-300">Password</label>
                            <input type="password" id="signup-password" class="w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" required placeholder="Minimum 6 characters">
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg hover:shadow-xl">Sign Up</button>
                    </form>
                    <p class="text-center text-sm mt-6">
                        Already have an account? <a href="#" id="show-login" class="font-semibold text-indigo-500 hover:underline">Log in</a>
                    </p>
                </div>
                
                <div class="relative flex py-5 items-center">
                    <div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div>
                    <span class="flex-shrink mx-4 text-gray-400 dark:text-gray-500 font-semibold">OR</span>
                    <div class="flex-grow border-t border-gray-300 dark:border-gray-600"></div>
                </div>

                <button id="google-signin-btn" class="w-full flex items-center justify-center bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 font-semibold py-3 px-4 rounded-lg transition duration-300 shadow-sm">
                    <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48"><defs><path id="a" d="M44.5 20H24v8.5h11.8C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 11.8 2 2 11.8 2 24s9.8 22 22 22c11 0 21-8 21-22 0-1.3-.2-2.7-.5-4z"/></defs><clipPath id="b"><use xlink:href="#a" overflow="visible"/></clipPath><path clip-path="url(#b)" fill="#FBBC05" d="M0 37V11l17 13z"/><path clip-path="url(#b)" fill="#EA4335" d="M0 11l17 13 7-6.1L48 14V0H0z"/><path clip-path="url(#b)" fill="#34A853" d="M0 37l30-23 7.9 5.8L48 37H0z"/><path clip-path="url(#b)" fill="#4285F4" d="M48 37L30 14l-7-5.8L0 11v26z"/></svg>
                    Continue with Google
                </button>
            </div>
        </div>
    </div>

    <!-- Main App Container (hidden by default) -->
    <div id="app-container" class="hidden">
        <!-- Sliding Navigation Menu -->
        <div id="side-nav-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-30 hidden lg:hidden"></div>
        <aside id="side-nav" class="fixed top-0 left-0 h-full w-64 bg-white dark:bg-gray-800 shadow-xl z-40 transform -translate-x-full lg:translate-x-0">
            <div class="p-5 border-b border-gray-200 dark:border-gray-700 flex items-center space-x-3">
                <div class="w-10 h-10">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M30,50 C30,27.9 47.9,10 70,10 C92.1,10 110,27.9 110,50 C110,72.1 92.1,90 70,90 C55,90 42.5,81.1 35.4,68.6 M70,50 C70,72.1 52.1,90 30,90 C7.9,90 -10,72.1 -10,50 C-10,27.9 7.9,10 30,10 C45,10 57.5,18.9 64.6,31.4" stroke="#4f46e5" stroke-width="10" fill="none" stroke-linecap="round"/></svg>
                </div>
                <h2 class="text-xl font-extrabold text-gray-800 dark:text-white">I Expanse</h2>
            </div>
            <nav class="mt-6 flex-1">
                <a href="#dashboard" class="nav-link flex items-center px-5 py-3 text-gray-600 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-gray-700 font-semibold border-l-4 border-transparent">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                    Dashboard
                </a>
                <a href="#transactions" class="nav-link flex items-center px-5 py-3 text-gray-600 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-gray-700 font-semibold border-l-4 border-transparent">
                     <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg>
                    Transactions
                </a>
                <a href="#reports" class="nav-link flex items-center px-5 py-3 text-gray-600 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-gray-700 font-semibold border-l-4 border-transparent">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V7a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Reports
                </a>
                <a href="#categories" class="nav-link flex items-center px-5 py-3 text-gray-600 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-gray-700 font-semibold border-l-4 border-transparent">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                    Categories
                </a>
                 <a href="#developer" class="nav-link flex items-center px-5 py-3 text-gray-600 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-gray-700 font-semibold border-l-4 border-transparent">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                    Developer
                </a>
                <a href="#profile" class="nav-link flex items-center px-5 py-3 text-gray-600 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-gray-700 font-semibold border-l-4 border-transparent">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    Profile
                </a>
            </nav>
            <div class="absolute bottom-0 left-0 w-full p-4 border-t border-gray-200 dark:border-gray-700">
                <button id="logout-btn" class="w-full flex items-center justify-center bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="lg:ml-64 flex-1 flex flex-col min-h-screen">
            <!-- Header -->
            <header class="bg-white dark:bg-gray-800 shadow-sm p-4 flex justify-between items-center sticky top-0 z-20">
                <button id="menu-toggle-btn" class="text-gray-800 dark:text-gray-200 lg:hidden">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <h1 id="page-title" class="text-2xl font-bold text-gray-800 dark:text-white">Dashboard</h1>
                <div class="flex items-center space-x-4">
                    <span id="header-user-name" class="hidden sm:block font-semibold"></span>
                    <img id="header-user-pic" src="https://placehold.co/40x40/E2E8F0/4A5568?text=P" class="w-10 h-10 rounded-full object-cover border-2 border-indigo-200" alt="User Profile">
                </div>
            </header>

            <!-- Pages Container -->
            <main class="flex-1 p-4 md:p-6 lg:p-8 overflow-y-auto">
                
                <!-- Dashboard Page -->
                <div id="dashboard" class="page">
                    <!-- Stat Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border-l-4 border-green-500">
                            <h3 class="text-lg font-semibold text-gray-500 dark:text-gray-400">Total Income</h3>
                            <p id="total-income" class="text-4xl font-extrabold text-green-500 mt-2">৳0.00</p>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border-l-4 border-red-500">
                            <h3 class="text-lg font-semibold text-gray-500 dark:text-gray-400">Total Expense</h3>
                            <p id="total-expense" class="text-4xl font-extrabold text-red-500 mt-2">৳0.00</p>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border-l-4 border-indigo-500">
                            <h3 class="text-lg font-semibold text-gray-500 dark:text-gray-400">Current Balance</h3>
                            <p id="current-balance" class="text-4xl font-extrabold text-indigo-500 mt-2">৳0.00</p>
                        </div>
                    </div>
                    
                    <!-- Charts and Recent Transactions -->
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-6">
                        <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">Expense by Category</h3>
                            <div id="expense-chart-container" class="relative h-64">
                                <canvas id="expense-chart"></canvas>
                            </div>
                        </div>
                        <div class="lg:col-span-3 bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-bold mb-4">Recent Transactions</h3>
                            <div id="recent-transactions-list" class="space-y-4 max-h-80 overflow-y-auto pr-2">
                                <!-- Recent transactions will be injected here -->
                                <p class="text-gray-500">No transactions yet.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transactions Page -->
                <div id="transactions" class="page">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                            <h2 class="text-3xl font-bold">All Transactions</h2>
                            <div class="flex items-center space-x-2 w-full md:w-auto">
                                <input type="text" id="search-transactions" placeholder="Search by name..." class="w-full md:w-auto px-4 py-2 bg-gray-100 dark:bg-gray-700 border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <select id="filter-type" class="px-4 py-2 bg-gray-100 dark:bg-gray-700 border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="all">All Types</option>
                                    <option value="income">Income</option>
                                    <option value="expense">Expense</option>
                                </select>
                            </div>
                        </div>
                        <div id="transactions-list-full" class="space-y-3 max-h-[65vh] overflow-y-auto pr-2">
                            <!-- Full transaction list will be injected here -->
                        </div>
                    </div>
                </div>

                <!-- Reports Page -->
                <div id="reports" class="page">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
                        <h2 class="text-3xl font-bold mb-6">Generate Report</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                            <div>
                                <label for="start-date" class="block text-sm font-medium mb-2">Start Date</label>
                                <input type="date" id="start-date" class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label for="end-date" class="block text-sm font-medium mb-2">End Date</label>
                                <input type="date" id="end-date" class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <button id="generate-pdf-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">Generate PDF</button>
                        </div>
                    </div>
                </div>

                <!-- Categories Page -->
                <div id="categories" class="page">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-3xl font-bold">Manage Categories</h2>
                            <button id="add-category-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                <span>Add Category</span>
                            </button>
                        </div>
                        <div id="categories-list" class="space-y-3">
                           <!-- Categories will be injected here -->
                        </div>
                    </div>
                </div>
                
                <!-- Developer Page -->
                <div id="developer" class="page">
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-lg max-w-2xl mx-auto">
                        <div class="text-center">
                            <img src="https://i.ibb.co/6gS3Jz9/Picsart-24-12-22-22-58-18-749.png" alt="Developer Picture" class="w-36 h-36 rounded-full mx-auto mb-4 border-4 border-indigo-400 shadow-lg" onerror="this.onerror=null;this.src='https://placehold.co/150x150/6366f1/FFFFFF?text=HRM';">
                            <h2 class="text-4xl font-extrabold">Md Habibur Rahman Mahi</h2>
                            <p class="text-xl text-indigo-500 font-semibold mt-1">Founder & CEO of Infinity Group</p>
                            <p class="text-gray-500 dark:text-gray-400 mt-4 max-w-md mx-auto">A passionate developer dedicated to creating useful and beautiful applications that solve real-world problems.</p>
                        </div>
                        <div class="mt-8 border-t border-gray-200 dark:border-gray-700 pt-8">
                            <h3 class="text-2xl font-bold text-center mb-6">Connect with me</h3>
                            <div class="flex justify-center items-center space-x-6">
                                <a href="https://wa.me/8801727722018" target="_blank" class="text-gray-500 hover:text-green-500 transition-colors" title="WhatsApp">
                                    <svg class="w-8 h-8" role="img" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12.04 2.02c-5.46 0-9.9 4.44-9.9 9.9 0 1.75.46 3.45 1.32 4.95L2.05 22l5.25-1.38c1.45.77 3.05 1.18 4.74 1.18h.01c5.46 0 9.9-4.44 9.9-9.9s-4.44-9.9-9.9-9.9zM12.04 20.15c-1.5 0-2.96-.4-4.22-1.13l-.3-.18-3.12.82.83-3.04-.2-.31c-.8-1.3-1.2-2.8-1.2-4.4 0-4.5 3.6-8.1 8.1-8.1 2.2 0 4.2.8 5.7 2.3 1.5 1.5 2.3 3.5 2.3 5.7.1 4.5-3.5 8.1-8 8.1zm4.5-6.2c-.2-.1-1.5-.8-1.7-.8-.2 0-.4.1-.6.4s-.7.8-.8.9c-.2.1-.3.2-.6.1s-1.1-.4-2.1-1.3c-.8-.7-1.3-1.6-1.5-1.8-.2-.3 0-.4.1-.5.1-.1.2-.2.4-.4.1-.1.2-.2.2-.4.1-.2 0-.4-.1-.5s-.6-1.5-.8-2.1c-.2-.5-.4-.5-.6-.5h-.5c-.2 0-.5.2-.6.5-.2.2-.7.7-.7 1.6s.7 1.9.8 2c.1.2 1.5 2.3 3.6 3.2.5.2.8.3 1.1.4.5.1.8.1 1.1.1.3-.1.9-.4 1.1-.8.2-.3.2-.6.1-.7s-.2-.2-.4-.3z"/></svg>
                                </a>
                                <a href="https://t.me/hr_mahi" target="_blank" class="text-gray-500 hover:text-sky-500 transition-colors" title="Telegram">
                                     <svg class="w-8 h-8" role="img" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.17.91-.494 1.202-.82 1.23-.696.06-1.225-.46-1.9-.902-1.018-.66-1.59-1.075-2.599-1.72-1.135-.733-.394-1.146.254-1.833.19-.21.34-.383.51-.57.69-.75 1.37-1.51 1.44-1.62.11-.15.01-.33-.09-.43-.11-.1-.28-.07-.42-.04-.18.04-1.21.78-3.38 2.35a2.21 2.21 0 0 1-1.08.38c-.45.02-1.03-.15-1.53-.45-.6-.35-1.05-.53-1 .51-.03-.02 1.57-1.97 3.9-3.86 1.06-.86 1.88-1.39 2.4-1.55.7-.2 1.2-.24 1.6-.24z"/></svg>
                                </a>
                                <a href="https://www.instagram.com/h.r_mahi_?igsh=Z242dWFtcDZwdjF2" target="_blank" class="text-gray-500 hover:text-pink-500 transition-colors" title="Instagram">
                                    <svg class="w-8 h-8" role="img" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 0C8.74 0 8.333.015 7.053.072 5.775.132 4.905.333 4.14.63c-.784.305-1.455.717-2.126 1.387C1.344 2.69 1.033 3.36.73 4.144.333 4.905.132 5.775.072 7.053.012 8.333 0 8.74 0 12s.015 3.667.072 4.947c.06 1.277.26 2.148.558 2.913.306.783.718 1.455 1.387 2.126.67.67 1.344 1.067 2.126 1.372.765.296 1.636.497 2.913.558C8.333 23.988 8.74 24 12 24s3.667-.015 4.947-.072c1.277-.06 2.148-.262 2.913-.558.783-.305 1.455-.718 2.126-1.387.67-.67 1.067-1.344 1.372-2.126.296-.765.497-1.636.558-2.913.06-1.28.072-1.687.072-4.947s-.015-3.667-.072-4.947c-.06-1.277-.262-2.148-.558-2.913-.305-.784-.718-1.455-1.372-2.126C21.344 1.344 20.67 1.033 19.896.73c-.765-.297-1.636-.498-2.913-.558C15.667.012 15.26 0 12 0zm0 2.16c3.203 0 3.585.016 4.85.071 1.17.055 1.805.248 2.227.415.562.217.96.477 1.382.896.419.42.679.819.896 1.381.164.422.36 1.057.413 2.227.057 1.266.07 1.646.07 4.85s-.015 3.585-.074 4.85c-.056 1.17-.249 1.805-.413 2.227-.217.562-.477.96-.896 1.382-.42.419-.82.679-1.38.896-.423.164-1.057.36-2.227.413-1.266.057-1.646.07-4.85.07s-3.585-.015-4.85-.074c-1.17-.056-1.805-.249-2.227-.413-.562-.217-.96-.477-1.382-.896-.419-.42-.679-.82-1.381-.896-.164-.423-.36-1.057-.413-2.227-.057-1.266-.07-1.646-.07-4.85s.015-3.585.074-4.85c.056-1.17.249-1.805.413-2.227.217-.562.477-.96.896-1.382.42-.419.819-.679 1.381-.896.422-.164 1.057-.36 2.227-.413C8.415 2.175 8.796 2.16 12 2.16zm0 3.36c-3.315 0-6 2.685-6 6s2.685 6 6 6 6-2.685 6-6-2.685-6-6-6zm0 9.84c-2.12 0-3.84-1.72-3.84-3.84s1.72-3.84 3.84-3.84 3.84 1.72 3.84 3.84-1.72 3.84-3.84 3.84zM20.4 3.6c-.78 0-1.44.66-1.44 1.44s.66 1.44 1.44 1.44 1.44-.66 1.44-1.44-.66-1.44-1.44-1.44z"/></svg>
                                </a>
                                <a href="https://www.facebook.com/share/1L8yaf25bk/" target="_blank" class="text-gray-500 hover:text-blue-600 transition-colors" title="Facebook">
                                    <svg class="w-8 h-8" role="img" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M22.675 0h-21.35C.59 0 0 .59 0 1.325v21.35C0 23.41.59 24 1.325 24H12.82v-9.29H9.692v-3.622h3.128V8.413c0-3.1 1.893-4.788 4.659-4.788 1.325 0 2.463.099 2.795.143v3.24l-1.918.001c-1.504 0-1.795.715-1.795 1.763v2.313h3.587l-.467 3.622h-3.12V24h6.116c.735 0 1.325-.59 1.325-1.325V1.325C24 .59 23.41 0 22.675 0z"/></svg>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile Page -->
                <div id="profile" class="page">
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-lg max-w-lg mx-auto">
                        <h2 class="text-3xl font-bold mb-6 text-center">My Profile</h2>
                        <div class="text-center mb-6">
                            <img id="profile-page-pic" src="https://placehold.co/128x128/E2E8F0/4A5568?text=P" class="w-32 h-32 rounded-full mx-auto mb-4 border-4 border-gray-300 dark:border-gray-600 object-cover">
                        </div>
                        <form id="profile-update-form">
                            <div class="mb-4">
                                <label for="profile-name" class="block text-sm font-medium mb-2">Full Name</label>
                                <input type="text" id="profile-name" class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 border-2 border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div class="mb-4">
                                <label for="profile-username" class="block text-sm font-medium mb-2">Username</label>
                                <input type="text" id="profile-username" class="w-full px-4 py-2 bg-gray-200 dark:bg-gray-800 border-2 border-transparent rounded-lg" disabled>
                            </div>
                            <div class="mb-6">
                                <label for="profile-email" class="block text-sm font-medium mb-2">Email</label>
                                <input type="email" id="profile-email" class="w-full px-4 py-2 bg-gray-200 dark:bg-gray-800 border-2 border-transparent rounded-lg" disabled>
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">Update Profile</button>
                        </form>
                    </div>
                </div>

            </main>
        </div>

        <!-- Floating Action Button to Add Transaction -->
        <button id="add-transaction-fab" class="fixed bottom-8 right-8 bg-indigo-600 hover:bg-indigo-700 text-white w-16 h-16 rounded-full shadow-2xl flex items-center justify-center text-4xl font-light z-20 transform hover:scale-110 transition-transform">
            +
        </button>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword,
            updateProfile,
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc,
            doc,
            setDoc,
            getDoc,
            onSnapshot,
            query,
            deleteDoc,
            updateDoc,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyBAjSI9qQz1ZQ0oNFP3qxSJPjocDFO1DnI",
          authDomain: "i-expanse-tracker-5375b.firebaseapp.com",
          projectId: "i-expanse-tracker-5375b",
          storageBucket: "i-expanse-tracker-5375b.firebasestorage.app",
          messagingSenderId: "442895718535",
          appId: "1:442895718535:web:e09ef6e8fb555b7ebcc022",
          measurementId: "G-C1644P9YXL"
        };

        // --- Initialize Firebase Services ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();
        
        // --- Global State & Variables ---
        let currentUser = null;
        let transactionsUnsubscribe = null;
        let categoriesUnsubscribe = null;
        let expenseChart = null;
        let allTransactions = [];
        let allCategories = [];

        // --- DOM Element Selectors ---
        const authScreen = document.getElementById('auth-screen');
        const appContainer = document.getElementById('app-container');
        const globalLoader = document.getElementById('global-loader');
        
        // --- Utility Functions ---
        const showLoader = () => globalLoader.classList.remove('hidden');
        const hideLoader = () => globalLoader.classList.add('hidden');

        const showError = (title, text) => {
            Swal.fire({ icon: 'error', title, text });
        };

        const showSuccess = (title, text) => {
            Swal.fire({ icon: 'success', title, text, timer: 1500, showConfirmButton: false });
        };

        // --- Authentication Logic ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in.
                const userDocRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userDocRef);
                
                if (!userDoc.exists()) {
                    // This case handles users who signed up but data creation failed, or Google sign-in for the first time.
                    showLoader();
                    await createUserDocument(user, user.displayName, user.displayName?.toLowerCase().replace(/\s/g, ''));
                    await setupInitialData(user);
                    hideLoader();
                }
                
                currentUser = { ...user, ...userDoc.data() };
                authScreen.style.display = 'none';
                appContainer.style.display = 'block';
                initializeAppUI();
            } else {
                // User is signed out.
                currentUser = null;
                authScreen.style.display = 'flex';
                appContainer.style.display = 'none';
                if (transactionsUnsubscribe) transactionsUnsubscribe();
                if (categoriesUnsubscribe) categoriesUnsubscribe();
            }
        });

        // Function to create a user document in Firestore
        const createUserDocument = async (user, fullName, username) => {
            const userDocRef = doc(db, 'users', user.uid);
            await setDoc(userDocRef, {
                uid: user.uid,
                fullName: fullName,
                username: username,
                email: user.email,
                createdAt: new Date(),
                photoURL: user.photoURL
            });
        };

        // Signup with Email and Password
        document.getElementById('signup-form-fields').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoader();
            const fullName = document.getElementById('signup-name').value;
            const username = document.getElementById('signup-username').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Update Firebase Auth profile
                await updateProfile(user, { displayName: fullName });
                
                // Create user document in Firestore
                await createUserDocument(user, fullName, username);

                // Setup initial categories
                await setupInitialData(user);
                
                // onAuthStateChanged will handle the rest
            } catch (error) {
                showError('Signup Failed', error.message);
            } finally {
                hideLoader();
            }
        });

        // Login with Email and Password
        document.getElementById('login-form-fields').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoader();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle UI switch
            } catch (error) {
                showError('Login Failed', error.message);
            } finally {
                hideLoader();
            }
        });

        // Sign in with Google
        document.getElementById('google-signin-btn').addEventListener('click', async () => {
            showLoader();
            try {
                await signInWithPopup(auth, googleProvider);
                // onAuthStateChanged will check if the user is new and handle data creation.
            } catch (error) {
                showError('Google Sign-In Failed', error.message);
            } finally {
                hideLoader();
            }
        });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        // Auth form toggling
        document.getElementById('show-signup').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('signup-form').classList.remove('hidden');
        });
        document.getElementById('show-login').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('signup-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
        });

        // --- Initial Data Setup for New Users ---
        async function setupInitialData(user) {
            const categoriesColRef = collection(db, 'users', user.uid, 'categories');
            const defaultCategories = [
                { name: 'Salary', type: 'income', emoji: '💼' },
                { name: 'Business', type: 'income', emoji: '📈' },
                { name: 'Gifts', type: 'income', emoji: '🎁' },
                { name: 'Food & Dining', type: 'expense', emoji: '🍔' },
                { name: 'Transportation', type: 'expense', emoji: '🚗' },
                { name: 'Shopping', type: 'expense', emoji: '🛍️' },
                { name: 'Bills & Utilities', type: 'expense', emoji: '💡' },
                { name: 'Entertainment', type: 'expense', emoji: '🎬' },
                { name: 'Health & Wellness', type: 'expense', emoji: '❤️' },
                { name: 'Education', type: 'expense', emoji: '🎓' },
            ];
            
            const batch = writeBatch(db);
            defaultCategories.forEach(cat => {
                const newCatRef = doc(categoriesColRef);
                batch.set(newCatRef, cat);
            });
            await batch.commit();
        }

        // --- UI Initialization & Event Handlers ---
        function initializeAppUI() {
            updateUserInfo();
            setupNavigation();
            setupEventListeners();
            listenForTransactions();
            listenForCategories();
            showPage('dashboard');
        }

        function updateUserInfo() {
            if (!currentUser) return;
            const userName = currentUser.fullName || currentUser.displayName || 'User';
            const userPic = currentUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=random`;
            
            document.getElementById('header-user-name').textContent = userName.split(' ')[0]; // Show first name
            document.getElementById('header-user-pic').src = userPic;
            
            // Profile Page
            document.getElementById('profile-name').value = userName;
            document.getElementById('profile-username').value = currentUser.username || 'N/A';
            document.getElementById('profile-email').value = currentUser.email;
            document.getElementById('profile-page-pic').src = userPic;
        }

        function setupNavigation() {
            const menuToggleBtn = document.getElementById('menu-toggle-btn');
            const sideNav = document.getElementById('side-nav');
            const sideNavOverlay = document.getElementById('side-nav-overlay');

            const toggleNav = () => {
                sideNav.classList.toggle('-translate-x-full');
                sideNavOverlay.classList.toggle('hidden');
            };

            menuToggleBtn.addEventListener('click', toggleNav);
            sideNavOverlay.addEventListener('click', toggleNav);

            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = link.getAttribute('href').substring(1);
                    showPage(pageId);
                    if (window.innerWidth < 1024) { // Only close on mobile
                        toggleNav();
                    }
                });
            });
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            const newPage = document.getElementById(pageId);
            if(newPage) {
                newPage.classList.add('active');
                document.getElementById('page-title').textContent = newPage.id.charAt(0).toUpperCase() + newPage.id.slice(1);
                
                // Update active link style
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('bg-indigo-100', 'dark:bg-gray-700', 'text-indigo-600', 'dark:text-white', 'border-indigo-500');
                    link.classList.add('border-transparent');
                    if (link.getAttribute('href') === `#${pageId}`) {
                        link.classList.add('bg-indigo-100', 'dark:bg-gray-700', 'text-indigo-600', 'dark:text-white', 'border-indigo-500');
                        link.classList.remove('border-transparent');
                    }
                });
            }
        }

        function setupEventListeners() {
            document.getElementById('add-transaction-fab').addEventListener('click', () => openTransactionModal());
            document.getElementById('add-category-btn').addEventListener('click', openCategoryModal);
            document.getElementById('generate-pdf-btn').addEventListener('click', generatePDFReport);
            
            document.getElementById('profile-update-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const newName = document.getElementById('profile-name').value;
                if (newName === (currentUser.fullName || currentUser.displayName)) return;
                
                showLoader();
                try {
                    await updateProfile(auth.currentUser, { displayName: newName });
                    await updateDoc(doc(db, 'users', currentUser.uid), { fullName: newName });
                    currentUser.fullName = newName; // Update local state
                    updateUserInfo();
                    showSuccess('Profile Updated!', 'Your name has been changed successfully.');
                } catch (error) {
                    showError('Update Failed', error.message);
                } finally {
                    hideLoader();
                }
            });

            // Search and Filter listeners
            const searchInput = document.getElementById('search-transactions');
            const filterSelect = document.getElementById('filter-type');
            const applyFilters = () => renderTransactions(allTransactions, searchInput.value, filterSelect.value);
            searchInput.addEventListener('input', applyFilters);
            filterSelect.addEventListener('change', applyFilters);
        }

        // --- Firestore Data Listeners ---
        function listenForTransactions() {
            if (transactionsUnsubscribe) transactionsUnsubscribe();
            const q = query(collection(db, 'users', currentUser.uid, 'transactions'));
            transactionsUnsubscribe = onSnapshot(q, (snapshot) => {
                allTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allTransactions.sort((a, b) => b.date.toDate() - a.date.toDate());
                renderDashboard();
                renderTransactions(allTransactions, document.getElementById('search-transactions').value, document.getElementById('filter-type').value);
            }, (error) => {
                console.error("Error listening for transactions:", error);
                showError("Data Error", "Could not fetch transactions.");
            });
        }
        
        function listenForCategories() {
            if (categoriesUnsubscribe) categoriesUnsubscribe();
            const q = query(collection(db, 'users', currentUser.uid, 'categories'));
            categoriesUnsubscribe = onSnapshot(q, (snapshot) => {
                allCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCategories();
            }, (error) => {
                console.error("Error listening for categories:", error);
                showError("Data Error", "Could not fetch categories.");
            });
        }

        // --- Rendering Functions ---
        function renderDashboard() {
            let totalIncome = 0, totalExpense = 0;
            const expenseByCategory = {};

            allTransactions.forEach(t => {
                if (t.type === 'income') {
                    totalIncome += t.amount;
                } else {
                    totalExpense += t.amount;
                    expenseByCategory[t.category] = (expenseByCategory[t.category] || 0) + t.amount;
                }
            });

            document.getElementById('total-income').textContent = `৳${totalIncome.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('total-expense').textContent = `৳${totalExpense.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('current-balance').textContent = `৳${(totalIncome - totalExpense).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

            renderRecentTransactions();
            renderExpenseChart(expenseByCategory);
        }

        function renderRecentTransactions() {
            const listEl = document.getElementById('recent-transactions-list');
            listEl.innerHTML = '';
            const recent = allTransactions.slice(0, 5);

            if (recent.length === 0) {
                listEl.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-8">No recent transactions.</p>';
                return;
            }

            recent.forEach(t => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors';
                const isIncome = t.type === 'income';
                item.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <div class="w-11 h-11 rounded-full flex items-center justify-center text-xl ${isIncome ? 'bg-green-100 dark:bg-green-900' : 'bg-red-100 dark:bg-red-900'}">
                           ${t.category_emoji || (isIncome ? '💰' : '💸')}
                        </div>
                        <div>
                            <p class="font-bold text-gray-800 dark:text-gray-100">${t.name}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">${t.date.toDate().toLocaleDateString('en-GB')}</p>
                        </div>
                    </div>
                    <p class="font-bold text-lg ${isIncome ? 'text-green-500' : 'text-red-500'}">${isIncome ? '+' : '-'}৳${t.amount.toLocaleString('en-IN')}</p>
                `;
                listEl.appendChild(item);
            });
        }
        
        function renderTransactions(transactions, searchTerm = '', filterType = 'all') {
            const listEl = document.getElementById('transactions-list-full');
            listEl.innerHTML = '';

            const filtered = transactions.filter(t => 
                t.name.toLowerCase().includes(searchTerm.toLowerCase()) && 
                (filterType === 'all' || t.type === filterType)
            );

            if (filtered.length === 0) {
                listEl.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 p-8">No matching transactions found.</p>';
                return;
            }

            filtered.forEach(t => {
                const item = document.createElement('div');
                const isIncome = t.type === 'income';
                item.className = 'flex justify-between items-center p-4 bg-gray-50 dark:bg-gray-800/60 rounded-xl';
                item.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center text-2xl ${isIncome ? 'bg-green-100 dark:bg-green-900' : 'bg-red-100 dark:bg-red-900'}">
                           ${t.category_emoji || (isIncome ? '💰' : '💸')}
                        </div>
                        <div>
                            <p class="font-bold text-lg">${t.name}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">${t.category} &bull; ${t.date.toDate().toLocaleDateString('en-GB')}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <p class="font-bold text-xl mr-4 ${isIncome ? 'text-green-600' : 'text-red-600'}">${isIncome ? '+' : '-'}৳${t.amount.toLocaleString('en-IN')}</p>
                        <button class="edit-btn p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full transition-colors"><svg class="w-5 h-5 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg></button>
                        <button class="delete-btn p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full transition-colors"><svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg></button>
                    </div>
                `;
                item.querySelector('.edit-btn').addEventListener('click', () => openTransactionModal(t));
                item.querySelector('.delete-btn').addEventListener('click', () => deleteTransaction(t.id, t.name));
                listEl.appendChild(item);
            });
        }
        
        function renderCategories() {
            const listEl = document.getElementById('categories-list');
            listEl.innerHTML = '';
            if (allCategories.length === 0) {
                listEl.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 p-8">No categories created yet.</p>';
                return;
            }
            
            allCategories.forEach(cat => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-4 bg-gray-50 dark:bg-gray-800/60 rounded-xl';
                const isIncome = cat.type === 'income';
                item.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">${cat.emoji || '📁'}</span>
                        <span class="font-bold text-lg">${cat.name}</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="text-sm font-medium px-3 py-1 rounded-full ${isIncome ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}">${cat.type}</span>
                        <button class="edit-cat-btn p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full transition-colors"><svg class="w-5 h-5 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg></button>
                        <button class="delete-cat-btn p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full transition-colors"><svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg></button>
                    </div>
                `;
                item.querySelector('.edit-cat-btn').addEventListener('click', () => openCategoryModal(cat));
                item.querySelector('.delete-cat-btn').addEventListener('click', () => deleteCategory(cat.id, cat.name));
                listEl.appendChild(item);
            });
        }

        function renderExpenseChart(data) {
            const container = document.getElementById('expense-chart-container');
            const ctx = document.getElementById('expense-chart').getContext('2d');
            const labels = Object.keys(data);
            const values = Object.values(data);

            if (expenseChart) expenseChart.destroy();
            
            if (labels.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 pt-16">No expense data to display.</p>';
                return;
            } else if (!document.getElementById('expense-chart')) {
                container.innerHTML = '<canvas id="expense-chart"></canvas>';
            }

            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: ['#ef4444', '#3b82f6', '#f97316', '#14b8a6', '#8b5cf6', '#f59e0b', '#6b7280'],
                        borderColor: '#fff',
                        borderWidth: 2,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: document.body.classList.contains('dark') ? '#fff' : '#333' } }
                    },
                    cutout: '60%'
                }
            });
        }

        // --- Modals (SweetAlert2) ---
        function openTransactionModal(transaction = null) {
            const isEditing = transaction !== null;
            const getOptions = (type) => allCategories.filter(c => c.type === type).map(c => `<option value="${c.name}" data-emoji="${c.emoji || ''}" ${isEditing && transaction.category === c.name ? 'selected' : ''}>${c.emoji || ''} ${c.name}</option>`).join('');

            Swal.fire({
                title: isEditing ? 'Edit Transaction' : 'Add New Transaction',
                html: `
                    <form id="transaction-form" class="text-left space-y-4 p-2">
                        <div>
                            <label class="block text-sm font-medium mb-1">Type</label>
                            <select id="swal-type" class="swal2-input">
                                <option value="expense" ${isEditing && transaction.type === 'expense' ? 'selected' : ''}>Expense</option>
                                <option value="income" ${isEditing && transaction.type === 'income' ? 'selected' : ''}>Income</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Name</label>
                            <input id="swal-name" class="swal2-input" placeholder="e.g., Coffee" value="${isEditing ? transaction.name : ''}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Amount (৳)</label>
                            <input id="swal-amount" type="number" step="0.01" class="swal2-input" placeholder="e.g., 150.50" value="${isEditing ? transaction.amount : ''}" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Category</label>
                            <select id="swal-category" class="swal2-input"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Date</label>
                            <input id="swal-date" type="date" class="swal2-input" value="${isEditing ? transaction.date.toDate().toISOString().split('T')[0] : new Date().toISOString().split('T')[0]}" required>
                        </div>
                    </form>
                `,
                confirmButtonText: isEditing ? 'Save Changes' : 'Add Transaction',
                confirmButtonColor: '#4f46e5',
                showCancelButton: true,
                focusConfirm: false,
                didOpen: () => {
                    const typeSelect = document.getElementById('swal-type');
                    const categorySelect = document.getElementById('swal-category');
                    const updateCategories = () => {
                        categorySelect.innerHTML = getOptions(typeSelect.value);
                    };
                    typeSelect.addEventListener('change', updateCategories);
                    updateCategories();
                },
                preConfirm: () => {
                    const categorySelect = document.getElementById('swal-category');
                    const selectedOption = categorySelect.options[categorySelect.selectedIndex];
                    return {
                        type: document.getElementById('swal-type').value,
                        name: document.getElementById('swal-name').value,
                        amount: parseFloat(document.getElementById('swal-amount').value),
                        category: categorySelect.value,
                        category_emoji: selectedOption.dataset.emoji,
                        date: new Date(document.getElementById('swal-date').value)
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const data = result.value;
                    if (!data.name || !data.amount || !data.category || !data.date) {
                        showError('Invalid Input', 'Please fill all fields correctly.');
                        return;
                    }
                    if (isEditing) {
                        updateTransaction(transaction.id, data);
                    } else {
                        addTransaction(data);
                    }
                }
            });
        }

        function openCategoryModal(category = null) {
            const isEditing = category !== null;
            Swal.fire({
                title: isEditing ? 'Edit Category' : 'Add New Category',
                html: `
                    <input id="swal-cat-name" class="swal2-input" placeholder="Category Name" value="${isEditing ? category.name : ''}" required>
                    <input id="swal-cat-emoji" class="swal2-input mt-2" placeholder="Emoji (e.g., 🍔)" value="${isEditing ? category.emoji : ''}" maxlength="2">
                    <select id="swal-cat-type" class="swal2-input mt-2">
                        <option value="expense" ${isEditing && category.type === 'expense' ? 'selected' : ''}>Expense</option>
                        <option value="income" ${isEditing && category.type === 'income' ? 'selected' : ''}>Income</option>
                    </select>
                `,
                confirmButtonText: isEditing ? 'Save' : 'Add',
                confirmButtonColor: '#4f46e5',
                showCancelButton: true,
                focusConfirm: false,
                preConfirm: () => ({
                    name: document.getElementById('swal-cat-name').value,
                    emoji: document.getElementById('swal-cat-emoji').value,
                    type: document.getElementById('swal-cat-type').value
                })
            }).then((result) => {
                if (result.isConfirmed) {
                    const data = result.value;
                    if (!data.name) {
                        showError('Invalid Input', 'Category name cannot be empty.');
                        return;
                    }
                    if (isEditing) {
                        updateCategory(category.id, data);
                    } else {
                        addCategory(data);
                    }
                }
            });
        }

        // --- CRUD Operations ---
        const addTransaction = async (data) => {
            try {
                await addDoc(collection(db, 'users', currentUser.uid, 'transactions'), data);
                showSuccess('Success!', 'Transaction added successfully.');
            } catch (error) { showError('Error', 'Could not add transaction.'); }
        };

        const updateTransaction = async (id, data) => {
            try {
                await updateDoc(doc(db, 'users', currentUser.uid, 'transactions', id), data);
                showSuccess('Success!', 'Transaction updated successfully.');
            } catch (error) { showError('Error', 'Could not update transaction.'); }
        };

        const deleteTransaction = (id, name) => {
            Swal.fire({
                title: 'Are you sure?',
                text: `You won't be able to revert deleting "${name}"!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        await deleteDoc(doc(db, 'users', currentUser.uid, 'transactions', id));
                        Swal.fire('Deleted!', 'Your transaction has been deleted.', 'success');
                    } catch (error) { showError('Error', 'Could not delete transaction.'); }
                }
            });
        };
        
        const addCategory = async (data) => {
            try {
                await addDoc(collection(db, 'users', currentUser.uid, 'categories'), data);
                showSuccess('Success!', 'Category added successfully.');
            } catch (error) { showError('Error', 'Could not add category.'); }
        };

        const updateCategory = async (id, data) => {
            try {
                await updateDoc(doc(db, 'users', currentUser.uid, 'categories', id), data);
                showSuccess('Success!', 'Category updated successfully.');
            } catch (error) { showError('Error', 'Could not update category.'); }
        };

        const deleteCategory = (id, name) => {
            Swal.fire({
                title: 'Are you sure?',
                text: `Deleting category "${name}" will not delete associated transactions.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        await deleteDoc(doc(db, 'users', currentUser.uid, 'categories', id));
                        Swal.fire('Deleted!', 'The category has been deleted.', 'success');
                    } catch (error) { showError('Error', 'Could not delete category.'); }
                }
            });
        };

        // --- PDF Generation ---
        async function generatePDFReport() {
            const { jsPDF } = window.jspdf;
            const docPDF = new jsPDF();
            
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            if (!startDate || !endDate) {
                showError('Date Missing', 'Please select both a start and end date.');
                return;
            }

            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999);

            const filteredTransactions = allTransactions.filter(t => t.date.toDate() >= start && t.date.toDate() <= end);
            
            if (filteredTransactions.length === 0) {
                showError('No Data', 'No transactions found in the selected date range.');
                return;
            }
            
            // --- PDF Header ---
            const svgLogo = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M30,50 C30,27.9 47.9,10 70,10 C92.1,10 110,27.9 110,50 C110,72.1 92.1,90 70,90 C55,90 42.5,81.1 35.4,68.6 M70,50 C70,72.1 52.1,90 30,90 C7.9,90 -10,72.1 -10,50 C-10,27.9 7.9,10 30,10 C45,10 57.5,18.9 64.6,31.4" stroke="#4f46e5" stroke-width="10" fill="none" stroke-linecap="round"/></svg>`;
            docPDF.addSvgAsImage(svgLogo, 15, 12, 20, 20);
            
            docPDF.setFontSize(22);
            docPDF.setFont('helvetica', 'bold');
            docPDF.text("I Expanse Tracker", 40, 20);
            docPDF.setFontSize(10);
            docPDF.setFont('helvetica', 'normal');
            docPDF.text("Your personal finance companion", 40, 27);
            
            docPDF.setFontSize(14);
            docPDF.setFont('helvetica', 'bold');
            docPDF.text("Financial Report", 15, 45);
            docPDF.setFontSize(10);
            docPDF.setFont('helvetica', 'normal');
            docPDF.text(`Period: ${start.toLocaleDateString('en-GB')} to ${end.toLocaleDateString('en-GB')}`, 15, 51);
            docPDF.text(`Generated for: ${currentUser.fullName || currentUser.displayName}`, 15, 56);
            
            // --- PDF Body (Table) ---
            const tableColumn = ["Date", "Name", "Category", "Type", "Amount (BDT)"];
            const tableRows = [];
            let totalIncome = 0, totalExpense = 0;

            filteredTransactions.forEach(t => {
                tableRows.push([
                    t.date.toDate().toLocaleDateString('en-GB'),
                    t.name,
                    t.category,
                    t.type.charAt(0).toUpperCase() + t.type.slice(1),
                    { content: t.amount.toFixed(2), styles: { halign: 'right' } }
                ]);
                if (t.type === 'income') totalIncome += t.amount;
                else totalExpense += t.amount;
            });
            
            docPDF.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 65,
                theme: 'grid',
                headStyles: { fillColor: [79, 70, 229] } // Indigo color
            });

            // --- PDF Summary & Footer ---
            let finalY = docPDF.lastAutoTable.finalY + 15;
            const balance = totalIncome - totalExpense;
            
            docPDF.setFontSize(12);
            docPDF.setFont('helvetica', 'bold');
            docPDF.text("Summary", 145, finalY);
            
            docPDF.setFontSize(10);
            docPDF.setFont('helvetica', 'normal');
            docPDF.text("Total Income:", 145, finalY + 7);
            docPDF.text(`BDT ${totalIncome.toFixed(2)}`, 200, finalY + 7, { align: 'right' });
            
            docPDF.text("Total Expense:", 145, finalY + 14);
            docPDF.text(`BDT ${totalExpense.toFixed(2)}`, 200, finalY + 14, { align: 'right' });
            
            docPDF.setLineWidth(0.5);
            docPDF.line(145, finalY + 17, 200, finalY + 17);
            
            docPDF.setFont('helvetica', 'bold');
            docPDF.text("Final Balance:", 145, finalY + 23);
            docPDF.text(`BDT ${balance.toFixed(2)}`, 200, finalY + 23, { align: 'right' });

            const pageHeight = docPDF.internal.pageSize.height;
            docPDF.setFontSize(8);
            docPDF.setTextColor(150);
            docPDF.text("Report generated by I Expanse Tracker", 15, pageHeight - 15);
            docPDF.text("Developed by: Md Habibur Rahman Mahi (Founder & CEO, Infinity Group)", 15, pageHeight - 10);

            docPDF.save(`I-Expanse-Report_${startDate}_to_${endDate}.pdf`);
        }
    </script>
</body>
</html>

