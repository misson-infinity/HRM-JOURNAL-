<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I Expanse Tracker - Md Habibur Rahman Mahi</title>
    
    <!-- App Icon -->
    <link rel="icon" href="https://i.ibb.co/9vXy2pX/image-4.png" type="image/png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- jsPDF and html2canvas for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- SweetAlert2 for beautiful modals -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Marked.js for rendering Markdown from Gemini -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .dark body {
             background-color: #111827;
             color: #d1d5db;
        }
        .infinity-icon {
            font-size: 2rem;
            color: #4f46e5;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        /* Sidebar transition */
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-hidden {
            transform: translateX(-100%);
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        .dark ::-webkit-scrollbar-track { background: #2d3748; }
        .dark ::-webkit-scrollbar-thumb { background: #718096; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }

        .main-content {
            transition: margin-left 0.3s ease-in-out;
        }
        /* Glassmorphism effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        .dark .glass-card {
            background: rgba(31, 41, 55, 0.6);
            border: 1px solid rgba(75, 85, 99, 0.3);
        }

        .btn-primary { @apply bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300; }
        .btn-secondary { @apply bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-300 transition duration-300; }
        .btn-danger { @apply bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-red-700 transition duration-300; }
        .btn-ai { @apply bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:from-purple-600 hover:to-indigo-700 transition duration-300; }
        
        /* Dark mode styles */
        .dark #sidebar, .dark header { background-color: #1f2937; }
        .dark #sidebar a, .dark #page-title, .dark footer { color: #d1d5db; }
        .dark #sidebar a:hover { background-color: #374151; color: #ffffff; }
        .dark .bg-white { background-color: #1f2937; }
        .dark .text-gray-800 { color: #d1d5db; }
        .dark .text-gray-600 { color: #9ca3af; }
        .dark .border, .dark .border-b { border-color: #374151; }
        .dark input, .dark select, .dark textarea { background-color: #374151; color: #d1d5db; border-color: #4b5563; }
        .dark .btn-secondary { background-color: #4b5563; color: #d1d5db; hover:bg-gray-600; }

        /* Style for AI response modal */
        .swal2-html-container { text-align: left; max-height: 60vh; overflow-y: auto; }
        .swal2-html-container h2 { @apply text-xl font-bold mt-4 mb-2; }
        .swal2-html-container ul { @apply list-disc list-inside pl-4 mb-2; }
        .swal2-html-container li { @apply mb-1; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center z-[100]">
        <div class="text-white text-center">
            <img src="https://i.ibb.co/9vXy2pX/image-4.png" alt="App Logo" class="w-24 h-24 mx-auto mb-4 animate-bounce">
            <h1 class="text-4xl font-bold">I Expanse Tracker</h1>
            <p class="mt-4 text-lg">Developed by:</p>
            <p class="text-2xl font-semibold">Md Habibur Rahman Mahi</p>
            <p class="text-md">Founder and CEO of Infinity Group</p>
            <div class="mt-8">
                <i class="fas fa-spinner fa-spin text-3xl"></i>
            </div>
        </div>
    </div>

    <!-- Main Application Wrapper -->
    <div id="app-wrapper" class="hidden">
        <!-- Sidebar Navigation -->
        <div id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-white shadow-lg z-40 sidebar-hidden lg:transform-none">
            <div class="p-6 text-center border-b">
                <img src="https://i.ibb.co/9vXy2pX/image-4.png" alt="App Logo" class="w-16 h-16 mx-auto mb-2">
                <h2 class="text-xl font-bold text-indigo-600">I Expanse Tracker</h2>
            </div>
            <nav class="mt-6">
                <a href="#" id="nav-dashboard" class="flex items-center px-6 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600">
                    <i class="fas fa-tachometer-alt w-6"></i><span class="ml-4">Dashboard</span>
                </a>
                <a href="#" id="nav-transactions" class="flex items-center px-6 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600">
                    <i class="fas fa-exchange-alt w-6"></i><span class="ml-4">Transactions</span>
                </a>
                 <a href="#" id="nav-categories" class="flex items-center px-6 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600">
                    <i class="fas fa-tags w-6"></i><span class="ml-4">Categories</span>
                </a>
                <a href="#" id="nav-budget" class="flex items-center px-6 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600">
                    <i class="fas fa-bullseye w-6"></i><span class="ml-4">Budget</span>
                </a>
                 <a href="#" id="nav-goals" class="flex items-center px-6 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600">
                    <i class="fas fa-flag-checkered w-6"></i><span class="ml-4">Financial Goals</span>
                </a>
                <a href="#" id="nav-reports" class="flex items-center px-6 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600">
                    <i class="fas fa-file-pdf w-6"></i><span class="ml-4">Reports</span>
                </a>
                <a href="#" id="nav-ai-tools" class="flex items-center px-6 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600">
                    <i class="fas fa-wand-magic-sparkles w-6"></i><span class="ml-4">AI Assistant</span>
                </a>
                <a href="#" id="nav-developer" class="flex items-center px-6 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600">
                    <i class="fas fa-user-tie w-6"></i><span class="ml-4">Developer</span>
                </a>
            </nav>
            <div class="absolute bottom-4 left-0 w-full px-6">
                <div class="flex justify-center space-x-4">
                    <label for="theme-toggle" class="flex items-center cursor-pointer">
                        <span class="mr-2 text-sm font-medium"><i class="fas fa-sun"></i></span>
                        <div class="relative">
                            <input type="checkbox" id="theme-toggle" class="sr-only">
                            <div class="block bg-gray-600 w-14 h-8 rounded-full"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
                        </div>
                        <span class="ml-2 text-sm font-medium"><i class="fas fa-moon"></i></span>
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Overlay for sidebar on mobile -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black opacity-50 z-30 hidden lg:hidden"></div>

        <!-- Main Content -->
        <div id="main-content" class="relative min-h-screen lg:ml-64">
            <!-- Header -->
            <header class="sticky top-0 bg-white/80 backdrop-blur-sm shadow-sm p-4 z-20 flex justify-between items-center">
                <button id="sidebar-toggle" class="text-2xl text-indigo-600 lg:hidden">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 id="page-title" class="text-xl font-bold text-gray-800">Dashboard</h1>
                <button id="add-transaction-button-header" class="btn-primary flex items-center">
                    <i class="fas fa-plus mr-2"></i> <span class="hidden sm:inline">Add Transaction</span>
                </button>
            </header>

            <!-- Page Content -->
            <main class="p-4 sm:p-6">
                <div id="page-content-area">
                    <!-- Content will be loaded here by JavaScript -->
                </div>
            </main>

            <!-- Footer -->
            <footer class="text-center p-4 text-gray-600 mt-8">
                <p>© <span id="current-year"></span> I Expanse Tracker. Developed by Md Habibur Rahman Mahi.</p>
            </footer>
        </div>
    </div>
    
    <!-- PDF Report Generation Template (Hidden) -->
    <div id="pdf-report-template" class="hidden">
        <div class="p-8 bg-white text-gray-800" style="width: 800px;">
            <div class="flex justify-between items-start border-b-2 border-indigo-500 pb-4 mb-4">
                <div>
                    <img src="https://i.ibb.co/9vXy2pX/image-4.png" alt="App Logo" class="w-20 h-20">
                    <h1 class="text-3xl font-bold text-indigo-600 mt-2">I Expanse Tracker</h1>
                    <p class="text-gray-500">Your Personal Finance Companion</p>
                </div>
                <div class="text-right">
                    <img src="https://i.ibb.co/L5B7P4V/Picsart-24-12-22-22-58-18-749.png" alt="Developer" class="w-24 h-24 rounded-full border-4 border-indigo-300 ml-auto">
                    <h2 class="text-xl font-bold mt-2">Md Habibur Rahman Mahi</h2>
                    <p class="text-sm text-gray-600">Founder and CEO of Infinity Group</p>
                </div>
            </div>
            <div class="text-center my-6">
                <h2 class="text-2xl font-semibold">Financial Report</h2>
                <p id="pdf-report-range" class="text-gray-600"></p>
            </div>
            <div id="pdf-report-summary" class="grid grid-cols-3 gap-4 my-6 text-center">
                <!-- Summary will be injected here -->
            </div>
            <h3 class="text-xl font-semibold mb-4">Transaction Details</h3>
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-indigo-100">
                        <th class="p-2 border">Date</th>
                        <th class="p-2 border">Description</th>
                        <th class="p-2 border">Category</th>
                        <th class="p-2 border">Type</th>
                        <th class="p-2 border text-right">Amount (৳)</th>
                    </tr>
                </thead>
                <tbody id="pdf-report-table-body">
                    <!-- Transaction rows will be injected here -->
                </tbody>
            </table>
            <div class="mt-8 text-center text-xs text-gray-500">
                <p>Generated on: <span id="pdf-generation-date"></span></p>
                <p>This is a computer-generated report from I Expanse Tracker.</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, onSnapshot, query, where, updateDoc, deleteDoc, writeBatch, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App Configuration ---
        // Your full and correct Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBAjSI9qQz1ZQ0oNFP3qxSJPjocDFO1DnI",
            authDomain: "i-expanse-tracker-5375b.firebaseapp.com",
            projectId: "i-expanse-tracker-5375b",
            storageBucket: "i-expanse-tracker-5375b.appspot.com",
            messagingSenderId: "442895718535",
            appId: "1:442895718535:web:e09ef6e8fb555b7ebcc022",
            measurementId: "G-C1644P9YXL"
        };
        
        // --- Firebase Initialization ---
        let app, auth, db, userId;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.body.innerHTML = `<div class="p-8 text-center text-red-500">Failed to connect to the database. Please check your Firebase configuration in the script.</div>`;
        }
        
        // --- Global State ---
        let transactions = [];
        let categories = [];
        let budgets = [];
        let goals = [];
        let expenseChart = null;
        let incomeVsExpenseChart = null;
        let unsubscribeListeners = [];

        // --- Default Categories ---
        const defaultCategories = [
            { name: 'Salary', type: 'income', icon: 'fa-money-bill-wave' },
            { name: 'Business', type: 'income', icon: 'fa-briefcase' },
            { name: 'Gifts', type: 'income', icon: 'fa-gift' },
            { name: 'Food', type: 'expense', icon: 'fa-utensils' },
            { name: 'Transport', type: 'expense', icon: 'fa-bus' },
            { name: 'Housing', type: 'expense', icon: 'fa-home' },
            { name: 'Bills', type: 'expense', icon: 'fa-file-invoice-dollar' },
            { name: 'Health', type: 'expense', icon: 'fa-heartbeat' },
            { name: 'Education', type: 'expense', icon: 'fa-graduation-cap' },
            { name: 'Shopping', type: 'expense', icon: 'fa-shopping-cart' },
            { name: 'Entertainment', type: 'expense', icon: 'fa-film' },
            { name: 'Others', type: 'expense', icon: 'fa-ellipsis-h' }
        ];

        // --- UI Elements ---
        const pageContentArea = document.getElementById('page-content-area');
        const pageTitle = document.getElementById('page-title');

        // --- Helper Functions ---
        const formatCurrency = (amount) => `৳ ${parseFloat(amount || 0).toFixed(2)}`;
        const formatDate = (date) => {
            if (!date) return '';
            const d = date instanceof Timestamp ? date.toDate() : new Date(date);
            return d.toISOString().split('T')[0]; // YYYY-MM-DD
        };
        const formatDateReadable = (date) => {
             if (!date) return '';
            const d = date instanceof Timestamp ? date.toDate() : new Date(date);
            return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        // --- Gemini API Function ---
        const callGeminiAPI = async (prompt) => {
            /* --- IMPORTANT --- */
            // Replace with your Google AI (Gemini) API Key
            const apiKey = "YOUR_GEMINI_API_KEY";
            
            if (apiKey === "YOUR_GEMINI_API_KEY") {
                return "## AI Assistant Disabled\n\nPlease add your Gemini API Key in the script to enable this feature.";
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`;
            
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error("Gemini API Error:", errorBody);
                    throw new Error(`API request failed: ${errorBody.error.message}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                     if (result.candidates && result.candidates[0]?.finishReason === 'SAFETY') {
                         return "The response was blocked due to safety concerns. Please rephrase your question.";
                    }
                    console.error("Unexpected API response structure:", result);
                    return "Sorry, I couldn't get a valid response. Please check the console.";
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return `An error occurred: ${error.message}.`;
            }
        };

        // --- Page Templates ---
        const pages = {
            dashboard: `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="glass-card p-6 text-center">
                        <h3 class="text-lg font-semibold text-gray-600">Current Balance</h3>
                        <p id="dashboard-balance" class="text-3xl font-bold text-green-600 mt-2">৳ 0.00</p>
                    </div>
                    <div class="glass-card p-6 text-center">
                        <h3 class="text-lg font-semibold text-gray-600">Total Income (This Month)</h3>
                        <p id="dashboard-income" class="text-3xl font-bold text-blue-600 mt-2">৳ 0.00</p>
                    </div>
                    <div class="glass-card p-6 text-center">
                        <h3 class="text-lg font-semibold text-gray-600">Total Expense (This Month)</h3>
                        <p id="dashboard-expense" class="text-3xl font-bold text-red-600 mt-2">৳ 0.00</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="font-bold text-lg mb-4">Expense Breakdown (This Month)</h3>
                        <canvas id="expense-chart"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="font-bold text-lg mb-4">Income vs Expense (Last 6 Months)</h3>
                        <canvas id="income-expense-chart"></canvas>
                    </div>
                </div>
                 <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="font-bold text-lg mb-4">Recent Transactions</h3>
                    <div id="recent-transactions-list" class="space-y-3 max-h-96 overflow-y-auto">
                        <p class="text-gray-500">No recent transactions.</p>
                    </div>
                </div>
            `,
            transactions: `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                        <h2 class="text-2xl font-bold">All Transactions</h2>
                        <div class="flex items-center gap-2 w-full sm:w-auto">
                            <input type="text" id="search-input" placeholder="Search..." class="p-2 border rounded-lg w-full">
                            <select id="filter-type" class="p-2 border rounded-lg">
                                <option value="all">All Types</option>
                                <option value="income">Income</option>
                                <option value="expense">Expense</option>
                            </select>
                        </div>
                    </div>
                    <div id="transactions-list-container" class="space-y-4">
                        <p class="text-gray-500">No transactions found.</p>
                    </div>
                </div>
            `,
            'ai-tools': `
                <div class="bg-white p-6 rounded-lg shadow-md text-center">
                    <i class="fas fa-wand-magic-sparkles text-5xl text-indigo-500 mb-4"></i>
                    <h2 class="text-2xl font-bold mb-2">AI Financial Assistant</h2>
                    <p class="text-gray-600 mb-6">Get smart financial advice, budget plans, and spending analysis. Ask me anything about your finances!</p>
                    <div class="max-w-2xl mx-auto">
                        <textarea id="ai-prompt" class="w-full p-3 border rounded-lg mb-4 h-32" placeholder="e.g., 'Give me a budget plan for a monthly income of ৳50,000' or 'Analyze my spending for last month and suggest savings.'"></textarea>
                        <button id="ask-ai-button" class="btn-ai w-full flex items-center justify-center">
                            <i class="fas fa-paper-plane mr-2"></i> Ask AI
                        </button>
                    </div>
                     <div class="mt-8 text-left max-w-2xl mx-auto">
                        <h3 class="font-semibold text-lg mb-2">Example Prompts:</h3>
                        <ul class="list-disc list-inside text-gray-600 space-y-1">
                            <li>"How can I save ৳10,000 in the next 3 months?"</li>
                            <li>"Create a weekly grocery budget based on my recent food spending."</li>
                            <li>"Is buying a new phone a good financial decision for me right now?"</li>
                        </ul>
                    </div>
                </div>
            `,
            reports: `
                <div class="bg-white p-6 rounded-lg shadow-md">
                     <h2 class="text-2xl font-bold mb-6">Generate Financial Report</h2>
                     <div class="max-w-md mx-auto flex flex-col sm:flex-row items-center gap-4">
                        <div class="w-full">
                            <label for="start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
                            <input type="date" id="start-date" class="mt-1 p-2 border rounded-lg w-full">
                        </div>
                        <div class="w-full">
                            <label for="end-date" class="block text-sm font-medium text-gray-700">End Date</label>
                            <input type="date" id="end-date" class="mt-1 p-2 border rounded-lg w-full">
                        </div>
                     </div>
                     <div class="text-center mt-6">
                        <button id="generate-pdf-button" class="btn-primary">
                            <i class="fas fa-file-pdf mr-2"></i> Generate PDF Report
                        </button>
                     </div>
                </div>
            `,
            categories: `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold mb-4">Manage Categories</h2>
                         <div id="categories-list" class="space-y-2 max-h-96 overflow-y-auto">
                            <p class="text-gray-500">No custom categories added.</p>
                         </div>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold mb-4">Add New Category</h2>
                        <form id="add-category-form">
                            <div class="mb-4">
                                <label for="category-name" class="block mb-2">Category Name</label>
                                <input type="text" id="category-name" class="w-full p-2 border rounded-lg" required>
                            </div>
                            <div class="mb-4">
                                <label for="category-type" class="block mb-2">Type</label>
                                <select id="category-type" class="w-full p-2 border rounded-lg">
                                    <option value="expense">Expense</option>
                                    <option value="income">Income</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label for="category-icon" class="block mb-2">Font Awesome Icon (e.g., fa-car)</label>
                                <input type="text" id="category-icon" value="fa-tag" class="w-full p-2 border rounded-lg" required>
                            </div>
                            <button type="submit" class="btn-primary w-full">Add Category</button>
                        </form>
                    </div>
                </div>
            `,
            budget: `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Set & Track Budgets</h2>
                    <p class="text-gray-600 mb-6">Set monthly budgets for your expense categories to keep spending in check.</p>
                    <div id="budget-list" class="space-y-6">
                       <p class="text-gray-500">No budgets set yet. Select a category to set a budget.</p>
                    </div>
                </div>
            `,
            goals: `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-2 bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold mb-4">Financial Goals</h2>
                        <div id="goals-list" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <p class="text-gray-500">No financial goals set yet. Add one to get started!</p>
                        </div>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold mb-4">Add New Goal</h2>
                        <form id="add-goal-form">
                            <div class="mb-3">
                                <label for="goal-name" class="block mb-1">Goal Name</label>
                                <input type="text" id="goal-name" class="w-full p-2 border rounded-lg" placeholder="e.g., New Laptop" required>
                            </div>
                            <div class="mb-3">
                                <label for="goal-target" class="block mb-1">Target Amount (৳)</label>
                                <input type="number" id="goal-target" class="w-full p-2 border rounded-lg" placeholder="50000" required>
                            </div>
                            <div class="mb-4">
                                <label for="goal-current" class="block mb-1">Current Savings (৳)</label>
                                <input type="number" id="goal-current" class="w-full p-2 border rounded-lg" value="0" required>
                            </div>
                            <button type="submit" class="btn-primary w-full">Add Goal</button>
                        </form>
                    </div>
                </div>
            `,
            developer: `
                <div class="bg-white p-8 rounded-lg shadow-md max-w-2xl mx-auto text-center">
                    <img src="https://i.ibb.co/L5B7P4V/Picsart-24-12-22-22-58-18-749.png" alt="Developer Photo" class="w-40 h-40 rounded-full mx-auto mb-4 border-4 border-indigo-400">
                    <h2 class="text-3xl font-bold text-gray-800">Md Habibur Rahman Mahi</h2>
                    <p class="text-indigo-500 font-semibold mt-1">Founder & CEO of Infinity Group</p>
                    <p class="text-gray-600 mt-4">
                        A passionate web developer and tech enthusiast dedicated to creating useful and beautiful applications. This I Expanse Tracker is a project born out of a desire to provide a simple yet powerful tool for personal finance management.
                    </p>
                    <div class="mt-6">
                         <a href="https://www.facebook.com/mdhabiburrahmanmahi01" target="_blank" class="text-indigo-600 hover:text-indigo-800 mx-2 text-2xl"><i class="fab fa-facebook"></i></a>
                         <a href="https://github.com/mdhabiburrahmanmahi" target="_blank" class="text-indigo-600 hover:text-indigo-800 mx-2 text-2xl"><i class="fab fa-github"></i></a>
                         <a href="https://www.linkedin.com/in/mdhabiburrahmanmahi/" target="_blank" class="text-indigo-600 hover:text-indigo-800 mx-2 text-2xl"><i class="fab fa-linkedin"></i></a>
                    </div>
                </div>
            `,
        };

        // --- Core App Logic ---
        
        /**
         * Initializes the application after user is authenticated.
         */
        const initApp = async () => {
            // Hide splash screen and show app
            document.getElementById('splash-screen').classList.add('hidden');
            document.getElementById('app-wrapper').classList.remove('hidden');
            
            // Set current year in footer
            document.getElementById('current-year').textContent = new Date().getFullYear();

            // Setup listeners
            setupEventListeners();

            // Load all data from Firestore
            await loadAllData();

            // Load initial page
            loadPage('dashboard');
        };
        
        /**
         * Loads all data from Firestore and sets up real-time listeners.
         */
        const loadAllData = async () => {
            // Unsubscribe from any previous listeners to prevent memory leaks
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];

            const userDocRef = doc(db, 'users', userId);
            const userDocSnap = await getDoc(userDocRef);

            // If user has no data, initialize with defaults
            if (!userDocSnap.exists()) {
                const batch = writeBatch(db);
                // Set a placeholder doc to indicate user exists
                batch.set(userDocRef, { createdAt: serverTimestamp() });
                // Add default categories
                defaultCategories.forEach(cat => {
                    const catRef = doc(collection(db, `users/${userId}/categories`));
                    batch.set(catRef, cat);
                });
                await batch.commit();
            }

            // Real-time listeners
            const unsubCategories = onSnapshot(collection(db, `users/${userId}/categories`), (snapshot) => {
                categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (window.location.hash.substring(1) === 'categories' || window.location.hash.substring(1) === 'budget') {
                    rerenderCurrentPage();
                }
            });

            const unsubTransactions = onSnapshot(query(collection(db, `users/${userId}/transactions`)), (snapshot) => {
                transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                transactions.sort((a, b) => b.date.toMillis() - a.date.toMillis());
                rerenderCurrentPage();
            });

            const unsubBudgets = onSnapshot(collection(db, `users/${userId}/budgets`), (snapshot) => {
                budgets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (window.location.hash.substring(1) === 'budget') {
                    rerenderCurrentPage();
                }
            });

            const unsubGoals = onSnapshot(collection(db, `users/${userId}/goals`), (snapshot) => {
                goals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 if (window.location.hash.substring(1) === 'goals') {
                    rerenderCurrentPage();
                }
            });

            unsubscribeListeners.push(unsubCategories, unsubTransactions, unsubBudgets, unsubGoals);
        };

        const rerenderCurrentPage = () => {
            const currentPage = window.location.hash.substring(1) || 'dashboard';
            loadPage(currentPage, false); // false to prevent history push
        };

        /**
         * Loads a page into the main content area.
         * @param {string} pageName - The key of the page in the 'pages' object.
         * @param {boolean} addToHistory - Whether to add this to browser history.
         */
        const loadPage = (pageName, addToHistory = true) => {
            if (!pages[pageName]) {
                pageName = 'dashboard';
            }
            pageContentArea.innerHTML = pages[pageName];
            
            const title = pageName.charAt(0).toUpperCase() + pageName.slice(1).replace('-', ' ');
            pageTitle.textContent = title === 'Ai tools' ? 'AI Assistant' : title;
            
            if (addToHistory) {
                window.location.hash = pageName;
            }
            
            // Call the specific render function for the page
            const renderFunctionName = `render${pageName.charAt(0).toUpperCase() + pageName.slice(1).replace(/-(\w)/g, (g) => g[1].toUpperCase())}Page`;
            if (window[renderFunctionName]) {
                window[renderFunctionName]();
            }
        };

        // --- Page Render Functions ---

        window.renderDashboardPage = () => {
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

            const thisMonthTransactions = transactions.filter(t => t.date.toDate() >= startOfMonth);
            
            const totalIncome = transactions.reduce((sum, t) => sum + (t.type === 'income' ? t.amount : 0), 0);
            const totalExpense = transactions.reduce((sum, t) => sum + (t.type === 'expense' ? t.amount : 0), 0);
            const thisMonthIncome = thisMonthTransactions.reduce((sum, t) => sum + (t.type === 'income' ? t.amount : 0), 0);
            const thisMonthExpense = thisMonthTransactions.reduce((sum, t) => sum + (t.type === 'expense' ? t.amount : 0), 0);

            document.getElementById('dashboard-balance').textContent = formatCurrency(totalIncome - totalExpense);
            document.getElementById('dashboard-income').textContent = formatCurrency(thisMonthIncome);
            document.getElementById('dashboard-expense').textContent = formatCurrency(thisMonthExpense);
            
            renderRecentTransactions();
            initExpenseChart(thisMonthTransactions);
            initIncomeVsExpenseChart();
        };
        
        const renderRecentTransactions = () => {
            const listEl = document.getElementById('recent-transactions-list');
            const recent = transactions.slice(0, 5);
            if (recent.length === 0) {
                listEl.innerHTML = `<p class="text-gray-500 text-center">No transactions yet. Add one to get started!</p>`;
                return;
            }
            listEl.innerHTML = recent.map(t => {
                const category = categories.find(c => c.name === t.category) || {icon: 'fa-question-circle', name: 'Uncategorized'};
                const isIncome = t.type === 'income';
                return `
                    <div class="flex items-center justify-between p-3 rounded-lg bg-gray-50 dark:bg-gray-700/50">
                        <div class="flex items-center">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center ${isIncome ? 'bg-blue-100 text-blue-500' : 'bg-red-100 text-red-500'}">
                                <i class="fas ${category.icon}"></i>
                            </div>
                            <div class="ml-4">
                                <p class="font-semibold">${t.description}</p>
                                <p class="text-sm text-gray-500">${formatDateReadable(t.date)}</p>
                            </div>
                        </div>
                        <p class="font-bold ${isIncome ? 'text-green-600' : 'text-red-600'}">${isIncome ? '+' : '-'}${formatCurrency(t.amount)}</p>
                    </div>
                `;
            }).join('');
        };
        
        const initExpenseChart = (data) => {
            const ctx = document.getElementById('expense-chart')?.getContext('2d');
            if (!ctx) return;

            const expenseData = data.filter(t => t.type === 'expense');
            const spendingByCategory = expenseData.reduce((acc, t) => {
                acc[t.category] = (acc[t.category] || 0) + t.amount;
                return acc;
            }, {});

            const labels = Object.keys(spendingByCategory);
            const values = Object.values(spendingByCategory);
            
            const chartColors = ['#4f46e5', '#ec4899', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ef4444'];

            if(expenseChart) expenseChart.destroy();
            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.length > 0 ? labels : ['No expenses this month'],
                    datasets: [{
                        data: values.length > 0 ? values : [1],
                        backgroundColor: labels.length > 0 ? chartColors : ['#e5e7eb'],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        };
        
        const initIncomeVsExpenseChart = () => {
            const ctx = document.getElementById('income-expense-chart')?.getContext('2d');
            if (!ctx) return;
            
            const labels = [];
            const incomeData = [];
            const expenseData = [];
            const now = new Date();

            for (let i = 5; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                labels.push(d.toLocaleString('default', { month: 'short' }));
                
                const monthStart = new Date(d.getFullYear(), d.getMonth(), 1);
                const monthEnd = new Date(d.getFullYear(), d.getMonth() + 1, 0);

                const monthTransactions = transactions.filter(t => {
                    const tDate = t.date.toDate();
                    return tDate >= monthStart && tDate <= monthEnd;
                });
                
                incomeData.push(monthTransactions.reduce((sum, t) => sum + (t.type === 'income' ? t.amount : 0), 0));
                expenseData.push(monthTransactions.reduce((sum, t) => sum + (t.type === 'expense' ? t.amount : 0), 0));
            }
            
            if(incomeVsExpenseChart) incomeVsExpenseChart.destroy();
            incomeVsExpenseChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Income', data: incomeData, backgroundColor: '#3b82f6' },
                        { label: 'Expense', data: expenseData, backgroundColor: '#ef4444' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { position: 'top' } }
                }
            });
        };

        window.renderTransactionsPage = () => {
            const searchInput = document.getElementById('search-input');
            const filterType = document.getElementById('filter-type');
            
            const renderList = () => {
                const searchTerm = searchInput.value.toLowerCase();
                const typeFilter = filterType.value;
                
                const filtered = transactions.filter(t => {
                    const matchesSearch = t.description.toLowerCase().includes(searchTerm) || t.category.toLowerCase().includes(searchTerm);
                    const matchesType = typeFilter === 'all' || t.type === typeFilter;
                    return matchesSearch && matchesType;
                });

                const container = document.getElementById('transactions-list-container');
                if (filtered.length === 0) {
                    container.innerHTML = `<p class="text-gray-500 text-center">No transactions match your criteria.</p>`;
                    return;
                }
                
                container.innerHTML = filtered.map(t => {
                     const category = categories.find(c => c.name === t.category) || {icon: 'fa-question-circle', name: 'Uncategorized'};
                     const isIncome = t.type === 'income';
                     return `
                        <div class="flex items-center justify-between p-4 rounded-lg bg-gray-50 dark:bg-gray-800 shadow-sm">
                            <div class="flex items-center">
                                <div class="w-12 h-12 rounded-full flex items-center justify-center ${isIncome ? 'bg-blue-100 text-blue-500' : 'bg-red-100 text-red-500'}">
                                    <i class="fas ${category.icon} text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="font-bold">${t.description}</p>
                                    <p class="text-sm text-gray-500">${t.category} • ${formatDateReadable(t.date)}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <p class="font-bold text-lg ${isIncome ? 'text-green-600' : 'text-red-600'}">${isIncome ? '+' : '-'}${formatCurrency(t.amount)}</p>
                                <div>
                                    <button class="edit-transaction-btn text-blue-500 hover:text-blue-700" data-id="${t.id}"><i class="fas fa-edit"></i></button>
                                    <button class="delete-transaction-btn text-red-500 hover:text-red-700 ml-2" data-id="${t.id}"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                     `;
                }).join('');

                document.querySelectorAll('.edit-transaction-btn').forEach(btn => btn.addEventListener('click', (e) => showTransactionModal(e.currentTarget.dataset.id)));
                document.querySelectorAll('.delete-transaction-btn').forEach(btn => btn.addEventListener('click', (e) => deleteTransaction(e.currentTarget.dataset.id)));
            };

            searchInput.addEventListener('input', renderList);
            filterType.addEventListener('change', renderList);
            renderList();
        };

        window.renderCategoriesPage = () => {
            const listEl = document.getElementById('categories-list');
            
            const incomeCats = categories.filter(c => c.type === 'income');
            const expenseCats = categories.filter(c => c.type === 'expense');

            const isDefault = (catName) => defaultCategories.some(dc => dc.name === catName);

            const renderCategoryList = (title, cats) => `
                <h3 class="font-semibold text-lg mb-2">${title}</h3>
                ${cats.length > 0 ? cats.map(c => `
                    <div class="flex justify-between items-center p-2 rounded bg-gray-100 dark:bg-gray-700">
                        <span><i class="fas ${c.icon} w-6 text-center"></i> ${c.name}</span>
                        ${!isDefault(c.name) ? `<button class="delete-category-btn text-red-500 hover:text-red-700" data-id="${c.id}"><i class="fas fa-times-circle"></i></button>` : ''}
                    </div>
                `).join('') : '<p class="text-sm text-gray-500">No categories.</p>'}
            `;
            
            listEl.innerHTML = `
                <div class="mb-4">${renderCategoryList('Income', incomeCats)}</div>
                <div>${renderCategoryList('Expense', expenseCats)}</div>
            `;
            
            document.querySelectorAll('.delete-category-btn').forEach(btn => {
                btn.addEventListener('click', (e) => deleteCategory(e.currentTarget.dataset.id));
            });

            document.getElementById('add-category-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('category-name').value.trim();
                const type = document.getElementById('category-type').value;
                const icon = document.getElementById('category-icon').value.trim();
                if(name && type && icon) {
                    addCategory({name, type, icon});
                    e.target.reset();
                }
            });
        };
        
        window.renderBudgetPage = () => {
            const listEl = document.getElementById('budget-list');
            const expenseCategories = categories.filter(c => c.type === 'expense');
            
            if(expenseCategories.length === 0) {
                 listEl.innerHTML = `<p class="text-gray-500">Add an expense category first to set a budget.</p>`;
                 return;
            }

            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const thisMonthExpenses = transactions.filter(t => t.type === 'expense' && t.date.toDate() >= startOfMonth);

            listEl.innerHTML = expenseCategories.map(cat => {
                const budget = budgets.find(b => b.categoryId === cat.id);
                const spent = thisMonthExpenses.filter(t => t.category === cat.name).reduce((sum, t) => sum + t.amount, 0);
                const budgetAmount = budget ? budget.amount : 0;
                const progress = budgetAmount > 0 ? Math.min((spent / budgetAmount) * 100, 100) : 0;
                
                let progressColor = 'bg-green-500';
                if (progress > 75) progressColor = 'bg-yellow-500';
                if (progress >= 100) progressColor = 'bg-red-500';

                return `
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold">${cat.name}</span>
                            <span>${formatCurrency(spent)} / ${budgetAmount > 0 ? formatCurrency(budgetAmount) : 'Not set'}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4 dark:bg-gray-700">
                            <div class="${progressColor} h-4 rounded-full" style="width: ${progress}%"></div>
                        </div>
                        <div class="text-right mt-2">
                            <input type="number" class="budget-input p-1 border rounded w-32" placeholder="Set Budget" data-category-id="${cat.id}" data-category-name="${cat.name}" value="${budgetAmount > 0 ? budgetAmount : ''}">
                            <button class="set-budget-btn btn-secondary py-1 px-2 ml-2" data-category-id="${cat.id}" data-category-name="${cat.name}">Set</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.querySelectorAll('.set-budget-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const catId = e.currentTarget.dataset.categoryId;
                    const catName = e.currentTarget.dataset.categoryName;
                    const input = document.querySelector(`.budget-input[data-category-id="${catId}"]`);
                    const amount = parseFloat(input.value);
                    if (!isNaN(amount) && amount >= 0) {
                        setBudget({ categoryId: catId, categoryName: catName, amount });
                    } else {
                        Swal.fire('Invalid Amount', 'Please enter a valid positive number for the budget.', 'error');
                    }
                });
            });
        };

        window.renderGoalsPage = () => {
            const listEl = document.getElementById('goals-list');
            if (goals.length === 0) {
                listEl.innerHTML = `<p class="text-gray-500 col-span-full text-center">No financial goals set yet. Add one to get started!</p>`;
                return;
            }
            
            listEl.innerHTML = goals.map(goal => {
                const progress = goal.targetAmount > 0 ? Math.min((goal.currentAmount / goal.targetAmount) * 100, 100) : 0;
                const remaining = Math.max(0, goal.targetAmount - goal.currentAmount);

                return `
                    <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg shadow">
                        <div class="flex justify-between items-start">
                             <h3 class="font-bold text-lg">${goal.name}</h3>
                             <div>
                                <button class="edit-goal-btn text-blue-500 hover:text-blue-700" data-id="${goal.id}"><i class="fas fa-edit"></i></button>
                                <button class="delete-goal-btn text-red-500 hover:text-red-700 ml-2" data-id="${goal.id}"><i class="fas fa-trash"></i></button>
                             </div>
                        </div>
                        <p class="text-sm text-gray-500 mb-2">Target: ${formatCurrency(goal.targetAmount)}</p>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700 mb-1">
                            <div class="bg-indigo-600 h-2.5 rounded-full" style="width: ${progress}%"></div>
                        </div>
                         <div class="flex justify-between text-sm">
                            <span>${formatCurrency(goal.currentAmount)}</span>
                            <span>${Math.round(progress)}%</span>
                        </div>
                        <p class="text-sm text-red-500 mt-1">Remaining: ${formatCurrency(remaining)}</p>
                    </div>
                `;
            }).join('');
            
            document.querySelectorAll('.edit-goal-btn').forEach(btn => btn.addEventListener('click', (e) => showGoalModal(e.currentTarget.dataset.id)));
            document.querySelectorAll('.delete-goal-btn').forEach(btn => btn.addEventListener('click', (e) => deleteGoal(e.currentTarget.dataset.id)));
            
            document.getElementById('add-goal-form').addEventListener('submit', e => {
                e.preventDefault();
                const name = document.getElementById('goal-name').value;
                const targetAmount = parseFloat(document.getElementById('goal-target').value);
                const currentAmount = parseFloat(document.getElementById('goal-current').value);
                addGoal({ name, targetAmount, currentAmount });
                e.target.reset();
            });
        };
        
        window.renderAiToolsPage = () => {
            document.getElementById('ask-ai-button').addEventListener('click', async () => {
                const promptText = document.getElementById('ai-prompt').value;
                if (!promptText.trim()) {
                    Swal.fire('Empty Prompt', 'Please write a question for the AI assistant.', 'warning');
                    return;
                }

                // Construct a more detailed prompt with user's financial data for better context
                const totalIncome = transactions.reduce((sum, t) => sum + (t.type === 'income' ? t.amount : 0), 0);
                const totalExpense = transactions.reduce((sum, t) => sum + (t.type === 'expense' ? t.amount : 0), 0);
                const recentExpenses = transactions.filter(t => t.type === 'expense').slice(0, 10).map(t => `${t.category}: ${formatCurrency(t.amount)}`).join(', ');

                const fullPrompt = `
                    As a financial assistant for a user of the "I Expanse Tracker" app, provide helpful advice based on the following query.
                    User's financial summary:
                    - Total Lifetime Income: ${formatCurrency(totalIncome)}
                    - Total Lifetime Expense: ${formatCurrency(totalExpense)}
                    - Recent Expenses: ${recentExpenses || 'None'}
                    - Current Financial Goals: ${goals.map(g => `${g.name} (Target: ${formatCurrency(g.targetAmount)})`).join(', ') || 'None'}

                    User's question: "${promptText}"

                    Provide a clear, helpful, and actionable response in Markdown format. If you give a budget plan, use Bangladeshi Taka (৳).
                `;

                Swal.fire({
                    title: 'Thinking... 🧠',
                    text: 'The AI assistant is preparing your answer.',
                    allowOutsideClick: false,
                    didOpen: () => { Swal.showLoading(); }
                });

                const response = await callGeminiAPI(fullPrompt);
                
                Swal.fire({
                    title: '💡 AI Assistant\'s Advice',
                    html: marked.parse(response), // Use marked.js to render Markdown
                    width: '80%',
                    confirmButtonText: 'Great, thanks!'
                });
            });
        };
        
        window.renderReportsPage = () => {
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('start-date').value = formatDate(firstDayOfMonth);
            document.getElementById('end-date').value = formatDate(today);
            
            document.getElementById('generate-pdf-button').addEventListener('click', generatePDF);
        };
        
        window.renderDeveloperPage = () => { /* No JS needed for this static page */ };


        // --- CRUD and other actions ---

        const showTransactionModal = async (id = null) => {
            const transaction = id ? transactions.find(t => t.id === id) : null;
            const isEditing = !!transaction;

            const incomeCategories = categories.filter(c => c.type === 'income').map(c => `<option value="${c.name}" ${transaction?.category === c.name ? 'selected' : ''}>${c.name}</option>`).join('');
            const expenseCategories = categories.filter(c => c.type === 'expense').map(c => `<option value="${c.name}" ${transaction?.category === c.name ? 'selected' : ''}>${c.name}</option>`).join('');
            
            const { value: formValues, isConfirmed } = await Swal.fire({
                title: isEditing ? 'Edit Transaction' : 'Add New Transaction',
                html: `
                    <form id="transaction-form" class="text-left">
                        <select id="swal-type" class="swal2-input">
                            <option value="expense" ${transaction?.type === 'expense' ? 'selected' : ''}>Expense</option>
                            <option value="income" ${transaction?.type === 'income' ? 'selected' : ''}>Income</option>
                        </select>
                        <input id="swal-description" class="swal2-input" placeholder="Description" value="${transaction?.description || ''}">
                        <input id="swal-amount" type="number" class="swal2-input" placeholder="Amount (৳)" value="${transaction?.amount || ''}">
                        <select id="swal-category" class="swal2-input">
                            ${transaction?.type === 'income' ? incomeCategories : expenseCategories}
                        </select>
                        <input id="swal-date" type="date" class="swal2-input" value="${formatDate(transaction?.date) || formatDate(new Date())}">
                    </form>
                `,
                focusConfirm: false,
                didOpen: () => {
                    const typeSelect = document.getElementById('swal-type');
                    const categorySelect = document.getElementById('swal-category');
                    
                    const updateCategories = () => {
                        if (typeSelect.value === 'income') {
                            categorySelect.innerHTML = incomeCategories;
                        } else {
                            categorySelect.innerHTML = expenseCategories;
                        }
                    };
                    
                    typeSelect.addEventListener('change', updateCategories);
                },
                preConfirm: () => {
                    return {
                        type: document.getElementById('swal-type').value,
                        description: document.getElementById('swal-description').value,
                        amount: parseFloat(document.getElementById('swal-amount').value),
                        category: document.getElementById('swal-category').value,
                        date: document.getElementById('swal-date').value,
                    }
                }
            });

            if (isConfirmed && formValues) {
                if (!formValues.description || isNaN(formValues.amount) || !formValues.category || !formValues.date) {
                    Swal.fire('Error', 'Please fill all fields correctly.', 'error');
                    return;
                }
                const data = {
                    ...formValues,
                    date: Timestamp.fromDate(new Date(formValues.date))
                };

                if (isEditing) {
                    await updateDoc(doc(db, `users/${userId}/transactions`, id), data);
                    Swal.fire('Success', 'Transaction updated successfully!', 'success');
                } else {
                    await addDoc(collection(db, `users/${userId}/transactions`), data);
                    Swal.fire('Success', 'Transaction added successfully!', 'success');
                }
            }
        };

        const deleteTransaction = (id) => {
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await deleteDoc(doc(db, `users/${userId}/transactions`, id));
                    Swal.fire('Deleted!', 'Your transaction has been deleted.', 'success');
                }
            });
        };
        
        const addCategory = async (data) => {
            if (categories.some(c => c.name.toLowerCase() === data.name.toLowerCase())) {
                Swal.fire('Error', 'A category with this name already exists.', 'error');
                return;
            }
            await addDoc(collection(db, `users/${userId}/categories`), data);
            Swal.fire('Success', 'Category added!', 'success');
        };

        const deleteCategory = async (id) => {
            // Future improvement: check if category is used in transactions and handle it.
             Swal.fire({
                title: 'Are you sure?',
                text: "Deleting a category cannot be undone.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete it!'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await deleteDoc(doc(db, `users/${userId}/categories`, id));
                    Swal.fire('Deleted!', 'The category has been removed.', 'success');
                }
            });
        };
        
        const setBudget = async (data) => {
            const existingBudget = budgets.find(b => b.categoryId === data.categoryId);
            if (existingBudget) {
                await updateDoc(doc(db, `users/${userId}/budgets`, existingBudget.id), { amount: data.amount });
            } else {
                await addDoc(collection(db, `users/${userId}/budgets`), data);
            }
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: `Budget for ${data.categoryName} set successfully`,
                showConfirmButton: false,
                timer: 2000
            });
        };
        
        const addGoal = async (data) => {
            if (!data.name || isNaN(data.targetAmount) || isNaN(data.currentAmount)) {
                Swal.fire('Error', 'Please fill all fields correctly.', 'error');
                return;
            }
            await addDoc(collection(db, `users/${userId}/goals`), data);
            Swal.fire('Success', 'Financial goal added!', 'success');
        };
        
        const showGoalModal = async (id) => {
            const goal = goals.find(g => g.id === id);
            if (!goal) return;
            
             const { value: formValues, isConfirmed } = await Swal.fire({
                title: 'Edit Financial Goal',
                html: `
                    <form id="goal-form" class="text-left">
                        <label for="swal-goal-name">Goal Name</label>
                        <input id="swal-goal-name" class="swal2-input" value="${goal.name}">
                        <label for="swal-goal-target">Target Amount</label>
                        <input id="swal-goal-target" type="number" class="swal2-input" value="${goal.targetAmount}">
                        <label for="swal-goal-current">Current Savings</label>
                        <input id="swal-goal-current" type="number" class="swal2-input" value="${goal.currentAmount}">
                    </form>
                `,
                focusConfirm: false,
                preConfirm: () => ({
                    name: document.getElementById('swal-goal-name').value,
                    targetAmount: parseFloat(document.getElementById('swal-goal-target').value),
                    currentAmount: parseFloat(document.getElementById('swal-goal-current').value),
                })
            });

            if (isConfirmed && formValues) {
                if (!formValues.name || isNaN(formValues.targetAmount) || isNaN(formValues.currentAmount)) {
                    Swal.fire('Error', 'Please fill all fields correctly.', 'error');
                    return;
                }
                await updateDoc(doc(db, `users/${userId}/goals`, id), formValues);
                Swal.fire('Success', 'Goal updated successfully!', 'success');
            }
        };

        const deleteGoal = async (id) => {
             Swal.fire({
                title: 'Are you sure?',
                text: "This will permanently delete your financial goal.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete it!'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await deleteDoc(doc(db, `users/${userId}/goals`, id));
                    Swal.fire('Deleted!', 'Your goal has been deleted.', 'success');
                }
            });
        };
        
        const generatePDF = async () => {
            const startDate = new Date(document.getElementById('start-date').value);
            const endDate = new Date(document.getElementById('end-date').value);
            endDate.setHours(23, 59, 59, 999); // Include the whole end day

            if (isNaN(startDate) || isNaN(endDate)) {
                Swal.fire('Error', 'Please select a valid date range.', 'error');
                return;
            }
            
            Swal.fire({
                title: 'Generating Report...',
                text: 'Please wait while we prepare your PDF.',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading() }
            });

            const reportTransactions = transactions.filter(t => {
                const tDate = t.date.toDate();
                return tDate >= startDate && tDate <= endDate;
            });

            const reportIncome = reportTransactions.reduce((sum, t) => sum + (t.type === 'income' ? t.amount : 0), 0);
            const reportExpense = reportTransactions.reduce((sum, t) => sum + (t.type === 'expense' ? t.amount : 0), 0);
            const reportNet = reportIncome - reportExpense;

            // Populate hidden template
            document.getElementById('pdf-report-range').textContent = `${formatDateReadable(startDate)} to ${formatDateReadable(endDate)}`;
            document.getElementById('pdf-report-summary').innerHTML = `
                <div class="p-4 bg-blue-100 rounded-lg"><h4 class="font-bold">Total Income</h4><p class="text-xl">${formatCurrency(reportIncome)}</p></div>
                <div class="p-4 bg-red-100 rounded-lg"><h4 class="font-bold">Total Expense</h4><p class="text-xl">${formatCurrency(reportExpense)}</p></div>
                <div class="p-4 ${reportNet >= 0 ? 'bg-green-100' : 'bg-yellow-100'} rounded-lg"><h4 class="font-bold">Net Savings</h4><p class="text-xl">${formatCurrency(reportNet)}</p></div>
            `;
            document.getElementById('pdf-report-table-body').innerHTML = reportTransactions.map(t => `
                <tr class="border-b">
                    <td class="p-2 border">${formatDate(t.date)}</td>
                    <td class="p-2 border">${t.description}</td>
                    <td class="p-2 border">${t.category}</td>
                    <td class="p-2 border">${t.type.charAt(0).toUpperCase() + t.type.slice(1)}</td>
                    <td class="p-2 border text-right">${formatCurrency(t.amount)}</td>
                </tr>
            `).join('');
            document.getElementById('pdf-generation-date').textContent = new Date().toLocaleString();

            const { jsPDF } = window.jspdf;
            const pdfTemplate = document.getElementById('pdf-report-template');
            pdfTemplate.classList.remove('hidden');

            try {
                const canvas = await html2canvas(pdfTemplate.firstElementChild, { scale: 2 });
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'px',
                    format: [canvas.width, canvas.height]
                });
                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                pdf.save(`I-Expanse-Report-${formatDate(new Date())}.pdf`);
                Swal.close();
            } catch (error) {
                console.error("PDF generation error: ", error);
                Swal.fire('Error', 'Could not generate PDF. Please try again.', 'error');
            } finally {
                pdfTemplate.classList.add('hidden');
            }
        };

        // --- Event Listeners Setup ---
        const setupEventListeners = () => {
            // Navigation
            document.querySelectorAll('#sidebar nav a').forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    const pageName = e.currentTarget.id.replace('nav-', '');
                    loadPage(pageName);
                    // Hide sidebar on mobile after click
                    if(window.innerWidth < 1024) {
                        document.getElementById('sidebar').classList.add('sidebar-hidden');
                        document.getElementById('sidebar-overlay').classList.add('hidden');
                    }
                });
            });

            // Header "Add Transaction" button
            document.getElementById('add-transaction-button-header').addEventListener('click', () => showTransactionModal());

            // Sidebar toggle
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const toggleButton = document.getElementById('sidebar-toggle');
            
            const toggleSidebar = () => {
                sidebar.classList.toggle('sidebar-hidden');
                sidebarOverlay.classList.toggle('hidden');
            };
            
            toggleButton.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);

            // Dark/Light theme toggle
            const themeToggle = document.getElementById('theme-toggle');
            themeToggle.addEventListener('change', () => {
                document.documentElement.classList.toggle('dark', themeToggle.checked);
                localStorage.setItem('theme', themeToggle.checked ? 'dark' : 'light');
                 rerenderCurrentPage(); // Re-render to apply chart colors
            });
            // Check for saved theme
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                themeToggle.checked = true;
                document.documentElement.classList.add('dark');
            } else {
                 document.documentElement.classList.remove('dark');
            }

            // Handle browser back/forward buttons
            window.addEventListener('popstate', () => {
                const pageName = window.location.hash.substring(1) || 'dashboard';
                loadPage(pageName, false);
            });
        };
        
        // --- Authentication ---
        onAuthStateChanged(auth, user => {
            if (user) {
                // User is signed in.
                userId = user.uid;
                initApp();
            } else {
                // User is signed out. Sign in anonymously.
                setPersistence(auth, browserLocalPersistence)
                    .then(() => {
                        return signInAnonymously(auth);
                    })
                    .catch(error => {
                        console.error("Anonymous sign-in failed:", error);
                        document.body.innerHTML = `<div class="p-8 text-center text-red-500">Authentication failed. Please refresh the page or check your browser settings.</div>`;
                    });
            }
        });

    </script>
</body>
</html>