<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I Expanse Tracker - Md Habibur Rahman Mahi</title>
    
    <!-- App Icon -->
    <link rel="icon" href="https://i.ibb.co/9vXy2pX/image-4.png" type="image/png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- jsPDF and html2canvas for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- SweetAlert2 for beautiful modals -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .infinity-icon {
            font-size: 2rem;
            color: #4f46e5;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        /* Sidebar transition */
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-hidden {
            transform: translateX(-100%);
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .main-content {
            transition: margin-left 0.3s ease-in-out;
        }
        /* Glassmorphism effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            @apply bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300;
        }
        .btn-secondary {
            @apply bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-300 transition duration-300;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center z-[100]">
        <div class="text-white text-center">
            <img src="https://i.ibb.co/9vXy2pX/image-4.png" alt="App Logo" class="w-24 h-24 mx-auto mb-4 animate-bounce">
            <h1 class="text-4xl font-bold">I Expanse Tracker</h1>
            <p class="mt-4 text-lg">Developed by:</p>
            <p class="text-2xl font-semibold">Md Habibur Rahman Mahi</p>
            <p class="text-md">Founder and CEO of Infinity Group</p>
            <div class="mt-8">
                <i class="fas fa-spinner fa-spin text-3xl"></i>
            </div>
        </div>
    </div>

    <!-- Main Application Wrapper -->
    <div id="app-wrapper" class="hidden">
        <!-- Sidebar Navigation -->
        <div id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-white shadow-lg z-40 sidebar-hidden">
            <div class="p-6 text-center border-b">
                <img src="https://i.ibb.co/9vXy2pX/image-4.png" alt="App Logo" class="w-16 h-16 mx-auto mb-2">
                <h2 class="text-xl font-bold text-indigo-600">I Expanse Tracker</h2>
            </div>
            <nav class="mt-6">
                <a href="#" id="nav-dashboard" class="flex items-center px-6 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600">
                    <i class="fas fa-tachometer-alt w-6"></i><span class="ml-4">Dashboard</span>
                </a>
                <a href="#" id="nav-transactions" class="flex items-center px-6 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600">
                    <i class="fas fa-exchange-alt w-6"></i><span class="ml-4">Transactions</span>
                </a>
                <a href="#" id="nav-reports" class="flex items-center px-6 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600">
                    <i class="fas fa-file-pdf w-6"></i><span class="ml-4">Reports</span>
                </a>
                <a href="#" id="nav-categories" class="flex items-center px-6 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600">
                    <i class="fas fa-tags w-6"></i><span class="ml-4">Categories</span>
                </a>
                <a href="#" id="nav-budget" class="flex items-center px-6 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600">
                    <i class="fas fa-bullseye w-6"></i><span class="ml-4">Budget</span>
                </a>
                 <a href="#" id="nav-goals" class="flex items-center px-6 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600">
                    <i class="fas fa-flag-checkered w-6"></i><span class="ml-4">Financial Goals</span>
                </a>
                <a href="#" id="nav-developer" class="flex items-center px-6 py-3 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600">
                    <i class="fas fa-user-tie w-6"></i><span class="ml-4">Developer</span>
                </a>
            </nav>
            <div class="absolute bottom-4 left-0 w-full px-6">
                <div class="flex justify-center space-x-4">
                    <label for="theme-toggle" class="flex items-center cursor-pointer">
                        <div class="relative">
                            <input type="checkbox" id="theme-toggle" class="sr-only">
                            <div class="block bg-gray-600 w-14 h-8 rounded-full"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
                        </div>
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Overlay for sidebar on mobile -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black opacity-50 z-30 hidden"></div>

        <!-- Main Content -->
        <div id="main-content" class="relative min-h-screen">
            <!-- Header -->
            <header class="sticky top-0 bg-white/80 backdrop-blur-sm shadow-sm p-4 z-20 flex justify-between items-center">
                <button id="sidebar-toggle" class="text-2xl text-indigo-600">
                    <i class="fas fa-infinity"></i>
                </button>
                <h1 id="page-title" class="text-xl font-bold text-gray-800">Dashboard</h1>
                <button id="add-transaction-button-header" class="btn-primary flex items-center">
                    <i class="fas fa-plus mr-2"></i> <span class="hidden sm:inline">Add Transaction</span>
                </button>
            </header>

            <!-- Page Content -->
            <main class="p-4 sm:p-6">
                <div id="page-content-area">
                    <!-- Content will be loaded here by JavaScript -->
                </div>
            </main>

            <!-- Footer -->
            <footer class="text-center p-4 text-gray-600 mt-8">
                <p>&copy; <span id="current-year"></span> I Expanse Tracker. Developed by Md Habibur Rahman Mahi.</p>
            </footer>
        </div>
    </div>
    
    <!-- PDF Report Generation Template (Hidden) -->
    <div id="pdf-report-template" class="hidden">
        <div class="p-8 bg-white text-gray-800">
            <div class="flex justify-between items-start border-b-2 border-indigo-500 pb-4 mb-4">
                <div>
                    <img src="https://i.ibb.co/9vXy2pX/image-4.png" alt="App Logo" class="w-20 h-20">
                    <h1 class="text-3xl font-bold text-indigo-600 mt-2">I Expanse Tracker</h1>
                    <p class="text-gray-500">Your Personal Finance Companion</p>
                </div>
                <div class="text-right">
                    <img src="https://i.ibb.co/L5B7P4V/Picsart-24-12-22-22-58-18-749.png" alt="Developer" class="w-24 h-24 rounded-full border-4 border-indigo-300 ml-auto">
                    <h2 class="text-xl font-bold mt-2">Md Habibur Rahman Mahi</h2>
                    <p class="text-sm text-gray-600">Founder and CEO of Infinity Group</p>
                </div>
            </div>
            <div class="text-center my-6">
                <h2 class="text-2xl font-semibold">Financial Report</h2>
                <p id="pdf-report-range" class="text-gray-600"></p>
            </div>
            <div id="pdf-report-summary" class="grid grid-cols-3 gap-4 my-6 text-center">
                <!-- Summary will be injected here -->
            </div>
            <h3 class="text-xl font-semibold mb-4">Transaction Details</h3>
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-indigo-100">
                        <th class="p-2 border">Date</th>
                        <th class="p-2 border">Description</th>
                        <th class="p-2 border">Category</th>
                        <th class="p-2 border">Type</th>
                        <th class="p-2 border text-right">Amount (৳)</th>
                    </tr>
                </thead>
                <tbody id="pdf-report-table-body">
                    <!-- Transaction rows will be injected here -->
                </tbody>
            </table>
            <div class="mt-8 text-center text-xs text-gray-500">
                <p>Generated on: <span id="pdf-generation-date"></span></p>
                <p>This is a computer-generated report.</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, onSnapshot, query, where, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'i-expanse-tracker-app';
        
        // --- Firebase Initialization ---
        let app, auth, db, userId;

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.body.innerHTML = `<div class="p-8 text-center text-red-500">Failed to connect to the database. Please check the console for errors.</div>`;
        }
        
        // --- Global State ---
        let transactions = [];
        let categories = [];
        let budgets = [];
        let goals = [];
        let expenseChart = null;
        let incomeVsExpenseChart = null;

        // --- Default Categories ---
        const defaultCategories = [
            { name: 'Salary', type: 'income', icon: 'fa-money-bill-wave' },
            { name: 'Business', type: 'income', icon: 'fa-briefcase' },
            { name: 'Gifts', type: 'income', icon: 'fa-gift' },
            { name: 'Food', type: 'expense', icon: 'fa-utensils' },
            { name: 'Transport', type: 'expense', icon: 'fa-bus' },
            { name: 'Housing', type: 'expense', icon: 'fa-home' },
            { name: 'Bills', type: 'expense', icon: 'fa-file-invoice-dollar' },
            { name: 'Health', type: 'expense', icon: 'fa-heartbeat' },
            { name: 'Education', type: 'expense', icon: 'fa-graduation-cap' },
            { name: 'Shopping', type: 'expense', icon: 'fa-shopping-cart' },
            { name: 'Entertainment', type: 'expense', icon: 'fa-film' },
            { name: 'Others', type: 'expense', icon: 'fa-ellipsis-h' }
        ];

        // --- UI Elements ---
        const pageContentArea = document.getElementById('page-content-area');
        const pageTitle = document.getElementById('page-title');

        // --- Helper Functions ---
        const formatCurrency = (amount) => `৳ ${parseFloat(amount).toFixed(2)}`;
        const formatDate = (date) => new Date(date).toLocaleDateString('en-CA'); // YYYY-MM-DD

        // --- Page Templates ---
        const pages = {
            dashboard: `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="glass-card p-6 text-center">
                        <h3 class="text-lg font-semibold text-gray-600">Current Balance</h3>
                        <p id="dashboard-balance" class="text-3xl font-bold text-green-600 mt-2">৳ 0.00</p>
                    </div>
                    <div class="glass-card p-6 text-center">
                        <h3 class="text-lg font-semibold text-gray-600">Total Income (This Month)</h3>
                        <p id="dashboard-income" class="text-3xl font-bold text-blue-600 mt-2">৳ 0.00</p>
                    </div>
                    <div class="glass-card p-6 text-center">
                        <h3 class="text-lg font-semibold text-gray-600">Total Expense (This Month)</h3>
                        <p id="dashboard-expense" class="text-3xl font-bold text-red-600 mt-2">৳ 0.00</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="font-bold text-lg mb-4">Expense Breakdown</h3>
                        <canvas id="expense-chart"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="font-bold text-lg mb-4">Income vs Expense (Last 6 Months)</h3>
                        <canvas id="income-expense-chart"></canvas>
                    </div>
                </div>
                 <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="font-bold text-lg mb-4">Recent Transactions</h3>
                    <div id="recent-transactions-list" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Recent transactions will be listed here -->
                    </div>
                </div>
            `,
            transactions: `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                        <h2 class="text-2xl font-bold">All Transactions</h2>
                        <div class="flex items-center gap-2">
                            <input type="text" id="search-input" placeholder="Search..." class="p-2 border rounded-lg">
                            <select id="filter-type" class="p-2 border rounded-lg">
                                <option value="all">All Types</option>
                                <option value="income">Income</option>
                                <option value="expense">Expense</option>
                            </select>
                        </div>
                    </div>
                    <div id="transactions-list" class="space-y-4"></div>
                </div>
            `,
            reports: `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Generate Report</h2>
                    <div class="flex flex-wrap gap-4 items-end">
                        <div>
                            <label for="start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
                            <input type="date" id="start-date" class="mt-1 p-2 border rounded-lg w-full">
                        </div>
                        <div>
                            <label for="end-date" class="block text-sm font-medium text-gray-700">End Date</label>
                            <input type="date" id="end-date" class="mt-1 p-2 border rounded-lg w-full">
                        </div>
                        <button id="generate-pdf-button" class="btn-primary">
                            <i class="fas fa-file-pdf mr-2"></i>Generate PDF
                        </button>
                    </div>
                </div>
            `,
            categories: `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Manage Categories</h2>
                        <button id="add-category-button" class="btn-primary"><i class="fas fa-plus mr-2"></i>Add Category</button>
                    </div>
                    <div id="categories-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
                </div>
            `,
            budget: `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Monthly Budgets</h2>
                    <div id="budget-list" class="space-y-4"></div>
                </div>
            `,
            goals: `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Financial Goals</h2>
                        <button id="add-goal-button" class="btn-primary"><i class="fas fa-plus mr-2"></i>Set New Goal</button>
                    </div>
                    <div id="goals-list" class="space-y-4"></div>
                </div>
            `,
            developer: `
                <div class="bg-white p-8 rounded-lg shadow-lg text-center">
                    <img src="https://i.ibb.co/L5B7P4V/Picsart-24-12-22-22-58-18-749.png" alt="Md Habibur Rahman Mahi" class="w-40 h-40 rounded-full mx-auto border-4 border-indigo-500 shadow-xl">
                    <h2 class="text-3xl font-bold mt-6">Md Habibur Rahman Mahi</h2>
                    <p class="text-indigo-600 font-semibold text-lg">Founder and CEO of Infinity Group</p>
                    <p class="max-w-2xl mx-auto mt-4 text-gray-600">
                        A passionate developer and entrepreneur dedicated to creating innovative solutions that make a difference. Infinity Group is committed to pushing the boundaries of technology.
                    </p>
                    <div class="mt-8 flex justify-center items-center space-x-6 text-3xl">
                        <a href="https://wa.me/8801727722018" target="_blank" class="text-green-500 hover:text-green-600 transition-colors"><i class="fab fa-whatsapp-square"></i></a>
                        <a href="https://t.me/hr_mahi" target="_blank" class="text-blue-400 hover:text-blue-500 transition-colors"><i class="fab fa-telegram"></i></a>
                        <a href="https://www.instagram.com/h.r_mahi_?igsh=Z242dWFtcDZwdjF2" target="_blank" class="text-pink-500 hover:text-pink-600 transition-colors"><i class="fab fa-instagram-square"></i></a>
                        <a href="https://www.facebook.com/share/1L8yaf25bk/" target="_blank" class="text-blue-600 hover:text-blue-700 transition-colors"><i class="fab fa-facebook-square"></i></a>
                    </div>
                     <div class="mt-6 text-sm text-gray-500">
                        <p>WhatsApp & Telegram: <strong>01727722018</strong></p>
                    </div>
                </div>
            `
        };

        // --- Router/Page Loader ---
        const loadPage = (page) => {
            if (!pages[page]) {
                console.error(`Page "${page}" not found.`);
                return;
            }
            pageTitle.textContent = page.charAt(0).toUpperCase() + page.slice(1);
            pageContentArea.innerHTML = pages[page];

            // Run page-specific logic
            switch (page) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'transactions':
                    renderTransactionsList();
                    document.getElementById('search-input').addEventListener('input', renderTransactionsList);
                    document.getElementById('filter-type').addEventListener('change', renderTransactionsList);
                    break;
                case 'reports':
                    document.getElementById('generate-pdf-button').addEventListener('click', generatePDF);
                    break;
                case 'categories':
                    renderCategories();
                    document.getElementById('add-category-button').addEventListener('click', () => showCategoryModal());
                    break;
                case 'budget':
                    renderBudgets();
                    break;
                case 'goals':
                    renderGoals();
                    document.getElementById('add-goal-button').addEventListener('click', () => showGoalModal());
                    break;
                case 'developer':
                    // No dynamic content
                    break;
            }
        };

        // --- Render Functions ---
        const renderDashboard = () => {
            const now = new Date();
            const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            
            const monthTransactions = transactions.filter(t => new Date(t.date) >= firstDayOfMonth);
            
            const totalIncome = transactions.reduce((sum, t) => t.type === 'income' ? sum + t.amount : sum, 0);
            const totalExpense = transactions.reduce((sum, t) => t.type === 'expense' ? sum + t.amount : sum, 0);
            const monthIncome = monthTransactions.reduce((sum, t) => t.type === 'income' ? sum + t.amount : sum, 0);
            const monthExpense = monthTransactions.reduce((sum, t) => t.type === 'expense' ? sum + t.amount : sum, 0);

            document.getElementById('dashboard-balance').textContent = formatCurrency(totalIncome - totalExpense);
            document.getElementById('dashboard-income').textContent = formatCurrency(monthIncome);
            document.getElementById('dashboard-expense').textContent = formatCurrency(monthExpense);
            
            renderExpenseChart(monthTransactions);
            renderIncomeVsExpenseChart();
            renderRecentTransactions();
        };

        const renderRecentTransactions = () => {
            const listEl = document.getElementById('recent-transactions-list');
            const recent = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
            if (recent.length === 0) {
                listEl.innerHTML = `<p class="text-gray-500 text-center">No recent transactions.</p>`;
                return;
            }
            listEl.innerHTML = recent.map(t => createTransactionItemHTML(t)).join('');
        };
        
        const renderTransactionsList = () => {
            const listEl = document.getElementById('transactions-list');
            const searchVal = document.getElementById('search-input').value.toLowerCase();
            const filterType = document.getElementById('filter-type').value;

            const filtered = transactions
                .filter(t => {
                    const descriptionMatch = t.description.toLowerCase().includes(searchVal);
                    const categoryMatch = t.category.toLowerCase().includes(searchVal);
                    const typeMatch = filterType === 'all' || t.type === filterType;
                    return (descriptionMatch || categoryMatch) && typeMatch;
                })
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filtered.length === 0) {
                listEl.innerHTML = `<p class="text-gray-500 text-center py-8">No transactions found.</p>`;
                return;
            }
            listEl.innerHTML = filtered.map(t => createTransactionItemHTML(t)).join('');
            
            document.querySelectorAll('.edit-transaction').forEach(btn => btn.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                showTransactionModal(transactions.find(t => t.id === id));
            }));
            document.querySelectorAll('.delete-transaction').forEach(btn => btn.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                deleteTransaction(id);
            }));
        };
        
        const createTransactionItemHTML = (t) => {
            const isIncome = t.type === 'income';
            const category = categories.find(c => c.name === t.category) || { icon: 'fa-question-circle' };
            return `
                <div class="flex items-center justify-between p-4 rounded-lg bg-gray-50 hover:bg-gray-100">
                    <div class="flex items-center">
                        <div class="w-12 h-12 rounded-full ${isIncome ? 'bg-blue-100 text-blue-600' : 'bg-red-100 text-red-600'} flex items-center justify-center text-xl mr-4">
                            <i class="fas ${category.icon}"></i>
                        </div>
                        <div>
                            <p class="font-bold">${t.description}</p>
                            <p class="text-sm text-gray-500">${t.category} &bull; ${formatDate(t.date)}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-lg ${isIncome ? 'text-blue-600' : 'text-red-600'}">
                            ${isIncome ? '+' : '-'} ${formatCurrency(t.amount)}
                        </p>
                        <div class="text-xs space-x-2 mt-1">
                            <button class="text-indigo-600 hover:underline edit-transaction" data-id="${t.id}">Edit</button>
                            <button class="text-red-600 hover:underline delete-transaction" data-id="${t.id}">Delete</button>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderCategories = () => {
            const listEl = document.getElementById('categories-list');
            listEl.innerHTML = categories.map(c => `
                <div class="p-4 border rounded-lg text-center shadow-sm relative group">
                    <i class="fas ${c.icon} text-3xl ${c.type === 'income' ? 'text-blue-500' : 'text-red-500'}"></i>
                    <p class="mt-2 font-semibold">${c.name}</p>
                    <p class="text-xs text-gray-500 capitalize">${c.type}</p>
                    <div class="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button class="text-xs text-red-500 delete-category" data-id="${c.id}"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
            
            document.querySelectorAll('.delete-category').forEach(btn => btn.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                deleteCategory(id);
            }));
        };
        
        const renderBudgets = () => {
            const listEl = document.getElementById('budget-list');
            const expenseCategories = categories.filter(c => c.type === 'expense');

            if (expenseCategories.length === 0) {
                listEl.innerHTML = `<p class="text-gray-500 text-center">Please add expense categories first.</p>`;
                return;
            }

            listEl.innerHTML = expenseCategories.map(cat => {
                const budget = budgets.find(b => b.category === cat.name);
                const amount = budget ? budget.amount : 0;
                const spent = transactions
                    .filter(t => t.category === cat.name && new Date(t.date).getMonth() === new Date().getMonth())
                    .reduce((sum, t) => sum + t.amount, 0);
                const percentage = amount > 0 ? Math.min((spent / amount) * 100, 100) : 0;
                
                return `
                    <div class="p-4 border rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold">${cat.name}</span>
                            <span class="text-sm">${formatCurrency(spent)} / ${formatCurrency(amount)}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-indigo-600 h-2.5 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                        <div class="text-right mt-2">
                            <button class="text-sm text-indigo-600 hover:underline set-budget-btn" data-category="${cat.name}" data-amount="${amount}">Set Budget</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.querySelectorAll('.set-budget-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const category = e.currentTarget.dataset.category;
                    const currentAmount = e.currentTarget.dataset.amount;
                    showBudgetModal(category, currentAmount);
                });
            });
        };
        
        const renderGoals = () => {
            const listEl = document.getElementById('goals-list');
            if (goals.length === 0) {
                listEl.innerHTML = `<p class="text-gray-500 text-center py-8">No financial goals set yet. Set one to start saving!</p>`;
                return;
            }
            listEl.innerHTML = goals.map(goal => {
                const percentage = goal.targetAmount > 0 ? Math.min((goal.currentAmount / goal.targetAmount) * 100, 100) : 0;
                return `
                    <div class="p-4 border rounded-lg shadow-sm">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold text-lg">${goal.name}</p>
                                <p class="text-sm text-gray-600">Target: ${formatCurrency(goal.targetAmount)}</p>
                            </div>
                            <div class="space-x-2">
                                <button class="text-indigo-600 edit-goal" data-id="${goal.id}"><i class="fas fa-pencil-alt"></i></button>
                                <button class="text-red-500 delete-goal" data-id="${goal.id}"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="mt-2">
                             <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-medium text-gray-700">Progress</span>
                                <span class="text-sm font-medium text-indigo-700">${formatCurrency(goal.currentAmount)} (${percentage.toFixed(1)}%)</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-4">
                                <div class="bg-green-500 h-4 rounded-full text-white text-xs flex items-center justify-center" style="width: ${percentage}%">
                                    ${percentage.toFixed(0)}%
                                </div>
                            </div>
                        </div>
                        <div class="text-right mt-2">
                            <button class="text-sm btn-secondary add-funds-goal" data-id="${goal.id}">Add Funds</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.querySelectorAll('.edit-goal').forEach(btn => btn.addEventListener('click', e => showGoalModal(goals.find(g => g.id === e.currentTarget.dataset.id))));
            document.querySelectorAll('.delete-goal').forEach(btn => btn.addEventListener('click', e => deleteGoal(e.currentTarget.dataset.id)));
            document.querySelectorAll('.add-funds-goal').forEach(btn => btn.addEventListener('click', e => showAddFundsModal(e.currentTarget.dataset.id)));
        };

        // --- Chart Rendering ---
        const renderExpenseChart = (data) => {
            const ctx = document.getElementById('expense-chart')?.getContext('2d');
            if (!ctx) return;

            const expenseData = data.filter(t => t.type === 'expense');
            const spendingByCategory = expenseData.reduce((acc, t) => {
                acc[t.category] = (acc[t.category] || 0) + t.amount;
                return acc;
            }, {});

            const labels = Object.keys(spendingByCategory);
            const values = Object.values(spendingByCategory);

            if (expenseChart) {
                expenseChart.destroy();
            }
            if (labels.length === 0) {
                 ctx.font = "16px Inter";
                 ctx.fillStyle = "#9ca3af";
                 ctx.textAlign = "center";
                 ctx.fillText("No expense data for this month.", ctx.canvas.width / 2, ctx.canvas.height / 2);
                 return;
            }
            
            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Expense by Category',
                        data: values,
                        backgroundColor: [
                            '#ef4444', '#f97316', '#f59e0b', '#eab308', '#84cc16', '#22c55e',
                            '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9', '#3b82f6', '#6366f1'
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                    }
                }
            });
        };
        
        const renderIncomeVsExpenseChart = () => {
            const ctx = document.getElementById('income-expense-chart')?.getContext('2d');
            if (!ctx) return;
            
            const labels = [];
            const incomeData = [];
            const expenseData = [];
            
            for (let i = 5; i >= 0; i--) {
                const d = new Date();
                d.setMonth(d.getMonth() - i);
                labels.push(d.toLocaleString('default', { month: 'short' }));
                
                const monthTransactions = transactions.filter(t => {
                    const tDate = new Date(t.date);
                    return tDate.getMonth() === d.getMonth() && tDate.getFullYear() === d.getFullYear();
                });
                
                incomeData.push(monthTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0));
                expenseData.push(monthTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0));
            }
            
            if (incomeVsExpenseChart) {
                incomeVsExpenseChart.destroy();
            }
            
            incomeVsExpenseChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Income',
                            data: incomeData,
                            backgroundColor: 'rgba(59, 130, 246, 0.5)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Expense',
                            data: expenseData,
                            backgroundColor: 'rgba(239, 68, 68, 0.5)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        };

        // --- Modals ---
        const showTransactionModal = (transaction = null) => {
            const isEdit = transaction !== null;
            const incomeCategories = categories.filter(c => c.type === 'income').map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            const expenseCategories = categories.filter(c => c.type === 'expense').map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            
            Swal.fire({
                title: isEdit ? 'Edit Transaction' : 'Add Transaction',
                html: `
                    <div class="text-left">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Type</label>
                            <select id="swal-type" class="swal2-input">
                                <option value="expense" ${!isEdit || transaction.type === 'expense' ? 'selected' : ''}>Expense</option>
                                <option value="income" ${isEdit && transaction.type === 'income' ? 'selected' : ''}>Income</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Description</label>
                            <input id="swal-description" class="swal2-input" placeholder="e.g., Coffee" value="${isEdit ? transaction.description : ''}">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Amount</label>
                            <input id="swal-amount" type="number" class="swal2-input" placeholder="0.00" value="${isEdit ? transaction.amount : ''}">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Category</label>
                            <select id="swal-category" class="swal2-input">
                                ${isEdit && transaction.type === 'income' ? incomeCategories : expenseCategories}
                            </select>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Date</label>
                            <input id="swal-date" type="date" class="swal2-input" value="${isEdit ? formatDate(transaction.date) : formatDate(new Date())}">
                        </div>
                    </div>
                `,
                confirmButtonText: isEdit ? 'Save Changes' : 'Add',
                showCancelButton: true,
                didOpen: () => {
                    const typeSelect = document.getElementById('swal-type');
                    const categorySelect = document.getElementById('swal-category');
                    if (isEdit) {
                        categorySelect.value = transaction.category;
                    }
                    typeSelect.addEventListener('change', (e) => {
                        categorySelect.innerHTML = e.target.value === 'income' ? incomeCategories : expenseCategories;
                    });
                },
                preConfirm: () => {
                    const type = document.getElementById('swal-type').value;
                    const description = document.getElementById('swal-description').value;
                    const amount = parseFloat(document.getElementById('swal-amount').value);
                    const category = document.getElementById('swal-category').value;
                    const date = document.getElementById('swal-date').value;

                    if (!description || !amount || !category || !date) {
                        Swal.showValidationMessage(`Please fill out all fields`);
                        return false;
                    }
                    if (amount <= 0) {
                        Swal.showValidationMessage(`Amount must be positive`);
                        return false;
                    }

                    const newTransaction = { type, description, amount, category, date };
                    if (isEdit) {
                        updateTransaction(transaction.id, newTransaction);
                    } else {
                        addTransaction(newTransaction);
                    }
                }
            });
        };
        
        const showCategoryModal = () => {
            Swal.fire({
                title: 'Add New Category',
                html: `
                    <input id="swal-cat-name" class="swal2-input" placeholder="Category Name">
                    <input id="swal-cat-icon" class="swal2-input" placeholder="Font Awesome Icon (e.g., fa-car)">
                    <select id="swal-cat-type" class="swal2-input">
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                `,
                confirmButtonText: 'Add Category',
                preConfirm: () => {
                    const name = document.getElementById('swal-cat-name').value;
                    const icon = document.getElementById('swal-cat-icon').value;
                    const type = document.getElementById('swal-cat-type').value;
                    if (!name || !icon) {
                        Swal.showValidationMessage('Please provide a name and icon.');
                        return false;
                    }
                    addCategory({ name, icon, type });
                }
            });
        };
        
        const showBudgetModal = (category, currentAmount) => {
            Swal.fire({
                title: `Set Budget for ${category}`,
                input: 'number',
                inputValue: currentAmount,
                inputLabel: 'Monthly Budget Amount',
                inputPlaceholder: 'Enter budget amount',
                showCancelButton: true,
                confirmButtonText: 'Set Budget',
                preConfirm: (amount) => {
                    if (amount < 0) {
                        Swal.showValidationMessage('Budget cannot be negative.');
                        return false;
                    }
                    setBudget(category, parseFloat(amount));
                }
            });
        };
        
        const showGoalModal = (goal = null) => {
            const isEdit = goal !== null;
            Swal.fire({
                title: isEdit ? 'Edit Goal' : 'Set New Financial Goal',
                html: `
                    <input id="swal-goal-name" class="swal2-input" placeholder="Goal Name (e.g., New Laptop)" value="${isEdit ? goal.name : ''}">
                    <input id="swal-goal-target" type="number" class="swal2-input" placeholder="Target Amount" value="${isEdit ? goal.targetAmount : ''}">
                    ${!isEdit ? '<input id="swal-goal-initial" type="number" class="swal2-input" placeholder="Initial Saved Amount (optional)" value="0">' : ''}
                `,
                confirmButtonText: isEdit ? 'Save Changes' : 'Set Goal',
                preConfirm: () => {
                    const name = document.getElementById('swal-goal-name').value;
                    const targetAmount = parseFloat(document.getElementById('swal-goal-target').value);
                    const currentAmount = isEdit ? goal.currentAmount : parseFloat(document.getElementById('swal-goal-initial').value) || 0;
                    
                    if (!name || !targetAmount) {
                        Swal.showValidationMessage('Please provide a name and target amount.');
                        return false;
                    }
                    if (targetAmount <= 0) {
                        Swal.showValidationMessage('Target amount must be positive.');
                        return false;
                    }
                    
                    const goalData = { name, targetAmount, currentAmount };
                    if (isEdit) {
                        updateGoal(goal.id, goalData);
                    } else {
                        addGoal(goalData);
                    }
                }
            });
        };
        
        const showAddFundsModal = (goalId) => {
            const goal = goals.find(g => g.id === goalId);
            Swal.fire({
                title: `Add Funds to "${goal.name}"`,
                input: 'number',
                inputLabel: 'Amount to add',
                inputPlaceholder: '0.00',
                showCancelButton: true,
                preConfirm: (amount) => {
                    amount = parseFloat(amount);
                    if (amount <= 0) {
                        Swal.showValidationMessage('Amount must be positive.');
                        return false;
                    }
                    const newAmount = goal.currentAmount + amount;
                    updateGoal(goalId, { ...goal, currentAmount: newAmount });
                }
            });
        };

        // --- PDF Generation ---
        const generatePDF = async () => {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            if (!startDate || !endDate) {
                Swal.fire('Error', 'Please select both a start and end date.', 'error');
                return;
            }

            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999); // Include the whole end day

            const filteredTransactions = transactions.filter(t => {
                const tDate = new Date(t.date);
                return tDate >= start && tDate <= end;
            }).sort((a,b) => new Date(a.date) - new Date(b.date));

            if (filteredTransactions.length === 0) {
                Swal.fire('No Data', 'No transactions found in the selected date range.', 'info');
                return;
            }
            
            Swal.fire({
                title: 'Generating PDF...',
                text: 'Please wait a moment.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Populate the hidden template
            document.getElementById('pdf-report-range').textContent = `From ${formatDate(start)} to ${formatDate(end)}`;
            document.getElementById('pdf-generation-date').textContent = new Date().toLocaleString();
            
            const income = filteredTransactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const expense = filteredTransactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            document.getElementById('pdf-report-summary').innerHTML = `
                <div class="p-2 bg-blue-100 rounded">
                    <p class="font-bold text-blue-600">Total Income</p>
                    <p>${formatCurrency(income)}</p>
                </div>
                <div class="p-2 bg-red-100 rounded">
                    <p class="font-bold text-red-600">Total Expense</p>
                    <p>${formatCurrency(expense)}</p>
                </div>
                <div class="p-2 bg-green-100 rounded">
                    <p class="font-bold text-green-600">Net Savings</p>
                    <p>${formatCurrency(income - expense)}</p>
                </div>
            `;
            
            document.getElementById('pdf-report-table-body').innerHTML = filteredTransactions.map(t => `
                <tr>
                    <td class="p-2 border">${formatDate(t.date)}</td>
                    <td class="p-2 border">${t.description}</td>
                    <td class="p-2 border">${t.category}</td>
                    <td class="p-2 border capitalize">${t.type}</td>
                    <td class="p-2 border text-right ${t.type === 'income' ? 'text-blue-600' : 'text-red-600'}">${formatCurrency(t.amount)}</td>
                </tr>
            `).join('');

            const { jsPDF } = window.jspdf;
            const pdfTemplate = document.getElementById('pdf-report-template');
            pdfTemplate.classList.remove('hidden');

            try {
                const canvas = await html2canvas(pdfTemplate, { scale: 2 });
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const ratio = imgWidth / imgHeight;
                const canvasPdfWidth = pdfWidth - 20; // with margin
                const canvasPdfHeight = canvasPdfWidth / ratio;
                
                pdf.addImage(imgData, 'PNG', 10, 10, canvasPdfWidth, canvasPdfHeight);
                pdf.save(`I-Expanse-Report_${startDate}_to_${endDate}.pdf`);
                Swal.close();
                Swal.fire('Success!', 'Your PDF report has been generated.', 'success');
            } catch (error) {
                console.error("PDF generation error:", error);
                Swal.fire('Error', 'Failed to generate PDF.', 'error');
            } finally {
                pdfTemplate.classList.add('hidden');
            }
        };

        // --- Firestore CRUD Operations ---
        const getCollectionRef = (collectionName) => collection(db, `artifacts/${appId}/users/${userId}/${collectionName}`);

        // Transactions
        const addTransaction = async (data) => {
            try {
                await addDoc(getCollectionRef('transactions'), data);
                Swal.fire('Success', 'Transaction added!', 'success');
            } catch (e) {
                console.error("Error adding transaction: ", e);
                Swal.fire('Error', 'Could not add transaction.', 'error');
            }
        };
        const updateTransaction = async (id, data) => {
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/transactions`, id);
                await setDoc(docRef, data);
                Swal.fire('Success', 'Transaction updated!', 'success');
            } catch (e) {
                console.error("Error updating transaction: ", e);
                Swal.fire('Error', 'Could not update transaction.', 'error');
            }
        };
        const deleteTransaction = (id) => {
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const docRef = doc(db, `artifacts/${appId}/users/${userId}/transactions`, id);
                        await deleteDoc(docRef);
                        Swal.fire('Deleted!', 'Your transaction has been deleted.', 'success');
                    } catch (e) {
                        console.error("Error deleting transaction: ", e);
                        Swal.fire('Error', 'Could not delete transaction.', 'error');
                    }
                }
            });
        };

        // Categories
        const addCategory = async (data) => {
            try {
                await addDoc(getCollectionRef('categories'), data);
                Swal.fire('Success', 'Category added!', 'success');
            } catch (e) {
                console.error("Error adding category: ", e);
            }
        };
        const deleteCategory = (id) => {
            const categoryToDelete = categories.find(c => c.id === id);
            if (defaultCategories.some(dc => dc.name === categoryToDelete.name)) {
                Swal.fire('Cannot Delete', 'This is a default category and cannot be deleted.', 'error');
                return;
            }
            Swal.fire({
                title: 'Are you sure?',
                text: `Deleting "${categoryToDelete.name}" will also remove it from past transactions. This cannot be undone.`,
                icon: 'warning',
                showCancelButton: true,
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const docRef = doc(db, `artifacts/${appId}/users/${userId}/categories`, id);
                        await deleteDoc(docRef);
                        Swal.fire('Deleted!', 'Category has been deleted.', 'success');
                    } catch (e) {
                        console.error("Error deleting category: ", e);
                    }
                }
            });
        };

        // Budgets
        const setBudget = async (category, amount) => {
            try {
                const budgetRef = doc(db, `artifacts/${appId}/users/${userId}/budgets`, category);
                await setDoc(budgetRef, { category, amount });
                Swal.fire('Success', `Budget for ${category} has been set.`, 'success');
            } catch (e) {
                console.error("Error setting budget: ", e);
            }
        };

        // Goals
        const addGoal = async (data) => {
            try {
                await addDoc(getCollectionRef('goals'), data);
                Swal.fire('Success', 'New goal has been set!', 'success');
            } catch (e) {
                console.error("Error adding goal: ", e);
            }
        };
        const updateGoal = async (id, data) => {
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/goals`, id);
                await setDoc(docRef, data, { merge: true });
            } catch (e) {
                console.error("Error updating goal: ", e);
            }
        };
        const deleteGoal = (id) => {
            Swal.fire({
                title: 'Are you sure?', text: "Do you want to delete this goal?", icon: 'warning', showCancelButton: true,
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const docRef = doc(db, `artifacts/${appId}/users/${userId}/goals`, id);
                        await deleteDoc(docRef);
                        Swal.fire('Deleted!', 'Goal has been deleted.', 'success');
                    } catch (e) {
                        console.error("Error deleting goal: ", e);
                    }
                }
            });
        };

        // --- Data Listeners (Real-time updates) ---
        const setupListeners = () => {
            onSnapshot(getCollectionRef('transactions'), (snapshot) => {
                transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Refresh current page if it needs transaction data
                const currentPage = pageTitle.textContent.toLowerCase();
                if (['dashboard', 'transactions'].includes(currentPage)) {
                    loadPage(currentPage);
                }
            });

            onSnapshot(getCollectionRef('categories'), (snapshot) => {
                if (snapshot.empty) { // First time user
                    const batch = writeBatch(db);
                    defaultCategories.forEach(cat => {
                        const newCatRef = doc(getCollectionRef('categories'));
                        batch.set(newCatRef, cat);
                    });
                    batch.commit();
                } else {
                    categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (pageTitle.textContent.toLowerCase() === 'categories') {
                        renderCategories();
                    }
                }
            });
            
            onSnapshot(getCollectionRef('budgets'), (snapshot) => {
                budgets = snapshot.docs.map(doc => doc.data());
                if (pageTitle.textContent.toLowerCase() === 'budget') {
                    renderBudgets();
                }
            });
            
            onSnapshot(getCollectionRef('goals'), (snapshot) => {
                goals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (pageTitle.textContent.toLowerCase() === 'goals') {
                    renderGoals();
                }
            });
        };

        // --- App Initialization ---
        const initApp = () => {
            // Splash screen logic
            setTimeout(() => {
                document.getElementById('splash-screen').style.display = 'none';
                document.getElementById('app-wrapper').classList.remove('hidden');
            }, 2500);

            // Set current year in footer
            document.getElementById('current-year').textContent = new Date().getFullYear();

            // Setup event listeners
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            
            const toggleSidebar = () => {
                sidebar.classList.toggle('sidebar-hidden');
                sidebarOverlay.classList.toggle('hidden');
            };

            sidebarToggle.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);

            document.querySelectorAll('nav a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = e.currentTarget.id.replace('nav-', '');
                    loadPage(page);
                    if (window.innerWidth < 768) { // Close sidebar on mobile after navigation
                        toggleSidebar();
                    }
                });
            });

            document.getElementById('add-transaction-button-header').addEventListener('click', () => showTransactionModal());
            
            // Theme toggle
            const themeToggle = document.getElementById('theme-toggle');
            const html = document.documentElement;
            themeToggle.addEventListener('change', () => {
                if (themeToggle.checked) {
                    html.classList.add('dark');
                    // You would add dark mode specific styles here, e.g., using Tailwind's dark: prefix
                    // This is a basic toggle, full dark mode requires more CSS.
                } else {
                    html.classList.remove('dark');
                }
            });

            // Load initial page
            loadPage('dashboard');
        };

        // --- Authentication ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                console.log("User authenticated with UID:", userId);
                setupListeners();
                initApp();
            } else {
                console.log("No user signed in.");
            }
        });

        // Sign in logic
        (async () => {
            try {
                await setPersistence(auth, browserLocalPersistence);
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                document.body.innerHTML = `<div class="p-8 text-center text-red-500">Authentication failed. The app cannot start.</div>`;
            }
        })();

    </script>
</body>
</html>
