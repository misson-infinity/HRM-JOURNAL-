<!DOCTYPE html>
<html lang="bn" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I Expanse Tracker</title>
    
    <!-- Favicon (App Icon) -->
    <link rel="icon" href="https://i.ibb.co/9vXyCgS/image-4.png" type="image/png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- External Libraries for PDF, Charts, and Alerts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* Custom styles for a professional look */
        body { 
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .form-container { display: none; }
        .form-container.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
        /* Other styles from V3 remain the same */
        .infinity-svg-icon { width: 2.5rem; height: 2.5rem; stroke: #4f46e5; stroke-width: 8; transition: transform 0.3s ease; }
        .infinity-svg-icon:hover { transform: rotate(15deg); }
        .dark .infinity-svg-icon { stroke: #818cf8; }
        .nav-open { transform: translateX(0%); }
        .nav-closed { transform: translateX(-100%); }
        .page { display: none; animation: fadeInPage 0.5s ease; }
        .page.active { display: block; }
        @keyframes fadeInPage {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .swal2-popup { border-radius: 1rem; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <!-- ===== LOADING SPINNER (Visible on initial load) ===== -->
    <div id="loader-view" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-gray-50 dark:bg-gray-900">
        <div class="w-16 h-16 border-4 border-t-4 border-t-indigo-600 border-gray-200 rounded-full animate-spin"></div>
        <p class="mt-4 text-lg font-semibold text-gray-600 dark:text-gray-300">Loading Your Vision...</p>
    </div>

    <!-- ===== LOGIN/SIGNUP SCREEN (Initially Hidden) ===== -->
    <div id="auth-view" class="hidden min-h-screen flex flex-col items-center justify-center bg-gray-100 dark:bg-gray-900 p-4">
        <div class="w-full max-w-md">
            <!-- App Logo -->
            <div class="mx-auto mb-6 w-20 h-20 flex items-center justify-center">
                <svg class="w-16 h-16 text-indigo-600 dark:text-indigo-400" fill="none" viewBox="0 0 100 50">
                    <path d="M25 25C25 11.1929 36.1929 0 50 0C63.8071 0 75 11.1929 75 25C75 38.8071 63.8071 50 50 50C36.1929 50 25 38.8071 25 25ZM75 25C75 11.1929 86.1929 0 100 0" stroke="currentColor" stroke-width="10" stroke-linecap="round"/>
                    <path d="M75 25C75 38.8071 63.8071 50 50 50C36.1929 50 25 38.8071 25 25C25 11.1929 13.8071 0 0 0" stroke="currentColor" stroke-width="10" stroke-linecap="round"/>
                </svg>
            </div>
            
            <!-- Form Container -->
            <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl">
                <!-- Sign In Form -->
                <div id="signin-form-container" class="form-container active">
                    <h2 class="text-2xl font-bold text-center text-gray-800 dark:text-white mb-2">Welcome Back!</h2>
                    <p class="text-center text-gray-500 dark:text-gray-400 mb-6">Sign in to continue your journey.</p>
                    <form id="signin-form">
                        <div class="space-y-4">
                            <div>
                                <label for="signin-username" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Username</label>
                                <input type="text" id="signin-username" name="username" required class="mt-1 block w-full bg-gray-100 dark:bg-gray-700 border-transparent rounded-lg p-3 focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label for="signin-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Password</label>
                                <input type="password" id="signin-password" name="password" required class="mt-1 block w-full bg-gray-100 dark:bg-gray-700 border-transparent rounded-lg p-3 focus:ring-2 focus:ring-indigo-500">
                            </div>
                        </div>
                        <button type="submit" id="signin-btn" class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center">Sign In</button>
                    </form>
                    <p class="text-center text-sm text-gray-500 dark:text-gray-400 mt-6">
                        Don't have an account? <a href="#" id="show-signup" class="font-medium text-indigo-600 hover:text-indigo-500">Sign Up</a>
                    </p>
                </div>

                <!-- Sign Up Form -->
                <div id="signup-form-container" class="form-container">
                    <h2 class="text-2xl font-bold text-center text-gray-800 dark:text-white mb-2">Create Your Account</h2>
                    <p class="text-center text-gray-500 dark:text-gray-400 mb-6">Start your infinite financial journey.</p>
                    <form id="signup-form">
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="signup-firstname" class="block text-sm font-medium">First Name</label>
                                    <input type="text" id="signup-firstname" required class="mt-1 block w-full bg-gray-100 dark:bg-gray-700 border-transparent rounded-lg p-3 focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label for="signup-lastname" class="block text-sm font-medium">Last Name</label>
                                    <input type="text" id="signup-lastname" required class="mt-1 block w-full bg-gray-100 dark:bg-gray-700 border-transparent rounded-lg p-3 focus:ring-2 focus:ring-indigo-500">
                                </div>
                            </div>
                             <div>
                                <label for="signup-username" class="block text-sm font-medium">Username</label>
                                <input type="text" id="signup-username" required class="mt-1 block w-full bg-gray-100 dark:bg-gray-700 border-transparent rounded-lg p-3 focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label for="signup-email" class="block text-sm font-medium">Email</label>
                                <input type="email" id="signup-email" required class="mt-1 block w-full bg-gray-100 dark:bg-gray-700 border-transparent rounded-lg p-3 focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label for="signup-password" class="block text-sm font-medium">Password</label>
                                <input type="password" id="signup-password" required class="mt-1 block w-full bg-gray-100 dark:bg-gray-700 border-transparent rounded-lg p-3 focus:ring-2 focus:ring-indigo-500">
                            </div>
                        </div>
                        <button type="submit" id="signup-btn" class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center">Sign Up</button>
                    </form>
                    <p class="text-center text-sm text-gray-500 dark:text-gray-400 mt-6">
                        Already have an account? <a href="#" id="show-signin" class="font-medium text-indigo-600 hover:text-indigo-500">Sign In</a>
                    </p>
                </div>
            </div>
            
            <!-- Developer Info -->
            <div class="mt-8 text-center text-gray-500 dark:text-gray-400">
                <p class="text-sm">Developed by</p>
                <p class="font-semibold">Md Habibur Rahman Mahi</p>
                <p class="text-xs">Founder and CEO of Infinity Group</p>
            </div>
        </div>
    </div>

    <!-- ===== MAIN APP VIEW (Remains the same as V3) ===== -->
    <div id="app-view" class="hidden">
        <!-- Navigation, Header, Pages, FAB, PDF Template etc. -->
        <!-- This entire section is copied from V3 and remains unchanged -->
        <!-- ... -->
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, updateDoc, deleteDoc, query, orderBy, writeBatch, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBAjSI9qQz1ZQ0oNFP3qxSJPjocDFO1DnI",
            authDomain: "i-expanse-tracker-5375b.firebaseapp.com",
            projectId: "i-expanse-tracker-5375b",
            storageBucket: "i-expanse-tracker-5375b.appspot.com",
            messagingSenderId: "442895718535",
            appId: "1:442895718535:web:e09ef6e8fb555b7ebcc022",
            measurementId: "G-C1644P9YXL"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- GLOBAL STATE ---
        let currentUser = null;
        let unsubscribe = {};

        // --- DOM ELEMENTS ---
        const loaderView = document.getElementById('loader-view');
        const authView = document.getElementById('auth-view');
        const appView = document.getElementById('app-view');
        
        // Auth Form Elements
        const signinFormContainer = document.getElementById('signin-form-container');
        const signupFormContainer = document.getElementById('signup-form-container');
        const signinForm = document.getElementById('signin-form');
        const signupForm = document.getElementById('signup-form');
        const showSignupLink = document.getElementById('show-signup');
        const showSigninLink = document.getElementById('show-signin');
        const signinBtn = document.getElementById('signin-btn');
        const signupBtn = document.getElementById('signup-btn');


        // --- AUTHENTICATION & APP INITIALIZATION ---

        onAuthStateChanged(auth, user => {
            if (user) {
                if (currentUser?.uid !== user.uid) {
                    currentUser = user;
                    initializeAppView(user);
                }
            } else {
                if (currentUser) {
                    // cleanupListeners(); // Assuming this function exists from previous versions
                    currentUser = null;
                }
                showAuthView();
            }
        });

        function showAuthView() {
            loaderView.classList.add('hidden');
            appView.classList.add('hidden');
            authView.classList.remove('hidden');
        }
        
        async function initializeAppView(user) {
            // await setupUser(user); // Assuming this function exists
            // setupListeners(user.uid); // Assuming this function exists
            loaderView.classList.add('hidden');
            authView.classList.add('hidden');
            appView.classList.remove('hidden');
        }
        
        // --- NEW AUTHENTICATION LOGIC ---

        // Toggle between Sign In and Sign Up forms
        showSignupLink.addEventListener('click', (e) => {
            e.preventDefault();
            signinFormContainer.classList.remove('active');
            signupFormContainer.classList.add('active');
        });

        showSigninLink.addEventListener('click', (e) => {
            e.preventDefault();
            signupFormContainer.classList.remove('active');
            signinFormContainer.classList.add('active');
        });

        // Handle Sign Up
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            setButtonLoading(signupBtn, true, 'Signing Up...');

            const firstName = document.getElementById('signup-firstname').value.trim();
            const lastName = document.getElementById('signup-lastname').value.trim();
            const username = document.getElementById('signup-username').value.trim().toLowerCase();
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;

            // Basic validation
            if (!firstName || !lastName || !username || !email || !password) {
                showAuthError("Please fill in all fields.");
                setButtonLoading(signupBtn, false, 'Sign Up');
                return;
            }
            if (password.length < 6) {
                showAuthError("Password must be at least 6 characters long.");
                setButtonLoading(signupBtn, false, 'Sign Up');
                return;
            }
            if (/\s/.test(username)) {
                showAuthError("Username cannot contain spaces.");
                setButtonLoading(signupBtn, false, 'Sign Up');
                return;
            }

            // Check if username is unique
            const usernameRef = doc(db, "usernames", username);
            const usernameDoc = await getDoc(usernameRef);

            if (usernameDoc.exists()) {
                showAuthError("This username is already taken. Please choose another one.");
                setButtonLoading(signupBtn, false, 'Sign Up');
                return;
            }

            try {
                // Create user with email and password
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Update user profile with display name
                await updateProfile(user, {
                    displayName: `${firstName} ${lastName}`
                });

                // Create user documents in Firestore
                const userDocRef = doc(db, "users", user.uid);
                const usernameDocRef = doc(db, "usernames", username);

                const userData = {
                    uid: user.uid,
                    firstName,
                    lastName,
                    username,
                    email,
                    displayName: `${firstName} ${lastName}`,
                    photoURL: `https://placehold.co/128x128/E2E8F0/4A5568?text=${firstName.charAt(0)}`, // Default photo
                    createdAt: new Date()
                };

                await setDoc(userDocRef, userData);
                await setDoc(usernameDocRef, { uid: user.uid, email: user.email });
                
                // Add default categories for the new user
                // await addDefaultCategories(user.uid); // Assuming this function exists

                // onAuthStateChanged will handle the redirect to the app
            } catch (error) {
                showAuthError(getFriendlyAuthErrorMessage(error));
                setButtonLoading(signupBtn, false, 'Sign Up');
            }
        });

        // Handle Sign In
        signinForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            setButtonLoading(signinBtn, true, 'Signing In...');
            
            const username = document.getElementById('signin-username').value.trim().toLowerCase();
            const password = document.getElementById('signin-password').value;

            if (!username || !password) {
                showAuthError("Please enter both username and password.");
                setButtonLoading(signinBtn, false, 'Sign In');
                return;
            }

            try {
                // Look up email from username
                const usernameRef = doc(db, "usernames", username);
                const usernameDoc = await getDoc(usernameRef);

                if (!usernameDoc.exists()) {
                    throw new Error("auth/invalid-credential");
                }

                const userEmail = usernameDoc.data().email;

                // Sign in with the retrieved email
                await signInWithEmailAndPassword(auth, userEmail, password);
                // onAuthStateChanged will handle the redirect to the app
            } catch (error) {
                showAuthError(getFriendlyAuthErrorMessage(error));
                setButtonLoading(signinBtn, false, 'Sign In');
            }
        });

        // --- HELPER FUNCTIONS ---

        function setButtonLoading(button, isLoading, loadingText) {
            if (isLoading) {
                button.disabled = true;
                button.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> ${loadingText}`;
            } else {
                button.disabled = false;
                button.innerHTML = loadingText;
            }
        }

        function showAuthError(message) {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: message,
                customClass: { popup: 'dark:bg-gray-800 dark:text-gray-200' }
            });
        }

        function getFriendlyAuthErrorMessage(error) {
            switch (error.code) {
                case 'auth/invalid-email':
                    return 'Please enter a valid email address.';
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-credential':
                    return 'Invalid username or password. Please try again.';
                case 'auth/email-already-in-use':
                    return 'This email address is already registered. Please sign in or use a different email.';
                case 'auth/weak-password':
                    return 'The password is too weak. Please use at least 6 characters.';
                default:
                    console.error(error);
                    return 'An unexpected error occurred. Please try again later.';
            }
        }

        // --- NOTE: The rest of the application's JavaScript (dashboard, settings, etc.) ---
        // --- would be placed here. It is omitted for brevity as the core change ---
        // --- was the authentication system. You should copy the rest of the JS ---
        // --- from the previous version (V3) to restore full functionality. ---

    </script>
</body>
</html>

