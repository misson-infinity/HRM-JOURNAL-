
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinity Stream | News Portal</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+Da+2:wght@400;500;600;700;800&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script type="importmap">
        {
            "imports": {
                "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
                "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
                "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"
            }
        }
    </script>

    <style>
        body { font-family: 'Baloo Da 2', sans-serif; background-color: #f5f7fa; color: #1a1a1a; font-weight: 500; }
        .font-brand { font-family: 'Playfair Display', serif; }
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #991b1b; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #e5e7eb; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #dc2626; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .headline-lg { color: #1a1a1a; font-weight: 800; font-size: 2rem; line-height: 1.3; transition: color 0.3s; }
        @media (min-width: 768px) { .headline-lg { font-size: 3rem; line-height: 1.2; } }
        .article-content { font-size: 1.0rem; line-height: 1.8; text-align: justify; color: #333333; }
        @media (min-width: 768px) { .article-content { font-size: 1.15rem; line-height: 2; } }
        .article-content p { margin-bottom: 1.5rem; }
        .article-content h2, .article-content h3 { font-weight: 700; margin-top: 2rem; margin-bottom: 1rem; color: #374151; }
        .article-content img { max-width: 100%; height: auto; display: block; margin: 3rem auto; border-radius: 0.75rem; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); }
        .brand-icon { height: 30px; width: auto; margin-left: 0.25rem; margin-right: 0.25rem; display: inline-block; }
        @media (min-width: 768px) { .brand-icon { height: 36px; } }
        /* Style for reaction feedback */
        .reaction-clicked { transform: scale(1.3); box-shadow: 0 0 10px rgba(255, 165, 0, 0.7); transition: all 0.1s ease-out; }
    </style>
    
    <script>
        // Only English UI Text
        const UI_TEXT = {
            'news': 'News', 
            'home': 'Home', 
            'admin_dashboard': 'Admin Dashboard', 
            'login_google': 'Google Login', 
            'login_admin': 'Admin Login (Email/Pass)', 
            'logout': 'Logout', 
            'latest_news': 'Latest News', 
            'read_more': 'Read More', 
            'article_not_found': 'Article not found.', 
            'no_articles_in_category': 'No articles found in this category.', 
            'error_loading_article': 'Error loading article:', 
            'article_edit': 'Edit Article', 
            'author_name': 'Infinity Stream News Desk', 
            'admin_login_title': 'Admin Login', 
            'email': 'Email', 
            'password': 'Password', 
            'login': 'Login', 
            'processing': 'Processing...', 
            'back_to_home': 'Back to Home', 
            'admin_access_denied_title': 'Access Denied', 
            'admin_access_denied_body': 'Sorry, you are not authorized to access this page.', 
            'new_post': 'Create New Post', 
            'edit_post': 'Edit Post', 
            'verified_admin': 'VERIFIED ADMIN', 
            'manage_categories': 'Manage Categories', 
            'create_new_post': 'Create New Post', 
            'article_title': 'News Headline', 
            'thumbnail_link': 'Thumbnail Image Link (Optional)', 
            'youtube_link': 'YouTube Video Link (Optional)', 
            'excerpt': 'Excerpt', 
            'body_content': 'Detailed News (You can use HTML image tag: <img src=\'...\' />)', 
            'publish_post': 'Publish Post', 
            'update_post': 'Update Post', 
            'delete_post': 'Delete', 
            'recent_posts': 'Recent Posts', 
            'loading': 'Loading...', 
            'no_published_articles': 'No published articles found.', 
            'edit': 'Edit', 
            'category_management': 'Category Management', 
            'add_new_category': 'Create New Category', 
            'new_category_name': 'New Category Name', 
            'add': 'Add', 
            'existing_categories': 'Edit/Delete Existing Categories', 
            'default_category': 'Default (Cannot be deleted)', 
            'update_success': 'Successfully Updated!', 
            'publish_success': 'Successfully Published!', 
            'article_not_found_alert': 'Article not found.', 
            'loading_fail': 'Failed to load posts:', 
            'category_loading_fail': 'Error loading categories:', 
            'admin_mode': 'ADMIN MODE', 
            'reader_mode': 'READER MODE', 
            'unknown_date': 'Unknown Date', 
            'category_add_success': 'successfully added', 
            'category_update_success': 'successfully updated', 
            'category_delete_success': 'successfully deleted', 
            'go_back_to_dashboard': 'Go back to Post Dashboard',
            'share_article': 'Share Article',
            'copy_link': 'Copy Link',
            'react_to_article': 'React to this Article',
        };
    </script>
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-white sticky top-0 z-40 border-b border-gray-200 shadow-md h-16 md:h-20 flex items-center">
        <div class="container mx-auto px-4 md:px-6 lg:px-8 flex justify-between items-center relative max-w-7xl">
            <a href="#home" class="flex flex-col items-start gap-0 group">
                <div class="flex items-end relative">
                    <span class="font-brand text-2xl md:text-4xl font-bold tracking-tight text-red-600">Infinity</span>
                    <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg3ZGAKLh5xvrm4t5qAkDx-V1ZtOOojJxFFBZFeqjKcDW-P1YSHlwgZtV9DxrcurPE9lKEoZH5bk0C8nV69oAAllM5wxtcRy2cxZociXMx4MtOpuet6snChXDz0UTGXpnmkC9hhRs6dyHC77rM0KID9lZeACuS280CebuXqr4NrPJEqlOABfargbi7CW5I/s808/1000067315.jpg" alt="Stream Icon" class="brand-icon" />
                    <span class="font-brand text-2xl md:text-4xl font-bold tracking-tight text-gray-900">Stream</span>
                    <span class="text-xs md:text-sm font-bold text-gray-400 ml-2 tracking-wide">News Portal</span>
                </div>
              <span id="header-date-time" class="text-[10px] md:text-xs font-bold text-gray-500 mt-1 px-0 py-[1px]"></span>
            </a>

            <div class="flex items-center gap-3 md:gap-4">
                <div id="auth-status" class="hidden lg:block text-xs font-bold text-gray-500"></div>
                <button onclick="window.toggleMenu()" class="text-2xl md:text-3xl text-gray-800 hover:text-red-600 focus:outline-none">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </header>

    <div id="side-menu-overlay" class="fixed inset-0 bg-black/70 z-50 hidden transition-opacity duration-300 opacity-0" onclick="window.toggleMenu()"></div>
    <div id="side-menu" class="fixed top-0 right-0 h-full w-[85%] max-w-sm bg-white z-50 transform translate-x-full transition-transform duration-300 shadow-2xl flex flex-col">
        <div class="flex justify-between items-center p-6 border-b bg-gray-50">
            <h2 class="font-brand text-2xl font-bold text-red-600">Infinity Stream</h2>
            <button onclick="window.toggleMenu()" class="text-2xl text-gray-500 hover:text-red-500"><i class="fas fa-times"></i></button>
        </div>
        <div class="flex-grow overflow-y-auto custom-scroll p-6">
            <ul id="menu-categories" class="space-y-4 text-lg font-medium text-gray-800">
            </ul>
        </div>
        <div class="p-6 bg-gray-50 border-t shadow-inner">
            <div id="logged-out-section" class="space-y-3">
                <button id="login-google-btn" class="w-full border border-gray-300 py-3 rounded-lg text-sm font-bold bg-white hover:bg-gray-100 flex items-center justify-center gap-2 transition">
                    <i class="fab fa-google text-red-500"></i> <span id="txt-login-google">Google Login</span>
                </button>
                <button id="login-email-btn" class="w-full bg-red-600 text-white py-3 rounded-lg text-sm font-bold hover:bg-red-700 transition">
                     <span id="txt-login-admin">Admin Login</span>
                </button>
            </div>
            <button id="logout-btn" class="w-full border border-red-300 py-3 rounded-lg text-sm font-bold mb-4 hidden bg-red-50 text-red-600 hover:bg-red-100 transition">
                Logout
            </button>
            <div class="flex gap-6 text-2xl text-gray-500 justify-center mt-6">
                <i class="fab fa-facebook-square hover:text-red-600 transition"></i>
                <i class="fa-brands fa-x-twitter hover:text-red-600 transition"></i>
                <i class="fab fa-youtube hover:text-red-600 transition"></i>
            </div>
        </div>
    </div>

    <main id="app-root" class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12 max-w-7xl min-h-[60vh]">
        <div class="flex justify-center items-center h-64"><div class="loader"></div></div>
    </main>

    <footer class="bg-gray-100 border-t border-gray-200 mt-12 md:mt-16 py-6 md:py-8">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center max-w-7xl">
            <p class="text-gray-600 text-xs md:text-sm">¬© Infinity Stream | News Portal | Developed by Infinity Group </p>
        </div>
    </footer>

        <script type="module">
        import { initializeApp } from "firebase/app";
        import { getFirestore, collection, getDocs, getDoc, addDoc, doc, query, orderBy, limit, serverTimestamp, updateDoc, deleteDoc, increment } from "firebase/firestore";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInWithEmailAndPassword } from "firebase/auth";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyBlVYaMOrpj2JbE59eeRoO8TdKGwBFTQJM",
            authDomain: "infinity-stream-13726.firebaseapp.com",
            projectId: "infinity-stream-13726",
            storageBucket: "infinity-stream-13726.firebasestorage.app",
            messagingSenderId: "708884808002",
            appId: "1:708884808002:web:434d7c704fc78d7d42c8db",
            measurementId: "G-1G049G8NBD"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // --- STATE & CONFIG ---
        const ADMIN_EMAILS = [
            "habiburrahmanmahi4@gmail.com",
            "habiburrahmannawshad@gmail.com",
            "ahnafmahi19@gmail.com"
        ];
        const defaultCategories = ["Current Affairs", "Sports", "Fact Check", "Opinion"];
        const CUSTOM_ICON_URL = "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg3ZGAKLh5xvrm4t5qAkDx-V1ZtOOojJxFFBZFeqjKcDW-P1YSHlwgZtV9DxrcurPE9lKEoZH5bk0C8nV69oAAllM5wxtcRy2cxZociXMx4MtOpuet6snChXDz0UTGXpnmkC9hhRs6dyHC77rM0KID9lZeACuS280CebuXqr4NrPJEqlOABfargbi7CW5I/s808/1000067315.jpg"; 

        let currentUser = null;
        let isAdmin = false;
        let articleToEdit = null;
        let isAuthReady = false;

        // UI TEXT Directly inside Module to prevent loading errors
        const UI_TEXT = {
            'news': 'News', 'home': 'Home', 'admin_dashboard': 'Admin Dashboard', 'login_google': 'Google Login', 
            'login_admin': 'Admin Login (Email/Pass)', 'logout': 'Logout', 'latest_news': 'Latest News', 
            'read_more': 'Read More', 'article_not_found': 'Article not found.', 'no_articles_in_category': 'No articles found in this category.', 
            'error_loading_article': 'Error loading article:', 'article_edit': 'Edit Article', 'author_name': 'Infinity Stream News Desk', 
            'admin_login_title': 'Admin Login', 'email': 'Email', 'password': 'Password', 'login': 'Login', 
            'processing': 'Processing...', 'back_to_home': 'Back to Home', 'admin_access_denied_title': 'Access Denied', 
            'admin_access_denied_body': 'Sorry, you are not authorized to access this page.', 'new_post': 'Create New Post', 
            'edit_post': 'Edit Post', 'verified_admin': 'VERIFIED ADMIN', 'manage_categories': 'Manage Categories', 
            'create_new_post': 'Create New Post', 'article_title': 'News Headline', 'thumbnail_link': 'Thumbnail Image Link (Optional)', 
            'youtube_link': 'YouTube Video Link (Optional)', 'excerpt': 'Excerpt', 'body_content': 'Detailed News', 
            'publish_post': 'Publish Post', 'update_post': 'Update Post', 'delete_post': 'Delete', 'recent_posts': 'Recent Posts', 
            'loading': 'Loading...', 'no_published_articles': 'No published articles found.', 'edit': 'Edit', 
            'category_management': 'Category Management', 'add_new_category': 'Create New Category', 'new_category_name': 'New Category Name', 
            'add': 'Add', 'existing_categories': 'Edit/Delete Existing Categories', 'default_category': 'Default (Cannot be deleted)', 
            'update_success': 'Successfully Updated!', 'publish_success': 'Successfully Published!', 'article_not_found_alert': 'Article not found.', 
            'loading_fail': 'Failed to load posts:', 'category_loading_fail': 'Error loading categories:', 'admin_mode': 'ADMIN MODE', 
            'reader_mode': 'READER MODE', 'unknown_date': 'Unknown Date', 'category_add_success': 'successfully added', 
            'category_update_success': 'successfully updated', 'category_delete_success': 'successfully deleted', 
            'go_back_to_dashboard': 'Go back to Post Dashboard',
            'share_article': 'Share Article', 
            'copy_link': 'Copy Link', 
            'react_to_article': 'React to this Article', 
        };

        const t = (key) => UI_TEXT[key] || key;
        
        // --- GLOBAL FUNCTIONS (Now inside module to access DB) ---

        /**
         * Simulates adding a reaction, stores in DB and provides visual feedback.
         */
        window.handleReaction = async (reactionType, articleId, event) => {
            const button = event.currentTarget;
            
            // Visual feedback: brief scale-up effect
            button.classList.add('reaction-clicked');
            setTimeout(() => {
                button.classList.remove('reaction-clicked');
            }, 300);

            // DB Update: using increment to handle concurrent updates
            const articleRef = doc(db, "articles", articleId);
            const fieldPath = `reactions.${reactionType}`; // Nested field like "reactions.üëç"

            try {
                // Optimistic UI update (update number immediately)
                const countSpan = document.getElementById(`count-${reactionType}-${articleId}`);
                if (countSpan) {
                    let currentCount = parseInt(countSpan.innerText) || 0;
                    countSpan.innerText = currentCount + 1;
                }

                await updateDoc(articleRef, {
                    [fieldPath]: increment(1)
                });
                console.log(`Reacted ${reactionType} to ${articleId}`);
            } catch (error) {
                console.error("Error updating reaction:", error);
                // Revert UI if error (optional)
                const countSpan = document.getElementById(`count-${reactionType}-${articleId}`);
                if (countSpan) {
                    let currentCount = parseInt(countSpan.innerText) || 0;
                    countSpan.innerText = Math.max(0, currentCount - 1);
                }
                alert("Failed to add reaction. Please try again.");
            }
        };

        /**
         * Handles copying the current article's URL to the clipboard.
         */
        window.copyArticleLink = () => {
             const articleUrl = window.location.href;
             navigator.clipboard.writeText(articleUrl).then(() => {
                const copyBtn = document.getElementById('copyLinkBtn');
                if (copyBtn) {
                    const originalText = copyBtn.innerHTML;
                    copyBtn.innerHTML = `<i class="fas fa-check mr-1"></i> Copied!`;
                    setTimeout(() => { copyBtn.innerHTML = originalText; }, 2000);
                }
             }).catch(err => {
                console.error('Could not copy text: ', err);
                alert("Failed to copy link. Please copy it manually from your browser's address bar.");
             });
        };

        // --- GLOBAL FUNCTIONS ---
        window.toggleMenu = () => {
            const menu = document.getElementById('side-menu');
            const overlay = document.getElementById('side-menu-overlay');
            if(menu.classList.contains('translate-x-full')) {
                menu.classList.remove('translate-x-full');
                overlay.classList.remove('hidden');
                setTimeout(()=>overlay.classList.remove('opacity-0'),10);
            } else {
                menu.classList.add('translate-x-full');
                overlay.classList.add('opacity-0');
                setTimeout(()=>overlay.classList.add('hidden'),300);
            }
        };

        const updateHeaderDateTime = () => {
            const dateTimeElement = document.getElementById('header-date-time');
            if(dateTimeElement) {
                const now = new Date();
                const options = { 
                    weekday: 'short', month: 'short', day: 'numeric', year: 'numeric', 
                    hour: '2-digit', minute: '2-digit', hour12: true 
                };
                const formattedDateTime = now.toLocaleDateString('en-US', options).toUpperCase().replace(/, /g, ' | ');
                dateTimeElement.textContent = formattedDateTime;
            }
        }
        setInterval(updateHeaderDateTime, 60000);


        // --- CORE FUNCTIONS ---
        const loadCategories = async () => {
            let categoryObjects = [];
            defaultCategories.forEach(name => {
                categoryObjects.push({ id: null, name: name, isDefault: true });
            });
            
            try {
                const categoriesRef = collection(db, "categories");
                const q = query(categoriesRef, orderBy("name"));
                const querySnapshot = await getDocs(q);
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if(data.name && !defaultCategories.includes(data.name)) {
                        categoryObjects.push({ id: doc.id, name: data.name, isDefault: false }); 
                    }
                });
            } catch (e) {
                console.error("Error loading categories from DB, showing defaults only:", e);
            }
            categoryObjects.sort((a, b) => a.name.localeCompare(b.name, 'en'));
            return categoryObjects; 
        };

        const renderCategoriesMenu = (categoriesObjects) => {
            const menuList = document.getElementById('menu-categories');
            if(!menuList) return;

            menuList.innerHTML = `<li><a href="#home" onclick="window.toggleMenu()" class="hover:text-red-600 block">${t('home')}</a></li>`;
            
            categoriesObjects.forEach(category => {
                const item = document.createElement('li');
                item.innerHTML = `<a href="#category/${encodeURIComponent(category.name)}" onclick="window.toggleMenu()" class="hover:text-red-600 block">${category.name}</a>`;
                menuList.appendChild(item);
            });

            if(isAdmin) {
                const adminItem = document.createElement('li');
                adminItem.innerHTML = `<a href="#admin" onclick="window.toggleMenu()" class="text-red-600 font-bold block border-l-4 border-red-600 pl-2">${t('admin_dashboard')}</a>`;
                menuList.appendChild(adminItem);
            }
        };

        const updateAuthUI = () => {
            const logoutBtn = document.getElementById('logout-btn');
            const loggedOutSection = document.getElementById('logged-out-section');
            const status = document.getElementById('auth-status');

            if (currentUser) {
                loggedOutSection.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                logoutBtn.onclick = () => signOut(auth);
                
                status.textContent = isAdmin ? t('admin_mode') : t('reader_mode');
                status.className = isAdmin ? "hidden lg:block text-xs font-bold text-red-600 border border-red-200 px-2 py-1 rounded bg-red-50" : "hidden lg:block text-xs font-bold text-gray-500";
            } else {
                loggedOutSection.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                status.textContent = "";
                
                document.getElementById('login-google-btn').onclick = loginWithGoogle;
                document.getElementById('login-email-btn').onclick = () => {
                    window.toggleMenu();
                    window.location.hash = '#admin-login';
                };
            }
        };

        const initUI = async () => {
             const btnGoogle = document.getElementById('txt-login-google');
             if(btnGoogle) btnGoogle.textContent = t('login_google');
             
             const btnAdmin = document.getElementById('txt-login-admin');
             if(btnAdmin) btnAdmin.textContent = t('login_admin');
             
             const btnLogout = document.getElementById('logout-btn');
             if(btnLogout) btnLogout.textContent = t('logout');

             const cats = await loadCategories();
             renderCategoriesMenu(cats);
             updateAuthUI();
             updateHeaderDateTime(); 
        }

        // --- AUTH ACTIONS ---
        const loginWithGoogle = async () => {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                window.toggleMenu();
            } catch (error) {
                alert("Login Error: " + error.message);
            }
        };

        const loginWithEmailPassword = async (email, password) => {
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                alert("Login Failed: " + error.message);
                throw error;
            }
        };

        // --- RENDERERS ---
        const root = document.getElementById('app-root');
        const renderLoading = () => root.innerHTML = `<div class="flex justify-center items-center h-64"><div class="loader"></div><p class="text-gray-600 ml-4 font-bold">${t('loading')}</p></div>`;

        const getYouTubeId = (url) => {
            if(!url) return null;
            const regex = /(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const match = url.match(regex);
            return (match && match[1]) ? match[1] : null;
        };

        const renderHome = async (categoryFilter = null) => {
            renderLoading();
            try {
                const articlesRef = collection(db, "articles");
                let q;
                const filterTitle = categoryFilter ? categoryFilter : t('latest_news');

                if (categoryFilter && categoryFilter !== t('home')) {
                    q = query(articlesRef, orderBy("createdAt", "desc")); 
                } else {
                    q = query(articlesRef, orderBy("createdAt", "desc"), limit(20));
                }
                
                const querySnapshot = await getDocs(q);
                let filteredDocs = [];
                
                querySnapshot.forEach(doc => {
                    if (!categoryFilter || doc.data().category === categoryFilter) {
                        filteredDocs.push({ id: doc.id, ...doc.data() });
                    }
                });

                if (filteredDocs.length === 0) return root.innerHTML = `<div class="text-center py-20 text-gray-500 text-xl font-semibold">${t('no_articles_in_category')}</div>`;

                let html = `
                    <h1 class="text-2xl md:text-3xl font-extrabold text-gray-900 mb-8 border-b-4 border-red-600 pb-3 inline-block">${filterTitle}</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 md:gap-10">`;
                
                filteredDocs.forEach((data) => {
                    const dateString = data.createdAt?.toDate().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) || t('unknown_date');
                    const thumbnailSrc = data.thumbnail || null; 
                    
                    html += `
                    <div class="bg-white rounded-xl overflow-hidden shadow-xl hover:shadow-2xl transition-all duration-300 border border-gray-100 group cursor-pointer" onclick="window.location.hash='#article/${data.id}'">
                        ${thumbnailSrc ? `
                        <div class="h-56 relative overflow-hidden">
                            <img src="${thumbnailSrc}" alt="${data.title}" class="w-full h-full object-cover group-hover:scale-110 transition duration-700">
                            <div class="absolute top-4 left-4"><span class="bg-red-700 text-white text-xs font-bold px-3 py-1 rounded-full uppercase shadow-lg">${data.category}</span></div>
                        </div>` : `<div class="p-6 h-56 flex items-center justify-center bg-gray-100"><span class="text-gray-500 font-bold text-center">${data.category}</span></div>`}
                        
                        <div class="p-5 flex flex-col justify-between h-56">
                            <h2 class="text-xl lg:text-2xl font-extrabold text-gray-900 mb-2 line-clamp-3 group-hover:text-red-700 transition">${data.title}</h2>
                            <p class="text-gray-600 line-clamp-2 text-sm mb-3">${data.excerpt || ''}</p>
                            <div class="text-xs text-gray-500 font-medium border-t pt-3 flex justify-between items-center">
                                <span>${dateString}</span>
                                <span class="text-red-600 font-extrabold flex items-center gap-1">${t('read_more')} <i class="fas fa-arrow-right text-[10px] ml-1"></i></span>
                            </div>
                        </div>
                    </div>`;
                });
                html += '</div>';
                root.innerHTML = html;
            } catch (e) { root.innerHTML = `<div class="text-center text-red-500">${t('error_loading_article')} ${e.message}</div>`; }
        };

        const renderArticle = async (id) => {
            renderLoading();
            try {
                const docSnap = await getDoc(doc(db, "articles", id));
                if (!docSnap.exists()) return root.innerHTML = `<div class="text-center py-20 text-xl font-semibold">${t('article_not_found')}</div>`;
                
                const data = docSnap.data();
                const videoId = getYouTubeId(data.youtubeLink || '');
                const dateString = data.createdAt?.toDate().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }) || t('unknown_date');
                const adminEditButton = isAdmin ? `<button onclick="window.location.hash='#admin/edit/${id}'" class="text-[10px] md:text-xs bg-blue-600 text-white px-2 py-1 rounded-full hover:bg-blue-700 ml-2 md:ml-4 transition font-semibold">${t('article_edit')}</button>` : '';

                // --- NEW: SHARE AND REACTION FEATURES HTML ---
                const articleUrl = window.location.href;
                const articleTitle = encodeURIComponent(data.title);
                const facebookShareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(articleUrl)}`;
                const twitterShareUrl = `https://twitter.com/intent/tweet?url=${encodeURIComponent(articleUrl)}&text=${articleTitle}`;
                
                // Get reaction counts
                const reactions = data.reactions || {};
                const rLike = reactions['üëç'] || 0;
                const rLove = reactions['‚ù§Ô∏è'] || 0;
                const rLaugh = reactions['üòÇ'] || 0;
                const rSad = reactions['üò¢'] || 0;
                const rAngry = reactions['üò°'] || 0;

                const shareAndReactionSection = `
                    <div class="px-4 md:px-12 mt-8 pt-6 border-t border-gray-200">
                        <div class="flex flex-col md:flex-row gap-6">
                            
                            <div class="md:w-1/2">
                                <h3 class="text-lg font-bold text-gray-800 mb-3">${t('share_article')}</h3>
                                <div class="flex flex-wrap gap-3">
                                    <a href="${facebookShareUrl}" target="_blank" class="flex items-center bg-blue-600 text-white text-sm font-bold px-3 py-2 rounded-lg hover:bg-blue-700 transition shadow-md">
                                        <i class="fab fa-facebook-f mr-2"></i> Facebook
                                    </a>
                                    <a href="${twitterShareUrl}" target="_blank" class="flex items-center bg-black text-white text-sm font-bold px-3 py-2 rounded-lg hover:bg-gray-800 transition shadow-md">
                                        <i class="fa-brands fa-x-twitter mr-2"></i> X (Twitter)
                                    </a>
                                    <button id="copyLinkBtn" onclick="window.copyArticleLink()" class="flex items-center bg-gray-200 text-gray-800 text-sm font-bold px-3 py-2 rounded-lg hover:bg-gray-300 transition shadow-md">
                                        <i class="fas fa-link mr-2"></i> ${t('copy_link')}
                                    </button>
                                </div>
                            </div>

                            <div class="md:w-1/2">
                                <h3 class="text-lg font-bold text-gray-800 mb-3">${t('react_to_article')}</h3>
                                <div class="flex gap-3">
                                    <button onclick="window.handleReaction('üëç', '${id}', event)" class="flex flex-col items-center justify-center p-2 bg-gray-100 rounded-lg shadow-sm hover:bg-gray-200 transition min-w-[50px]">
                                        <span class="text-2xl hover:scale-110 transition duration-150">üëç</span>
                                        <span id="count-üëç-${id}" class="text-xs font-bold text-gray-600 mt-1">${rLike}</span>
                                    </button>
                                    <button onclick="window.handleReaction('‚ù§Ô∏è', '${id}', event)" class="flex flex-col items-center justify-center p-2 bg-gray-100 rounded-lg shadow-sm hover:bg-gray-200 transition min-w-[50px]">
                                        <span class="text-2xl hover:scale-110 transition duration-150">‚ù§Ô∏è</span>
                                        <span id="count-‚ù§Ô∏è-${id}" class="text-xs font-bold text-gray-600 mt-1">${rLove}</span>
                                    </button>
                                    <button onclick="window.handleReaction('üòÇ', '${id}', event)" class="flex flex-col items-center justify-center p-2 bg-gray-100 rounded-lg shadow-sm hover:bg-gray-200 transition min-w-[50px]">
                                        <span class="text-2xl hover:scale-110 transition duration-150">üòÇ</span>
                                        <span id="count-üòÇ-${id}" class="text-xs font-bold text-gray-600 mt-1">${rLaugh}</span>
                                    </button>
                                    <button onclick="window.handleReaction('üò¢', '${id}', event)" class="flex flex-col items-center justify-center p-2 bg-gray-100 rounded-lg shadow-sm hover:bg-gray-200 transition min-w-[50px]">
                                        <span class="text-2xl hover:scale-110 transition duration-150">üò¢</span>
                                        <span id="count-üò¢-${id}" class="text-xs font-bold text-gray-600 mt-1">${rSad}</span>
                                    </button>
                                    <button onclick="window.handleReaction('üò°', '${id}', event)" class="flex flex-col items-center justify-center p-2 bg-gray-100 rounded-lg shadow-sm hover:bg-gray-200 transition min-w-[50px]">
                                        <span class="text-2xl hover:scale-110 transition duration-150">üò°</span>
                                        <span id="count-üò°-${id}" class="text-xs font-bold text-gray-600 mt-1">${rAngry}</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                // --- END NEW HTML ---

                root.innerHTML = `
                <article class="bg-white rounded-lg md:rounded-xl shadow-xl md:shadow-2xl overflow-hidden pb-8 md:pb-10 border border-gray-100">
                    <div class="px-4 md:px-12 pt-6 md:pt-8 pb-4">
                        <span class="text-red-700 font-extrabold text-xs md:text-sm uppercase tracking-widest bg-red-50 px-3 py-1 rounded-full">${data.category}</span>
                        
                        <h1 class="headline-lg mt-3 md:mt-4 mb-1 md:mb-2 leading-tight text-gray-900">${data.title}</h1>
                        <p class="text-sm text-gray-500 font-medium mb-4">Published: ${dateString}</p>
                        
                    </div>
                    
                    <div class="px-4 md:px-12 flex items-center gap-4 mb-6 pb-4 md:pb-6 border-b border-gray-200">
                        <div class="w-10 h-10 md:w-12 md:h-12 rounded-full bg-red-700 overflow-hidden flex items-center justify-center shadow-lg">
                             <img src="${CUSTOM_ICON_URL}" alt="Author Icon" class="w-full h-full object-cover p-1">
                        </div>
                        <div>
                            <p class="font-bold text-sm md:text-base text-gray-800">${t('author_name')} ${adminEditButton}</p>
                            <p class="text-xs text-gray-500"></p>
                        </div>
                    </div>

                    ${data.thumbnail ? `<img src="${data.thumbnail}" alt="${data.title}" class="w-full max-h-[400px] md:max-h-[500px] object-cover bg-gray-100 mb-6 shadow-xl">` : ''}
                    
                    ${videoId ? `<div class="aspect-video my-6 md:my-8 mx-auto w-full max-w-4xl"><iframe class="w-full h-full rounded-lg md:rounded-xl shadow-xl md:shadow-2xl" src="https://www.youtube.com/embed/${videoId}" allowfullscreen></iframe></div>` : ''}
                    
                    <div class="px-4 md:px-12 prose prose-xl prose-red max-w-none text-gray-800 article-content">${data.body}</div>

                    ${shareAndReactionSection}
                    </article>`;
            } catch (e) { root.innerHTML = `<div class="text-center text-red-500">${t('error_loading_article')} ${e.message}</div>`; }
        };

        const renderAdminLogin = () => {
            if (currentUser && isAdmin) { window.location.hash = '#admin'; return; }
            if (currentUser && !isAdmin) { window.location.hash = '#home'; return; }

            root.innerHTML = `
                <div class="flex flex-col items-center justify-center py-6 md:py-10 px-4">
                    <div class="bg-white p-6 md:p-10 rounded-xl shadow-2xl w-full max-w-md border-t-8 border-red-600">
                        <h2 class="text-2xl md:text-3xl font-bold text-center mb-6 md:mb-8 text-gray-800">${t('admin_login_title')}</h2>
                        <form id="emailLoginForm" class="space-y-4 md:space-y-6">
                            <input type="email" id="login-email" class="w-full border p-3 md:p-4 rounded-lg text-base focus:ring-4 ring-red-500 outline-none transition shadow-inner" placeholder="${t('email')}" required>
                            <input type="password" id="login-password" class="w-full border p-3 md:p-4 rounded-lg text-base focus:ring-4 ring-red-500 outline-none transition shadow-inner" placeholder="${t('password')}" required>
                            <button type="submit" class="w-full bg-red-600 text-white py-3 md:py-4 font-extrabold hover:bg-red-700 rounded-lg transition shadow-md text-base">${t('login')}</button>
                        </form>
                        <div class="text-center mt-4 md:mt-6">
                            <a href="#home" class="text-sm text-gray-500 hover:text-red-600 font-medium"><i class="fas fa-arrow-left mr-1"></i> ${t('back_to_home')}</a>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('emailLoginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const btn = e.target.querySelector('button');
                const originalText = btn.innerText;
                
                if (!ADMIN_EMAILS.includes(email)) {
                    alert("Authorization denied. Only specific admin emails are allowed.");
                    return;
                }

                btn.innerText = t('processing');
                btn.disabled = true;
                try {
                    await loginWithEmailPassword(email, password);
                } catch(err) {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            });
        };

        const renderCategoryManagement = async () => {
             if (!isAuthReady) { renderLoading(); return; }
             if (!isAdmin) { window.location.hash = '#admin-login'; return; }

            renderLoading();
            const categoriesObjects = await loadCategories();
            const currentCategoryNames = categoriesObjects.map(c => c.name);

            root.innerHTML = `
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl border-t-8 border-red-600">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <h2 class="text-2xl md:text-3xl font-bold text-gray-800">${t('category_management')}</h2>
                        <span class="text-xs bg-green-100 text-green-800 px-3 py-1 rounded-full font-bold">${t('verified_admin')}</span>
                    </div>
                    <a href="#admin" class="text-sm text-blue-600 hover:text-blue-800 font-bold mb-6 block"><i class="fas fa-arrow-left mr-2"></i>${t('go_back_to_dashboard')}</a>

                    <div class="border border-red-200 p-4 md:p-5 rounded-lg mb-8 bg-red-50">
                        <h3 class="text-xl font-bold mb-3 text-red-700">${t('add_new_category')}</h3>
                        <div class="flex flex-col md:flex-row gap-3 md:gap-2">
                            <input type="text" id="newCategory" class="border p-3 rounded-lg focus:ring-2 ring-red-500 outline-none w-full" placeholder="${t('new_category_name')}" required>
                            <button id="addCategoryBtn" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition text-sm font-bold shadow-md md:w-auto">${t('add')}</button>
                        </div>
                    </div>
                    <ul id="categoryList" class="divide-y divide-gray-200 border border-gray-200 rounded-lg shadow-inner"></ul>
                </div>`;
            
            const categoryList = document.getElementById('categoryList');
            categoriesObjects.forEach(cat => {
                const isEditable = !cat.isDefault;
                const buttons = isEditable ? `
                    <button data-id="${cat.id}" data-name="${cat.name}" class="edit-cat text-[10px] md:text-xs bg-blue-100 text-blue-700 px-2 md:px-3 py-1 rounded-full font-bold">Edit</button>
                    <button data-id="${cat.id}" class="del-cat text-[10px] md:text-xs bg-red-100 text-red-700 px-2 md:px-3 py-1 rounded-full ml-2 font-bold">Delete</button>` 
                    : `<span class="text-xs text-gray-400 font-semibold">${t('default_category')}</span>`;

                categoryList.innerHTML += `<li class="flex justify-between items-center p-4 hover:bg-gray-50 transition"><span class="font-medium text-gray-900">${cat.name}</span><div>${buttons}</div></li>`;
            });

            document.getElementById('addCategoryBtn').addEventListener('click', async () => {
                const name = document.getElementById('newCategory').value.trim();
                if(!name || currentCategoryNames.includes(name)) return alert("Invalid or duplicate name.");
                try {
                    await addDoc(collection(db, "categories"), { name, createdAt: serverTimestamp(), addedBy: currentUser.email });
                    renderCategoryManagement(); 
                } catch(e) { alert(e.message); }
            });

            document.querySelectorAll('.edit-cat').forEach(b => b.addEventListener('click', async (e) => {
                const id = e.target.getAttribute('data-id');
                const oldName = e.target.getAttribute('data-name');
                const newName = prompt("New Name:", oldName);
                if(newName && newName.trim() !== oldName) {
                    await updateDoc(doc(db, "categories", id), { name: newName.trim() });
                    renderCategoryManagement();
                }
            }));

            document.querySelectorAll('.del-cat').forEach(b => b.addEventListener('click', async (e) => {
                if(confirm("Delete this category?")) {
                    await deleteDoc(doc(db, "categories", e.target.getAttribute('data-id')));
                    renderCategoryManagement();
                }
            }));
        };

        const renderAdmin = async () => {
            if (!isAuthReady) {
                renderLoading();
                return;
            }

            if (!currentUser || !isAdmin) {
                if (currentUser) {
                     root.innerHTML = `<div class="flex flex-col items-center justify-center py-20 bg-red-50 rounded-xl border border-red-200 shadow-md"><i class="fas fa-ban text-4xl text-red-500 mb-4"></i><h2 class="text-xl font-bold text-red-700 mb-2">${t('admin_access_denied_title')}</h2><p class="text-gray-600 text-center max-w-md">${t('admin_access_denied_body')} <b>(${currentUser.email})</b></p></div>`;
                } else {
                    renderAdminLogin();
                }
                return;
            }

            renderLoading();
            const categoriesObjects = await loadCategories();
            const categories = categoriesObjects.map(cat => cat.name);
            const mode = articleToEdit ? 'edit' : 'new';

            root.innerHTML = `
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl border-t-8 border-red-600">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b pb-4">
                        <h2 class="text-2xl md:text-3xl font-bold text-gray-800">${mode === 'new' ? t('new_post') : t('edit_post')}</h2>
                        <span class="text-xs mt-2 md:mt-0 bg-green-100 text-green-800 px-3 py-1 rounded-full font-bold">${t('verified_admin')}: ${currentUser.email}</span>
                    </div>
                    
                    <div class="flex flex-wrap gap-3 mb-8">
                        <a href="#admin/categories" class="text-sm bg-gray-200 text-gray-800 py-2 px-4 rounded-full hover:bg-gray-300 transition font-bold"><i class="fas fa-tags mr-2"></i>${t('manage_categories')}</a>
                        ${mode === 'edit' ? `<a href="#admin" class="text-sm bg-red-100 text-red-700 py-2 px-4 rounded-full hover:bg-red-200 transition font-bold"><i class="fas fa-plus mr-2"></i>${t('create_new_post')}</a>` : ''}
                    </div>
                    
                    <form id="postForm" class="space-y-4 md:space-y-5">
                        <input type="hidden" id="articleId" value="${articleToEdit ? articleToEdit.id : ''}">
                        <input type="text" id="title" class="w-full border p-3 md:p-4 rounded-lg text-base focus:ring-4 ring-red-500 outline-none transition shadow-inner" placeholder="${t('article_title')}" value="${articleToEdit ? articleToEdit.title : ''}" required>
                        <select id="category" class="w-full border p-3 md:p-4 rounded-lg bg-white text-base focus:ring-4 ring-red-500 outline-none transition shadow-inner"></select>
                        <input type="url" id="thumb" class="w-full border p-3 md:p-4 rounded-lg text-base focus:ring-4 ring-red-500 outline-none transition shadow-inner" placeholder="${t('thumbnail_link')}" value="${articleToEdit ? articleToEdit.thumbnail : ''}">
                        <input type="url" id="youtubeLink" class="w-full border p-3 md:p-4 rounded-lg text-base focus:ring-4 ring-red-500 outline-none transition shadow-inner" placeholder="${t('youtube_link')}" value="${articleToEdit ? articleToEdit.youtubeLink : ''}">
                        <textarea id="excerpt" rows="3" class="w-full border p-3 md:p-4 rounded-lg text-base focus:ring-4 ring-red-500 outline-none transition shadow-inner" placeholder="${t('excerpt')}">${articleToEdit ? articleToEdit.excerpt : ''}</textarea>
                        <textarea id="body" rows="15" class="w-full border p-3 md:p-4 rounded-lg text-base focus:ring-4 ring-red-500 outline-none transition shadow-inner" placeholder="${t('body_content')}" required>${articleToEdit ? articleToEdit.body : ''}</textarea>
                        
                        <div class="flex flex-col md:flex-row gap-4 pt-2">
                            <button type="submit" id="submitBtn" class="flex-grow bg-red-600 text-white py-3 md:py-4 font-extrabold hover:bg-red-700 rounded-lg transition shadow-xl text-base">${mode === 'new' ? t('publish_post') : t('update_post')}</button>
                            ${mode === 'edit' ? `<button type="button" id="deleteBtn" class="w-full md:w-1/4 bg-gray-500 text-white py-3 md:py-4 font-extrabold hover:bg-gray-600 rounded-lg transition shadow-xl text-base">${t('delete_post')}</button>` : ''}
                        </div>
                    </form>
                </div>
                <h3 class="text-xl md:text-2xl font-bold mt-10 md:mt-12 mb-4 text-gray-800">${t('recent_posts')}</h3>
                <div id="admin-article-list" class="bg-white shadow-xl rounded-xl overflow-hidden border border-gray-100"></div>`;

            const catSelect = document.getElementById('category');
            categories.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat; opt.textContent = cat;
                if((articleToEdit && articleToEdit.category === cat) || (!articleToEdit && cat === defaultCategories[0])) opt.selected = true;
                catSelect.appendChild(opt);
            });

            const listDiv = document.getElementById('admin-article-list');
            const q = query(collection(db, "articles"), orderBy("createdAt", "desc"), limit(10));
            getDocs(q).then(snap => {
                if(snap.empty) { listDiv.innerHTML = `<div class="p-4 text-gray-500">${t('no_published_articles')}</div>`; return; }
                let html = '<ul class="divide-y divide-gray-100">';
                snap.forEach(doc => {
                    const d = doc.data();
                    const date = d.createdAt?.toDate().toLocaleDateString('en-US') || '-';
                    html += `<li class="flex justify-between items-center p-4 hover:bg-gray-50 transition"><div class="flex-grow"><p class="font-medium text-gray-900 line-clamp-1 text-sm">${d.title}</p><span class="text-xs text-red-600 font-bold">${d.category}</span><span class="text-xs text-gray-500 ml-2">| ${date}</span></div><button onclick="window.location.hash='#admin/edit/${doc.id}'" class="text-[10px] md:text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full ml-4 font-bold">${t('edit')}</button></li>`;
                });
                listDiv.innerHTML = html + '</ul>';
            });

            document.getElementById('postForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('articleId').value;
                const btn = document.getElementById('submitBtn');
                btn.innerText = t('processing'); btn.disabled = true;

                const data = {
                    title: document.getElementById('title').value,
                    category: document.getElementById('category').value,
                    thumbnail: document.getElementById('thumb').value.trim(),
                    youtubeLink: document.getElementById('youtubeLink').value,
                    excerpt: document.getElementById('excerpt').value,
                    body: document.getElementById('body').value,
                    authorEmail: currentUser.email
                };

                try {
                    if(id) {
                        data.updatedAt = serverTimestamp();
                        await updateDoc(doc(db, "articles", id), data);
                        alert(t('update_success'));
                    } else {
                        data.createdAt = serverTimestamp();
                        await addDoc(collection(db, "articles"), data);
                        alert(t('publish_success'));
                    }
                    window.location.hash = "#admin";
                } catch(err) { alert(err.message); btn.disabled = false; }
            });
            
            if(document.getElementById('deleteBtn')) {
                document.getElementById('deleteBtn').addEventListener('click', async () => {
                    if(confirm("Permanently delete?")) {
                        await deleteDoc(doc(db, "articles", document.getElementById('articleId').value));
                        window.location.hash = "#admin";
                    }
                });
            }
        };

        // --- ROUTING ---
        const router = async () => {
            const hash = window.location.hash;
            const parts = hash.split('/');

            if(!(parts[0] === '#admin' && parts[1] === 'edit')) {
                articleToEdit = null;
            }

            if(!hash || hash === '#home') renderHome();
            else if(parts[0] === '#article' && parts[1]) renderArticle(parts[1]);
            else if(parts[0] === '#category' && parts[1]) renderHome(decodeURIComponent(parts[1]));
            else if(hash === '#admin-login') renderAdminLogin();
            else if(hash === '#admin') renderAdmin();
            else if(hash === '#admin/categories') renderCategoryManagement();
            else if(parts[0] === '#admin' && parts[1] === 'edit' && parts[2]) {
                if(!isAuthReady) { renderLoading(); return; } 
                if(!isAdmin) { window.location.hash = '#admin-login'; return; }
                
                if(!articleToEdit || articleToEdit.id !== parts[2]) {
                    renderLoading();
                    const docSnap = await getDoc(doc(db, "articles", parts[2]));
                    if (docSnap.exists()) {
                        articleToEdit = { id: docSnap.id, ...docSnap.data() };
                        renderAdmin();
                    } else {
                        alert(t('article_not_found_alert'));
                        window.location.hash = '#admin';
                    }
                } else {
                    renderAdmin();
                }
            }
        };

        // --- INITIALIZATION ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            isAdmin = user && ADMIN_EMAILS.includes(user.email);
            isAuthReady = true; 
            initUI();
            router();
        });

        window.addEventListener('hashchange', router);
    </script>
</html>