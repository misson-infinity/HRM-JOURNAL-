<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinity Stream | News Portal</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&family=Noto+Serif+Bengali:wght@400;500;600;700&family=Playfair+Display:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script type="importmap">
        {
            "imports": {
                "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
                "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
                "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"
            }
        }
    </script>

    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #ffffff; color: #1a1a1a; }
        .font-brand { font-family: 'Playfair Display', serif; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #333; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* For article content HTML */
        .article-content img { max-width: 100%; height: auto; display: block; margin: 1rem auto; border-radius: 0.5rem; }
        
        /* Ensure article content uses a standard English-friendly font */
        .article-content { font-family: 'Roboto', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

    <header class="bg-white sticky top-0 z-40 border-b border-gray-100 shadow-sm h-16 flex items-center">
        <div class="container mx-auto px-4 flex justify-between items-center relative">
            <a href="#home" class="flex items-center gap-1 group">
                <div class="relative">
                    <span class="font-brand text-3xl font-bold tracking-tight text-black">Infinity Stream</span>
                    <i class="fas fa-search absolute top-1 left-1 text-[10px] text-white"></i>
                </div>
                <sup class="text-[10px] uppercase font-bold text-gray-500 mt-1 ml-1 border px-1 border-gray-300">News Portal</sup>
            </a>

            <div class="flex items-center gap-4">
                <div id="auth-status" class="hidden md:block text-xs font-bold text-gray-500"></div>
                <div class="hidden md:flex items-center text-sm font-medium border border-gray-300 rounded overflow-hidden">
                    <button class="px-3 py-1 bg-gray-700 text-white">Eng</button>
                    <button class="px-3 py-1 bg-gray-100 text-gray-500">বাংলা</button>
                </div>
                <button onclick="toggleMenu()" class="text-3xl text-gray-800 hover:text-gray-600 focus:outline-none">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </header>

    <div id="side-menu-overlay" class="fixed inset-0 bg-black/50 z-50 hidden transition-opacity duration-300 opacity-0" onclick="toggleMenu()"></div>
    <div id="side-menu" class="fixed top-0 right-0 h-full w-[85%] max-w-sm bg-gray-50 z-50 transform translate-x-full transition-transform duration-300 shadow-2xl flex flex-col">
        <div class="flex justify-between items-center p-5 border-b bg-white">
            <h2 class="font-brand text-2xl font-bold">Infinity Stream</h2>
            <button onclick="toggleMenu()" class="text-2xl text-gray-500 hover:text-red-500"><i class="fas fa-times"></i></button>
        </div>
        <div class="flex-grow overflow-y-auto custom-scroll p-6">
            <ul id="menu-categories" class="space-y-6 text-xl font-medium text-gray-800">
                <li><a href="#home" onclick="toggleMenu()" class="hover:text-red-600 block">Home</a></li>
                </ul>
        </div>
        <div class="p-6 bg-white border-t">
            <div id="logged-out-section" class="space-y-3">
                <button id="login-google-btn" class="w-full border border-gray-300 py-2 rounded text-sm font-bold bg-white hover:bg-gray-50 flex items-center justify-center gap-2">
                    <i class="fab fa-google"></i> Google Login
                </button>
                <button id="login-email-btn" class="w-full bg-black text-white py-2 rounded text-sm font-bold hover:bg-gray-800">
                    Admin Login (Email/Pass)
                </button>
            </div>
            <button id="logout-btn" class="w-full border border-gray-300 py-2 rounded text-sm font-bold mb-4 hidden bg-red-50 text-red-600 hover:bg-red-100">Logout</button>
            <div class="flex gap-4 text-2xl text-gray-800 justify-center">
                <i class="fab fa-facebook-square"></i><i class="fa-brands fa-x-twitter"></i><i class="fab fa-youtube"></i>
            </div>
        </div>
    </div>

    <main id="app-root" class="flex-grow container mx-auto px-0 md:px-4 py-6 max-w-4xl min-h-[60vh]">
        <div class="flex justify-center items-center h-64"><div class="loader"></div></div>
    </main>

    <footer class="bg-white border-t mt-12 py-8">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-500 text-sm">© Infinity Stream</p>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "firebase/app";
        import { getFirestore, collection, getDocs, getDoc, addDoc, doc, query, orderBy, limit, serverTimestamp, updateDoc, deleteDoc } from "firebase/firestore";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInWithEmailAndPassword } from "firebase/auth";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBlVYaMOrpj2JbE59eeRoO8TdKGwBFTQJM",
            authDomain: "infinity-stream-13726.firebaseapp.com",
            projectId: "infinity-stream-13726",
            storageBucket: "infinity-stream-13726.firebasestorage.app",
            messagingSenderId: "708884808002",
            appId: "1:708884808002:web:434d7c704fc78d7d42c8db",
            measurementId: "G-1G049G8NBD"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // ADMIN LIST (STRICT) - KEEP AS IS
        const ADMIN_EMAILS = [
            "habiburrahmanmahi4@gmail.com",
            "habiburrahmannawshad@gmail.com",
            "ahnafmahi19@gmail.com"
        ];

        let currentUser = null;
        let isAdmin = false;
        let articleToEdit = null; 
        
        // Default Categories (English)
        const defaultCategories = ["Current Affairs", "Sports", "Fact Check", "Opinion"];

        // --- Category Management Functions ---
        const loadCategories = async () => {
            let categories = [...defaultCategories];
            let categoryObjects = [];

            // Add default categories first (non-deletable)
            defaultCategories.forEach(name => {
                categoryObjects.push({ id: null, name: name });
            });

            try {
                const querySnapshot = await getDocs(collection(db, "categories"));
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const categoryObject = { id: doc.id, name: data.name };
                    
                    // Only push if the name doesn't exist in defaults
                    if(data.name && !categories.includes(data.name)) {
                        categories.push(data.name); // Keep names list for dropdown population
                        categoryObjects.push(categoryObject); // Use objects for management list
                    }
                });
            } catch (e) {
                console.error("Error loading categories:", e);
            }
            return categoryObjects; // Return objects for full management features
        };
        
        const renderCategoriesMenu = async (categoriesObjects) => {
            const menuList = document.getElementById('menu-categories');
            if(!menuList) return;

            // Clear previous items except for 'Home'
            menuList.innerHTML = '<li><a href="#home" onclick="toggleMenu()" class="hover:text-red-600 block">Home</a></li>';
            
            // Add fetched and default categories
            categoriesObjects.forEach(category => {
                const name = category.name;
                const item = document.createElement('li');
                item.innerHTML = `<a href="#category/${encodeURIComponent(name)}" onclick="toggleMenu()" class="hover:text-red-600 block">${name}</a>`;
                menuList.appendChild(item);
            });

            // Add Admin link at the end if necessary
            if(isAdmin) {
                const adminItem = document.createElement('li');
                adminItem.id = 'admin-menu-link';
                adminItem.innerHTML = `<a href="#admin" onclick="toggleMenu()" class="text-red-600 font-bold block border-l-4 border-red-600 pl-2">Admin Dashboard</a>`;
                menuList.appendChild(adminItem);
            }
        };

        // Auth Listener
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            isAdmin = user && ADMIN_EMAILS.includes(user.email);
            updateAuthUI();
            
            // Load categories and then render the menu
            loadCategories().then(renderCategoriesMenu);
            // Re-render admin if the hash is active and admin status changes
            if(window.location.hash === '#admin' || window.location.hash.startsWith('#admin/edit/')) router();
        });

        // UI Updates based on Auth
        const updateAuthUI = () => {
            const logoutBtn = document.getElementById('logout-btn');
            const loggedOutSection = document.getElementById('logged-out-section');
            const status = document.getElementById('auth-status');

            if (currentUser) {
                loggedOutSection.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                logoutBtn.onclick = () => signOut(auth);
                
                status.textContent = isAdmin ? "ADMIN MODE" : "READER MODE";
                status.className = isAdmin ? "hidden md:block text-xs font-bold text-red-600 border border-red-200 px-2 py-1 rounded bg-red-50" : "hidden md:block text-xs font-bold text-gray-500";
            } else {
                loggedOutSection.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                status.textContent = "";
                
                // Attach event listeners for login buttons
                document.getElementById('login-google-btn').onclick = loginWithGoogle;
                document.getElementById('login-email-btn').onclick = () => {
                    toggleMenu();
                    window.location.hash = '#admin-login';
                };
            }
        };

        const loginWithGoogle = async () => {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                toggleMenu();
            } catch (error) {
                alert("Google Login Error: " + error.message);
            }
        };

        const loginWithEmailPassword = async (email, password) => {
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                
                // Only allow admin login for specific email
                if (ADMIN_EMAILS.includes(userCredential.user.email)) {
                    alert("Admin Login Successful!");
                    window.location.hash = '#admin';
                } else {
                    // Sign out non-admin users immediately after successful login
                    await signOut(auth); 
                    alert("Login Successful, but you are not authorized as an Admin.");
                    window.location.hash = '#home';
                }
            } catch (error) {
                alert("Login Failed: " + error.message);
            }
        };

        // Utility to extract YouTube ID
        const getYouTubeId = (url) => {
            const regex = /(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const match = url.match(regex);
            return (match && match[1]) ? match[1] : null;
        };


        // --- Renderers ---
        const root = document.getElementById('app-root');
        const renderLoading = () => root.innerHTML = `<div class="flex justify-center items-center h-64"><div class="loader border-gray-400"></div></div>`;

        const renderHome = async (categoryFilter = null) => {
            renderLoading();
            try {
                const articlesRef = collection(db, "articles");
                let q;
                const filterTitle = categoryFilter ? categoryFilter : 'Latest News';

                if (categoryFilter && categoryFilter !== 'Home') {
                    // Fetch all docs and filter on the client if Firestore doesn't support the specific query, 
                    // or better: filter by category if we were using a different index/setup.
                    // For now, let's stick to the original logic which fetches all (or 15 for home) and client filters.
                    q = query(articlesRef, orderBy("createdAt", "desc")); 
                } else {
                    q = query(articlesRef, orderBy("createdAt", "desc"), limit(15));
                }
                
                const querySnapshot = await getDocs(q);
                
                let filteredDocs = [];
                querySnapshot.forEach(doc => {
                    if (!categoryFilter || doc.data().category === categoryFilter) {
                        filteredDocs.push({ id: doc.id, ...doc.data() });
                    }
                });

                if (filteredDocs.length === 0) return root.innerHTML = `<div class="text-center py-20 text-gray-500">No articles found in this category.</div>`;

                let html = `<h1 class="text-2xl font-bold text-gray-800 mb-6 px-4 md:px-0">${filterTitle}</h1><div class="space-y-6">`;
                
                filteredDocs.forEach((data) => {
                    // Helper to format date in a standard English format (e.g., Nov 10, 2025)
                    const dateString = data.createdAt?.toDate().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) || 'Unknown Date';

                    html += `
                    <div class="bg-white md:rounded-lg overflow-hidden shadow-sm hover:shadow-md transition mb-6 border-b md:border border-gray-100 group cursor-pointer" onclick="window.location.hash='#article/${data.id}'">
                        <div class="relative h-64 overflow-hidden">
                            <img src="${data.thumbnail || 'https://via.placeholder.com/800x450'}" alt="${data.title}" class="w-full h-full object-cover group-hover:scale-105 transition duration-700">
                            <div class="absolute top-4 left-4"><span class="bg-red-700 text-white text-xs font-bold px-3 py-1 rounded uppercase">${data.category}</span></div>
                        </div>
                        <div class="p-5 md:p-6">
                            <h2 class="text-2xl font-bold text-gray-900 mb-3 group-hover:text-red-700">${data.title}</h2>
                            <p class="text-gray-600 line-clamp-2 mb-2 text-lg">${data.excerpt || ''}</p>
                            <div class="text-sm text-gray-400">${dateString}</div>
                        </div>
                    </div>`;
                });
                html += '</div>';
                root.innerHTML = html;
            } catch (e) { root.innerHTML = `<div class="text-center text-red-500">Error loading articles: ${e.message}</div>`; }
        };

        const renderArticle = async (id) => {
            renderLoading();
            try {
                const docSnap = await getDoc(doc(db, "articles", id));
                if (!docSnap.exists()) return root.innerHTML = '<div class="text-center py-20">Article not found.</div>';
                
                const data = docSnap.data();
                
                // Embed YouTube video if link exists
                let videoEmbed = '';
                const videoId = getYouTubeId(data.youtubeLink || '');
                if (videoId) {
                    videoEmbed = `<div class="aspect-video my-6">
                        <iframe class="w-full h-full" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>`;
                }
                
                const dateString = data.createdAt?.toDate().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) || 'Unknown Date';

                // Admin Edit button: Always visible to Admin on the article page
                const adminEditButton = isAdmin ? `<button onclick="window.location.hash='#admin/edit/${id}'" class="text-sm bg-blue-600 text-white px-4 py-1 rounded hover:bg-blue-700 ml-4">Edit Article</button>` : '';

                
                root.innerHTML = `
                <article class="bg-white md:rounded-lg shadow-sm overflow-hidden pb-10">
                    <div class="px-4 md:px-8 pt-8 pb-4">
                        <span class="text-red-600 font-bold border-b-2 border-red-600">${data.category}</span>
                        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mt-4 leading-tight">${data.title}</h1>
                    </div>
                    <img src="${data.thumbnail}" alt="${data.title} Thumbnail" class="w-full max-h-[500px] object-contain bg-gray-100 mb-6">
                    <div class="px-4 md:px-8 flex items-center gap-4 mb-6 border-b pb-6">
                        <div class="w-10 h-10 rounded-full bg-black text-white flex items-center justify-center font-brand font-bold">D</div>
                        <div>
                            <p class="font-bold">The Decent Desk ${adminEditButton}</p>
                            <p class="text-xs text-gray-500">${dateString}</p>
                        </div>
                    </div>
                    ${videoEmbed}
                    <div class="px-4 md:px-8 prose prose-lg prose-red max-w-none text-gray-800 text-justify article-content">${data.body}</div>
                </article>`;
            } catch (e) { root.innerHTML = `<div class="text-center text-red-500">Error loading article: ${e.message}</div>`; }
        };

        const renderAdminLogin = () => {
             // Already logged in
            if (currentUser) {
                window.location.hash = isAdmin ? '#admin' : '#home';
                return;
            }

            root.innerHTML = `
                <div class="flex flex-col items-center justify-center py-10 px-4">
                    <div class="bg-white p-6 md:p-8 rounded shadow-lg w-full max-w-sm border-t-4 border-black">
                        <h2 class="text-2xl font-bold text-center mb-6">Admin Login</h2>
                        <form id="emailLoginForm" class="space-y-4">
                            <input type="email" id="login-email" class="w-full border p-3 rounded focus:ring-2 ring-red-500 outline-none" placeholder="Email" required>
                            <input type="password" id="login-password" class="w-full border p-3 rounded focus:ring-2 ring-red-500 outline-none" placeholder="Password" required>
                            <button type="submit" class="w-full bg-red-600 text-white py-3 font-bold hover:bg-red-700 rounded transition">Login</button>
                        </form>
                        <div class="text-center mt-4">
                            <a href="#home" class="text-sm text-gray-500 hover:text-black">Return to Home</a>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('emailLoginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                const btn = e.target.querySelector('button');
                btn.innerText = "Processing...";
                btn.disabled = true;

                // Enforce login only for admin emails, as per the original logic
                if (ADMIN_EMAILS.includes(email)) {
                    await loginWithEmailPassword(email, password);
                } else {
                    alert("Authorization denied. Only specific admin emails are allowed to log in here.");
                }

                btn.innerText = "Login";
                btn.disabled = false;
            });
        };
        
        // --- Category Management Dashboard ---
        const renderCategoryManagement = async (categoriesObjects) => {
            renderLoading(); 
            
            // Get category names only for duplicate check
            const currentCategoryNames = categoriesObjects.map(c => c.name);

            root.innerHTML = `
                <div class="bg-white p-6 rounded shadow-lg border-t-4 border-red-600">
                    <div class="flex justify-between items-center mb-6 border-b pb-2">
                        <h2 class="text-2xl font-bold">Category Management</h2>
                        <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">Verified Admin</span>
                    </div>
                    
                    <a href="#admin" class="text-sm text-blue-600 hover:text-blue-800 font-bold mb-4 block"><i class="fas fa-arrow-left mr-2"></i>Back to Post Dashboard</a>

                    <div class="border p-4 rounded mb-8 bg-gray-50">
                        <h3 class="text-xl font-bold mb-3">Create New Category</h3>
                        <div class="flex gap-2">
                            <input type="text" id="newCategory" class="border p-2 rounded focus:ring-2 ring-red-500 outline-none w-full" placeholder="New Category Name" required>
                            <button id="addCategoryBtn" class="bg-red-600 text-white py-2 px-4 rounded hover:bg-red-700 transition text-sm font-bold">Add</button>
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-bold mb-3">Edit/Delete Existing Categories</h3>
                    <ul id="categoryList" class="divide-y divide-gray-100 border rounded">
                        </ul>
                </div>
            `;
            
            const categoryList = document.getElementById('categoryList');
            
            if (categoriesObjects.length === 0) {
                categoryList.innerHTML = '<li class="p-4 text-gray-500">No categories found.</li>';
            } else {
                categoriesObjects.forEach(cat => {
                    const isEditable = cat.id !== null; 

                    let actionButtons = '';
                    if (isEditable) {
                        actionButtons = `
                            <button data-id="${cat.id}" data-name="${cat.name}" class="edit-category text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200 transition">Edit</button>
                            <button data-id="${cat.id}" class="delete-category text-xs bg-red-100 text-red-700 px-3 py-1 rounded hover:bg-red-200 transition ml-2">Delete</button>
                        `;
                    } else {
                        actionButtons = '<span class="text-xs text-gray-400">Default (Cannot Delete)</span>';
                    }

                    categoryList.innerHTML += `
                        <li id="cat-item-${cat.id || cat.name}" class="flex justify-between items-center p-4 hover:bg-gray-50 transition">
                            <span class="font-medium text-gray-900">${cat.name}</span>
                            <div>${actionButtons}</div>
                        </li>
                    `;
                });
            }
            
            // --- Event Handlers for Category Management ---
            
            // 1. Add New Category
            document.getElementById('addCategoryBtn').addEventListener('click', async () => {
                const newCatInput = document.getElementById('newCategory');
                const newCatName = newCatInput.value.trim();
                
                if (!newCatName) {
                    alert("Please enter a category name.");
                    return;
                }
                if (currentCategoryNames.includes(newCatName)) {
                    alert("This category already exists.");
                    return;
                }

                const btn = document.getElementById('addCategoryBtn');
                btn.innerText = "Adding...";
                btn.disabled = true;

                try {
                    await addDoc(collection(db, "categories"), {
                        name: newCatName,
                        createdAt: serverTimestamp(),
                        addedBy: currentUser.email
                    });
                    alert(`Category "${newCatName}" successfully added!`);
                    window.location.reload(); 
                } catch (e) {
                    alert("Failed to add category: " + e.message);
                } finally {
                    btn.innerText = "Add";
                    btn.disabled = false;
                }
            });

            // 2. Edit Category
            categoryList.querySelectorAll('.edit-category').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.target.getAttribute('data-id');
                    const oldName = e.target.getAttribute('data-name');
                    const newName = prompt(`Enter a new name for category "${oldName}":`, oldName);
                    
                    if (newName && newName !== oldName) {
                         if (currentCategoryNames.includes(newName)) {
                            alert("A category with this name already exists.");
                            return;
                        }
                        if(!confirm(`Are you sure you want to change the category name to "${newName}"?`)) return;

                        try {
                            await updateDoc(doc(db, "categories", id), { name: newName });
                            alert("Category successfully updated!");
                            window.location.reload(); 
                        } catch (e) {
                            alert("Failed to update: " + e.message);
                        }
                    } else if (newName !== null) {
                        alert("Name was not changed or the same name was provided.");
                    }
                });
            });

            // 3. Delete Category
            categoryList.querySelectorAll('.delete-category').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.target.getAttribute('data-id');
                    
                    if (confirm("Are you sure you want to delete this category? All posts currently using this category will remain unchanged until manually edited.")) {
                        try {
                            await deleteDoc(doc(db, "categories", id));
                            alert("Category successfully deleted.");
                            // Reload to update the menu and list
                            window.location.reload();
                        } catch (e) {
                            alert("Failed to delete: " + e.message);
                        }
                    }
                });
            });
        };


        const renderAdmin = async () => {
            // Check if articleToEdit is loaded from router before proceeding
            const isEditMode = articleToEdit !== null;

            // 1. Authentication Check
            if (!currentUser) {
                renderAdminLogin();
                return;
            }
            if (!isAdmin) {
                root.innerHTML = `<div class="flex flex-col items-center justify-center py-20 bg-red-50 rounded border border-red-100"><i class="fas fa-ban text-4xl text-red-500 mb-4"></i><h2 class="text-xl font-bold text-red-700 mb-2">Access Denied</h2><p class="text-gray-600 text-center max-w-md">Sorry <b>${currentUser.email}</b>, you do not have permission to access this page.</p></div>`;
                return;
            }

            renderLoading();
            // Load categories names for the form dropdown
            const categoriesObjects = await loadCategories();
            const categories = categoriesObjects.map(cat => cat.name);
            
            // Function to render the main dashboard UI
            const renderDashboardUI = (mode = 'new') => {
                root.innerHTML = `
                    <div class="bg-white p-6 rounded shadow-lg border-t-4 border-red-600">
                        <div class="flex justify-between items-center mb-6 border-b pb-2">
                            <h2 class="text-2xl font-bold">${mode === 'new' ? 'Create New Post' : 'Edit Post'}</h2>
                            <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">Verified Admin: ${currentUser.email}</span>
                        </div>
                        
                        <div class="space-y-4 mb-6">
                            <a href="#admin/categories" class="text-sm bg-gray-200 text-gray-800 py-2 px-4 rounded hover:bg-gray-300 transition font-bold"><i class="fas fa-tags mr-2"></i>Manage Categories</a>
                            ${mode === 'edit' ? `<a href="#admin" class="text-sm bg-gray-200 text-gray-800 py-2 px-4 rounded hover:bg-gray-300 transition font-bold ml-2"><i class="fas fa-plus mr-2"></i>Create New Post</a>` : ''}
                        </div>
                        
                        <form id="postForm" class="space-y-4">
                            <input type="hidden" id="articleId" value="${articleToEdit ? articleToEdit.id : ''}">
                            <input type="text" id="title" class="w-full border p-3 rounded focus:ring-2 ring-red-500 outline-none" placeholder="News Headline" value="${articleToEdit ? articleToEdit.title : ''}" required>
                            
                            <select id="category" class="w-full border p-3 rounded bg-white">
                                </select>

                            <input type="text" id="thumb" class="w-full border p-3 rounded" placeholder="Thumbnail Image Link (URL)" value="${articleToEdit ? articleToEdit.thumbnail : ''}" required>
                            <input type="url" id="youtubeLink" class="w-full border p-3 rounded" placeholder="YouTube Video Link (Optional)" value="${articleToEdit ? articleToEdit.youtubeLink : ''}">
                            
                            <textarea id="excerpt" rows="2" class="w-full border p-3 rounded" placeholder="Short Description (Excerpt)" >${articleToEdit ? articleToEdit.excerpt : ''}</textarea>
                            
                            <textarea id="body" rows="10" class="w-full border p-3 rounded" placeholder="Detailed News Body (HTML allowed for image tags: <img src='...' />)" required>${articleToEdit ? articleToEdit.body : ''}</textarea>
                            
                            <div class="flex gap-4">
                                <button type="submit" id="submitBtn" class="flex-grow bg-red-600 text-white py-3 font-bold hover:bg-red-700 rounded transition">
                                    ${mode === 'new' ? 'Publish Post' : 'Update Post'}
                                </button>
                                ${mode === 'edit' ? `<button type="button" id="deleteBtn" class="w-1/4 bg-gray-500 text-white py-3 font-bold hover:bg-gray-600 rounded">Delete</button>` : ''}
                            </div>
                            <div class="text-center mt-4">
                                <a href="#admin" class="text-sm text-gray-500 hover:text-black">${mode === 'edit' ? 'Switch to Create New Post' : 'View All Posts'}</a>
                            </div>
                        </form>
                    </div>

                    <h3 class="text-xl font-bold mt-10 mb-4 px-4 md:px-0">Recent Posts</h3>
                    <div id="admin-article-list" class="bg-white shadow-sm rounded overflow-hidden">
                        </div>
                `;

                // Populate categories dropdown
                const categorySelect = document.getElementById('category');
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    if (articleToEdit && articleToEdit.category === cat) {
                        option.selected = true;
                    } else if (mode === 'new' && cat === defaultCategories[0]) {
                        option.selected = true; // Select 'Current Affairs' by default for new posts
                    }
                    categorySelect.appendChild(option);
                });
            };

            // Initial render as New Post or Edit Post mode
            renderDashboardUI(isEditMode ? 'edit' : 'new');

            // Load and display recent posts for admin overview
            const loadAdminPosts = async () => {
                const listContainer = document.getElementById('admin-article-list');
                listContainer.innerHTML = '<div class="p-4 text-center text-gray-500">Loading...</div>';
                try {
                    const q = query(collection(db, "articles"), orderBy("createdAt", "desc"), limit(10));
                    const querySnapshot = await getDocs(q);
                    
                    if (querySnapshot.empty) {
                        listContainer.innerHTML = '<div class="p-4 text-gray-500">No published articles found.</div>';
                        return;
                    }

                    let html = '<ul class="divide-y divide-gray-100">';
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const date = data.createdAt?.toDate().toLocaleDateString('en-US') || 'No Date';
                        html += `
                        <li class="flex justify-between items-center p-4 hover:bg-gray-50 transition">
                            <div class="flex-grow">
                                <p class="font-medium text-gray-900 line-clamp-1">${data.title}</p>
                                <span class="text-xs text-red-500 font-bold">${data.category}</span>
                                <span class="text-xs text-gray-500 ml-2"> | ${date}</span>
                            </div>
                            <button onclick="window.location.hash='#admin/edit/${doc.id}'" class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded ml-4 hover:bg-blue-200">Edit</button>
                        </li>`;
                    });
                    html += '</ul>';
                    listContainer.innerHTML = html;
                } catch (e) {
                    listContainer.innerHTML = `<div class="p-4 text-red-500">Failed to load posts: ${e.message}</div>`;
                }
            };
            loadAdminPosts();


            // --- Event Listeners for Post Management (Submit/Delete) ---
            
            // 1. Form Submit Handler (Create/Update)
            document.getElementById('postForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const id = document.getElementById('articleId').value;
                const mode = id ? 'Update' : 'Publish';
                if(!confirm(`Are you sure you want to ${mode.toLowerCase()} this post?`)) return;
                
                const btn = document.getElementById('submitBtn');
                btn.innerText = "Processing...";
                btn.disabled = true;

                const data = {
                    title: document.getElementById('title').value,
                    category: document.getElementById('category').value,
                    thumbnail: document.getElementById('thumb').value,
                    youtubeLink: document.getElementById('youtubeLink').value,
                    excerpt: document.getElementById('excerpt').value,
                    body: document.getElementById('body').value,
                    authorEmail: currentUser.email
                };

                try {
                    if (id) {
                        // Update existing article
                        data.updatedAt = serverTimestamp();
                        await updateDoc(doc(db, "articles", id), data);
                        alert("Successfully updated!");
                        // Go to the article page after update
                        window.location.hash = "#article/" + id;
                    } else {
                        // Create new article
                        data.createdAt = serverTimestamp();
                        const newDoc = await addDoc(collection(db, "articles"), data);
                        alert("Successfully published!");
                        // Go to the new article page after publish
                        window.location.hash = "#article/" + newDoc.id;
                    }
                } catch (err) {
                    alert(`Failed to ${mode.toLowerCase()}: ` + err.message);
                    btn.innerText = mode === 'Update' ? 'Update Post' : 'Publish Post';
                    btn.disabled = false;
                }
            });

            // 2. Delete Handler (Only for Edit mode)
            if (document.getElementById('deleteBtn')) {
                document.getElementById('deleteBtn').addEventListener('click', async () => {
                    const id = document.getElementById('articleId').value;
                    if (!id || !confirm("Are you sure you want to DELETE this post? This action cannot be undone.")) return;
                    
                    const btn = document.getElementById('deleteBtn');
                    btn.innerText = "Deleting...";
                    btn.disabled = true;

                    try {
                        await deleteDoc(doc(db, "articles", id));
                        alert("Post successfully deleted.");
                        window.location.hash = "#admin";
                    } catch (e) {
                        alert("Failed to delete: " + e.message);
                        btn.innerText = "Delete";
                        btn.disabled = false;
                    }
                });
            }
        };

        // --- Routing ---
        const router = async () => {
            const hash = window.location.hash;
            const parts = hash.split('/');

            // Reset edit state first
            articleToEdit = null;

            if(!hash || hash === '#home') renderHome();
            else if(parts[0] === '#article' && parts[1]) renderArticle(parts[1]);
            else if(parts[0] === '#category' && parts[1]) renderHome(decodeURIComponent(parts[1]));
            else if(hash === '#admin-login') renderAdminLogin();
            else if(hash === '#admin') renderAdmin();
            else if(hash === '#admin/categories') {
                if(!isAdmin) { window.location.hash = '#admin-login'; return; } // Auth check
                renderCategoryManagement(await loadCategories()); 
            }
            else if(parts[0] === '#admin' && parts[1] === 'edit' && parts[2]) {
                if(!isAdmin) { window.location.hash = '#admin-login'; return; } // Auth check
                renderLoading();
                try {
                    const docSnap = await getDoc(doc(db, "articles", parts[2]));
                    if (docSnap.exists()) {
                        articleToEdit = { id: docSnap.id, ...docSnap.data() };
                        renderAdmin(); // Renders in Edit mode
                    } else {
                        alert("Article not found.");
                        window.location.hash = '#admin';
                    }
                } catch (e) {
                    alert("Failed to load article: " + e.message);
                    window.location.hash = '#admin';
                }
            }
        };

        window.addEventListener('hashchange', router);
        window.addEventListener('load', router);

        // Menu Logic
        window.toggleMenu = () => {
            const menu = document.getElementById('side-menu');
            const overlay = document.getElementById('side-menu-overlay');
            if(menu.classList.contains('translate-x-full')) {
                menu.classList.remove('translate-x-full');
                overlay.classList.remove('hidden');
                setTimeout(()=>overlay.classList.remove('opacity-0'),10);
            } else {
                menu.classList.add('translate-x-full');
                overlay.classList.add('opacity-0');
                setTimeout(()=>overlay.classList.add('hidden'),300);
            }
        };
    </script>
</body>
</html>
